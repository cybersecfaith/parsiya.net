<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>Intro to .NET Remoting for Hackers</title>

  
  <link rel="stylesheet" href="http://parsiya.net/css/hugo-octopress.css">

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  

  
  <link href="http://parsiya.net/favicon.png" rel="icon">

  
  
  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="[Parsia Hakimian Parsia infosec information security]">

  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.15" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://parsiya.net/">Parsia&#39;s Den</a></h1>
    <h2>Because no one wants to be the other guy from Wham!</h2>
</hgroup></header>


<nav role="navigation">


<ul class="main-navigation">
  
  
    
      <li><a href="http://parsiya.net/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://www.google.com/search?q=andrew&#43;ridgeley" target="_blank" title="The other guy from Wham!">The other guy from Wham!</a></li>
    
  
    
      <li><a href="http://parsiya.net/archive/" target="_blank" title="Archive">Archive</a></li>
    
  
    
      <li><a href="http://parsiya.net/license/" target="_blank" title="License">License</a></li>
    
  
    
      <li><a href="https://www.github.com/parsiya/hugo-octopress" target="_blank" title="This theme on Github">This theme on Github</a></li>
    
  
</ul>


<ul class="subscription">
  <a href="http://parsiya.net/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>

  
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:http://parsiya.net/" />
  </fieldset>
</form>

</nav>



<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">
        <header>
          <h1 class="entry-title">
            Intro to .NET Remoting for Hackers 
          </h1>
          <p class="meta">Nov 14, 2015 - 23 minute read -  <a href="http://parsiya.net/blog/2015-11-14-intro-to-.net-remoting-for-hackers/#disqus_thread">Comments</a>

          

          
          
          <a class="label" href="http://parsiya.net/categories/reverse-engineering">Reverse Engineering</a>
          </p>
        </header>
        <div class="entry-content">
          

<p>This is a simple tutorial about <a href="https://msdn.microsoft.com/en-us/library/kwdt6w2k%28v=vs.71%29.aspx" target="_blank">.NET Remoting</a>. I am going to re-create a very simple RCE and local privilege escalation that I encountered in my projects and use it to explain .NET Remoting and simple debugging in <code>dnSpy</code>.</p>

<p>In this post we will:</p>

<ol>
<li>Do a brief introduction to .NET Remoting</li>
<li>Develop a simple .NET Remoting client and a vulnerable server in Visual Studio</li>
<li>Observe .NET Remoting traffic</li>
<li>See .NET Remoting in action by doing some basic debugging with dnSpy</li>
<li>Re-create the vulnerable application</li>
<li>Use dnSpy to patch and create modified .NET modules to exploit our sample vulnerable server</li>
</ol>

<p>If you know of any applications that use .NET Remoting please let me know. I want to look at them.</p>

<h3 id="table-of-contents:a4cceda545ee0d0782d3d591639b4015">Table of Contents:</h3>

<ul>
<li><a href="#ch0">0. Ingredients and Setup</a></li>
<li><a href="#ch1">1. Brief Intro to .NET Remoting</a></li>
<li><a href="#ch2">2. Developing a .NET Remoting Application</a></li>
<li><a href="#ch3">3. .NET Remoting Messages</a></li>
<li><a href="#ch4">4. Debugging with dnSpy</a></li>
<li><a href="#ch5">5. Re-creating the Vulnerability</a></li>
<li><a href="#ch6">6. Modifying IL Instructions with dnSpy and Patching Binaries</a></li>
<li><a href="#ch7">7. Remediation</a></li>
</ul>

<h3 id="a-name-ch0-a-0-ingredients-and-setup:a4cceda545ee0d0782d3d591639b4015"><a name="ch0"></a> 0. Ingredients and Setup</h3>

<ul>
<li>Windows 7 Virtual Machine</li>
<li>Visual Studio Community 2015: <a href="https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx" target="_blank">https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx</a>. We only need the C# components which are part of the default installation</li>
<li>RawCap to capture local traffic</li>
<li>Wireshark to analyze captured traffic</li>
<li><a href="https://github.com/0xd4d/dnSpy/releases/tag/v1.4.0.0" target="_blank">dnSpy (1.4.0.0)</a> to decompile and debug C# code</li>
</ul>

<h3 id="a-name-ch1-a-1-brief-intro-to-net-remoting:a4cceda545ee0d0782d3d591639b4015"><a name="ch1"></a> 1. Brief Intro to .NET Remoting</h3>

<p>In simple words, .NET Remoting is a means to achieve InterProcess Communication (IPC). One application (let&rsquo;s call it server) exposes some remotable objects. Other applications (we will call them clients) create an instance of those objects and treat them like local objects. But these local objects will be executed on the server. Usually these remotable objects are in a shared library (e.g. DLL). Both client and server will have a copy of this DLL. .NET Remoting can use TCP, HTTP or named pipes to transfer the remotable objects.</p>

<p>The concept of .NET Remoting is very similar to <a href="http://www.oracle.com/technetwork/java/javase/tech/index-jsp-138781.html" target="_blank">Java Remote Method Invocation (Java RMI)</a>. In Java RMI we will see serialized Java objects being passed around and in .NET Remoting we will see .NET objects.</p>

<p>Don&rsquo;t worry if you do not understand parts of it because this was a very short intro. We will see how .NET Remoting works later.</p>

<p><strong>Note</strong>: .NET Remoting is deprecated and you should not be using it. But who am I kidding? We are all using old technology all the time so we might as well get used to it.</p>

<h3 id="a-name-ch2-a-2-developing-a-net-remoting-application:a4cceda545ee0d0782d3d591639b4015"><a name="ch2"></a> 2. Developing a .NET Remoting Application</h3>

<p>I am going to create two version of my simple .NET Remoting applications. Both are very simple. The first application will act as tutorial about how to create a .NET Remoting client/server application and the second aims to re-create a vulnerable server that I encountered in one of my projects.</p>

<p>I am going to be using <a href="https://www.visualstudio.com/en-us/products/visual-studio-community-vs.aspx" target="_blank">Visual Studio Community 2015</a> which is free. We will have three different projects in one solution:</p>

<ul>
<li>Remoting Library: A DLL which contains the remotable objects.</li>
<li>Server</li>
<li>Client</li>
</ul>

<p>If you want to play along, Visual Studio solutions are at <a href="https://bitbucket.org/parsiya/net-remoting/src/." target="_blank">https://bitbucket.org/parsiya/net-remoting/src/</a>. With compiled executables being in the <code>Executables</code> directory (keep in mind that these are executables from a stranger on the internet so treat them accordingly).</p>

<p>First the DLL. Create a solution and a new project. Choose <code>Class Library</code> as type of the project. According to <a href="https://msdn.microsoft.com/en-us/library/vstudio/h8f0y3fc%28v=vs.100%29.aspx" target="_blank">this MSDN article</a>, in order for an object to be remotable it should either be <code>Serializable</code> or inherit <a href="https://msdn.microsoft.com/en-us/library/system.marshalbyrefobject%28v=vs.110%29.aspx" target="_blank"><code>MarshalByRefObject</code></a> class. I am taking the <code>MarshalByRefObject</code> route. For more information please refer to <a href="https://msdn.microsoft.com/library/wcf3swha%28v=vs.100%29.aspx" target="_blank">Making Objects Remotable</a>.</p>

<p>Here&rsquo;s how the Remoting Library (the DLL) looks like:</p>




    

<figure class="code">
  <figcaption>
  	<span>RemotingLibrary.cs</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">using</span> <span style="color: #93A1A1">System;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Collections.Generic;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Linq;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Text;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Threading.Tasks;</span>

<span style="color: #719e07">namespace</span> <span style="color: #93A1A1">RemotingSample</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #719e07">public</span> <span style="color: #719e07">class</span> <span style="color: #268BD2">RemoteMath</span> <span style="color: #93A1A1">:</span> <span style="color: #93A1A1">MarshalByRefObject</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #719e07">public</span> <span style="color: #DC322F">int</span> <span style="color: #268BD2">Add</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">a,</span> <span style="color: #DC322F">int</span> <span style="color: #93A1A1">b)</span>    <span style="color: #586E75">// add</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Add({0},{1}) called&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">a,</span> <span style="color: #93A1A1">b);</span>
      <span style="color: #719e07">return</span> <span style="color: #93A1A1">a</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">b;</span>
    <span style="color: #93A1A1">}</span>

    <span style="color: #719e07">public</span> <span style="color: #DC322F">int</span> <span style="color: #268BD2">Sub</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">a,</span> <span style="color: #DC322F">int</span> <span style="color: #93A1A1">b)</span>    <span style="color: #586E75">// subtract</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Sub({0},{1}) called&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">a,</span> <span style="color: #93A1A1">b);</span>
      <span style="color: #719e07">return</span> <span style="color: #93A1A1">a</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">b;</span>
    <span style="color: #93A1A1">}</span>
  <span style="color: #93A1A1">}</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Note that the class <code>RemoteMath</code> is derived from <code>MarshalByRefObject</code> to make it remotable. We don&rsquo;t need to do anything else with regards to .NET Remoting in this DLL. Each function will print some text when it is called so we can see where the function actually runs.</p>

<p>Create a new project named <code>Server</code> and use the following code. The comments should explain what is happening:</p>




    

<figure class="code">
  <figcaption>
  	<span>Server.cs</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">using</span> <span style="color: #93A1A1">System;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Collections.Generic;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Linq;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Text;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Threading.Tasks;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Runtime.Remoting;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Runtime.Remoting.Channels;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Runtime.Remoting.Channels.Tcp;</span>

<span style="color: #719e07">namespace</span> <span style="color: #93A1A1">RemotingSample</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #719e07">class</span> <span style="color: #268BD2">Server</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #719e07">static</span> <span style="color: #719e07">void</span> <span style="color: #268BD2">Main</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">string</span><span style="color: #93A1A1">[]</span> <span style="color: #93A1A1">args)</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #586E75">// create a TCP channel and bind it to port 8888</span>
      <span style="color: #93A1A1">TcpChannel</span> <span style="color: #93A1A1">remotingChannel</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">TcpChannel(</span><span style="color: #2AA198">8888</span><span style="color: #93A1A1">);</span>

      <span style="color: #586E75">// register the channel, the second parameter is ensureSecurity</span>
      <span style="color: #586E75">// I have set it to false to disable encryption and signing</span>
      <span style="color: #586E75">// for more information see section Remarks in https://msdn.microsoft.com/en-us/library/ms223155(v=vs.90).aspx</span>
      <span style="color: #93A1A1">ChannelServices.RegisterChannel(remotingChannel,</span> <span style="color: #719e07">false</span><span style="color: #93A1A1">);</span>

      <span style="color: #586E75">// create a new servicetype of type RemoteMath named &quot;rMath&quot; and of type SingleCall</span>
      <span style="color: #586E75">// SingleCall: a new object will be created for each call</span>
      <span style="color: #586E75">// as opposed to WellKnownObjectMode.Singleton where there is one object for all calls (and clients)</span>
      <span style="color: #93A1A1">WellKnownServiceTypeEntry</span> <span style="color: #93A1A1">remoteObject</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">WellKnownServiceTypeEntry(</span><span style="color: #719e07">typeof</span><span style="color: #93A1A1">(RemoteMath),</span> <span style="color: #2AA198">&quot;rMath&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">WellKnownObjectMode.SingleCall);</span>

      <span style="color: #586E75">// register the remoteObject servicetype</span>
      <span style="color: #93A1A1">RemotingConfiguration.RegisterWellKnownServiceType(remoteObject);</span>

      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Registered service&quot;</span><span style="color: #93A1A1">);</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Press any key to exit&quot;</span><span style="color: #93A1A1">);</span>
      <span style="color: #93A1A1">Console.ReadLine();</span>
    <span style="color: #93A1A1">}</span>
  <span style="color: #93A1A1">}</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>We need to add two references to the project using <code>Project (menu) &gt; Add References</code>:</p>

<ol>
<li><code>System.Runtime.Remoting</code> assembly</li>
<li>Remoting Library project</li>
</ol>

<p>Server will expose the <code>RemoteMath</code> class and wait until a key is pressed. Client can call the functions in <code>RemoteMath</code> until the server is terminated.</p>

<p>Client code also needs the same two references. Client calls <code>Add</code> and <code>Sub</code> and prints the results.</p>




    

<figure class="code">
  <figcaption>
  	<span>Client.cs</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">using</span> <span style="color: #93A1A1">System;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Collections.Generic;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Linq;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Text;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Threading.Tasks;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Runtime.Remoting;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Runtime.Remoting.Channels;</span>
<span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Runtime.Remoting.Channels.Tcp;</span>

<span style="color: #719e07">namespace</span> <span style="color: #93A1A1">RemotingSample</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #719e07">class</span> <span style="color: #268BD2">Client</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #719e07">static</span> <span style="color: #719e07">void</span> <span style="color: #268BD2">Main</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">string</span><span style="color: #93A1A1">[]</span> <span style="color: #93A1A1">args)</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #586E75">// create and register the TCP channel</span>
      <span style="color: #586E75">// please note that I have set the security of the channel to false</span>
      <span style="color: #93A1A1">TcpChannel</span> <span style="color: #93A1A1">clientRemotingChannel</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">TcpChannel();</span>
      <span style="color: #93A1A1">ChannelServices.RegisterChannel(clientRemotingChannel,</span> <span style="color: #719e07">false</span><span style="color: #93A1A1">);</span>

      <span style="color: #586E75">// create an object of type RemothMath</span>
      <span style="color: #586E75">// we have to do a cast because Activator.GetObject returns an object (doh)</span>
      <span style="color: #586E75">// type is RemoteMath and server address is what we created in Server.cs (port:8888 and rMath)</span>

      <span style="color: #586E75">// Server.cs code:</span>
      <span style="color: #586E75">// TcpChannel remotingChannel = new TcpChannel(8888);</span>
      <span style="color: #586E75">// ChannelServices.RegisterChannel(remotingChannel, false);</span>
      <span style="color: #586E75">// WellKnownServiceTypeEntry remoteObject = new WellKnownServiceTypeEntry(typeof(RemoteMath), &quot;rMath&quot;, WellKnownObjectMode.SingleCall);</span>

      <span style="color: #93A1A1">RemoteMath</span> <span style="color: #93A1A1">remoteMathObject</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">(RemoteMath)Activator.GetObject(</span><span style="color: #719e07">typeof</span><span style="color: #93A1A1">(RemoteMath),</span> <span style="color: #2AA198">&quot;tcp://localhost:8888/rMath&quot;</span><span style="color: #93A1A1">);</span>

      <span style="color: #586E75">// now we can call Add and Sub functions</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Result of Add(1, 2): {0}&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">remoteMathObject.Add(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">));</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Result of Sub(10, 3): {0}&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">remoteMathObject.Sub(</span><span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3</span><span style="color: #93A1A1">));</span>

      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Press any key to exit&quot;</span><span style="color: #93A1A1">);</span>
      <span style="color: #93A1A1">Console.ReadLine();</span>
    <span style="color: #93A1A1">}</span>
  <span style="color: #93A1A1">}</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Now we can build the solution. If you look at the resulting executables we will that both client and server have a copy of <code>RemotingLibrary.dll</code>.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/01.png" title="Both Client and Server have the same DLL" alt="Both Client and Server have the same DLL">
  <span class="caption-text">Both Client and Server have the same DLL</span>
</span>


<p>Now start <code>RawCap</code> and capture local traffic.</p>

<h3 id="a-name-ch3-a-3-net-remoting-messages:a4cceda545ee0d0782d3d591639b4015"><a name="ch3"></a> 3. .NET Remoting Messages</h3>

<p>When you initially run the server, it will ask to be added to Windows Firewall&rsquo;s exceptions. You can safely deny that as both client and server are local. This is a major vulnerability in many .NET Remoting applications that work locally (like our example). If we do a <code>netstat</code> we can see that server is bound to <code>0.0.0.0</code> and is listening on all interfaces. Meaning anyone can connect to the server and execute exposed functions on our computer. We will read more about this later.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/02.png" title="Server listening on all interfaces" alt="Server listening on all interfaces">
  <span class="caption-text">Server listening on all interfaces</span>
</span>


<p>Now run both server and client and look at the results.</p>

<p>We can see client calling both functions and printing the result.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/03.png" title="Client execution" alt="Client execution">
  <span class="caption-text">Client execution</span>
</span>


<p>We can clearly see that the functions were executed in server&rsquo;s application context because server is printing the verbose messages from <code>RemotingLibrary.dll</code>.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/04.png" title="Server execution" alt="Server execution">
  <span class="caption-text">Server execution</span>
</span>


<p>If we look at the traffic in Wireshark and filter all traffic to/from port <code>8888</code>:</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/05.png" title=".NET Remoting traffic in Wireshark" alt=".NET Remoting traffic in Wireshark">
  <span class="caption-text">.NET Remoting traffic in Wireshark</span>
</span>


<p>You can read about the format and structure of .NET Remoting packets in the following documents:</p>

<ul>
<li><a href="http://download.microsoft.com/download/9/5/E/95EF66AF-9026-4BB0-A41D-A4F81802D92C/%5BMS-NRTP%5D.pdf" target="_blank">[MS-NRTP].NET Core Protocol - PDF</a> or just search for <code>[MS-NRTP]</code>.</li>
<li><a href="http://download.microsoft.com/download/9/5/E/95EF66AF-9026-4BB0-A41D-A4F81802D92C/%5BMS-NRBF%5D.pdf" target="_blank">[MS-NRBF] .NET Remoting: Binary Format Data Structure - PDF</a> or just search for <code>[MS-NRBF]</code>.</li>
</ul>

<p>After the TCP handshake we see the first packet from client to server. According to section <code>2.2.3.3 Message Frame Structure</code> of <code>[MS-NRTP]</code> every message should start with <code>ProtocolId</code> which is 4 bytes and should be <code>0x54454E2E</code> or <code>.NET</code>.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">2e 4e 45 54 01 00 00 00 00 00 8d 00 00 00 04 00  .NET............
01 01 1a 00 00 00 74 63 70 3a 2f 2f 6c 6f 63 61  ......tcp://loca
6c 68 6f 73 74 3a 38 38 38 38 2f 72 4d 61 74 68  lhost:8888/rMath
06 00 01 01 18 00 00 00 61 70 70 6c 69 63 61 74  ........applicat
69 6f 6e 2f 6f 63 74 65 74 2d 73 74 72 65 61 6d  ion/octet-stream
00 00                                            ..

.NET tcp://localhost:8888/rMath application/octet-stream

ProtocolId: 0x54454E2E or .NET
Major version: 0x00
Minor Version: 0x00
OperationType: 0x0000 or Request
</pre></div>

<p>This is setting up the .NET Remoting channel and specifying the exposed class that it wants to access <code>rMath</code>. Next is the second part of the first message.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00  ................
00 15 12 00 00 00 12 03 41 64 64 12 61 52 65 6d  ........Add.aRem
6f 74 69 6e 67 53 61 6d 70 6c 65 2e 52 65 6d 6f  otingSample.Remo
74 65 4d 61 74 68 2c 20 52 65 6d 6f 74 69 6e 67  teMath, Remoting
4c 69 62 72 61 72 79 2c 20 56 65 72 73 69 6f 6e  Library, Version
3d 31 2e 30 2e 30 2e 30 2c 20 43 75 6c 74 75 72  =1.0.0.0, Cultur
65 3d 6e 65 75 74 72 61 6c 2c 20 50 75 62 6c 69  e=neutral, Publi
63 4b 65 79 54 6f 6b 65 6e 3d 6e 75 6c 6c 02 00  cKeyToken=null..
00 00 08 01 00 00 00 08 02 00 00 00 0b           .............

Add RemotingSample.RemoteMath, RemotingLibrary, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
</pre></div>

<p>This is the <code>Add(1,2)</code> call. We can see the following in this message:</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">RemotingLibrary</span><span style="color: #719e07">:</span> <span style="color: #93A1A1">DLL</span> <span style="color: #93A1A1">containing</span> <span style="color: #93A1A1">the</span> <span style="color: #93A1A1">exposed</span> <span style="color: #268BD2">class</span>
<span style="color: #93A1A1">RemotingSample</span><span style="color: #719e07">.</span><span style="color: #93A1A1">Remotemath</span><span style="color: #719e07">:</span> <span style="color: #93A1A1">The</span> <span style="color: #93A1A1">exposed</span> <span style="color: #268BD2">class</span>
<span style="color: #93A1A1">Add</span><span style="color: #719e07">:</span> <span style="color: #93A1A1">The</span> <span style="color: #268BD2">function</span> <span style="color: #93A1A1">that</span> <span style="color: #719e07">is</span> <span style="color: #93A1A1">called</span>
</pre></div>

<p>And if you look closely you can see the <code>Add</code> parameters in the last line in little endian (Int32 or 4 bytes).</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">01 00 00 00: int a
02 00 00 00: int b
</pre></div>

<p>I don&rsquo;t want to talk about the message structure, just identifying the method, parameters, class and DLL when we see such a packet is enough.</p>

<p>For a very good explanation of all fields using examples please refer to section <code>4.1 Two-Way Method Invocation Using TCP-Binary</code> of <code>[MS-NRTP]</code>.</p>

<p>Think of the reply as an ACK and like any other .NET Remoting message it starts with <code>.NET</code>. According to <code>[MS-NRTP] Section 2.1.1.1.2 Receiving Reply</code> &ldquo;If the OperationType of the message is Request(0), an implementation MUST wait for the Two-Way Reply message in the same connection.&rdquo;</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">2e 4e 45 54 01 00 02 00 00 00 1c 00 00 00 00 00 .NET............

ProtocolId: 0x54454E2E or .NET
Major version: 0x00
Minor Version: 0x00
OperationType: 0x0002 or Response
</pre></div>

<p>Then the actual result is sent from server to client.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00  ................
00 16 11 08 00 00 08 03 00 00 00 0b              ............
</pre></div>

<p>We can see the return value (which is again an Int32 and 4 bytes) at the end of the packet prefixed by the same <code>0x08</code> byte that we saw before (remember the parameters?), and is <code>03 00 00 00</code>.</p>

<p>Messages for <code>Sub</code> are very similar. I am not going to talk about them because, ahem <code>they are left as an exercise for the reader</code>.</p>

<h3 id="a-name-ch4-a-4-debugging-with-dnspy:a4cceda545ee0d0782d3d591639b4015"><a name="ch4"></a> 4. Debugging with dnSpy</h3>

<p>In this section, I assume you know basic debugging (e.g. breakpoints, step into/over/out) so I will not go into details. I will mostly just talk about (some of) dnSpy&rsquo;s features.</p>

<p>Run <code>Server.exe</code> and then run dnSpy (for x86 application use <code>dnSpy-x86.exe</code>). Drag and drop <code>Client.exe</code> into it and navigate to <code>Main</code>. Notice that dnSpy automatically loads referenced DLLs including <code>RemotingLibrary.dll</code>. The decompiled code in dnSpy is the same as our original code but without the comments.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/06.png" title="Opening Client.exe in dnSpy" alt="Opening Client.exe in dnSpy">
  <span class="caption-text">Opening Client.exe in dnSpy</span>
</span>


<p>Now we can run the client in dnSpy. Click on the green button named <code>Start</code> and it will open a dialog to start an executable in dnSpy. In version 1.4 it is pre-populated with <code>Client.exe</code> that we just dragged and dropped into dnSpy. As you can see, what can also specify arguments and also order the debugger to break on certain events. Let&rsquo;s keep the original selection and run <code>Client.exe</code>. dnSpy will break on <code>Main</code>.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/07.png" title="Start options" alt="Start options">
  <span class="caption-text">Start options</span>
</span>


<p>Now we can debug normally using shortcut keys or small button to the right of the <code>Continue</code> button (formerly <code>Start</code>).</p>

<p>To set a breakpoint, you can either select a line and press <code>F2</code>, click on the space left of the line number or right click on the line and select it from the context menu. In this case we put a breakpoint on line <code>16</code> or the first <code>Console.WriteLine</code>.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/08.png" title="Breakpoint" alt="Breakpoint">
  <span class="caption-text">Breakpoint</span>
</span>


<h4 id="4-1-finding-nemo:a4cceda545ee0d0782d3d591639b4015">4.1 Finding Nemo</h4>

<p>In this case, we can clearly see the <code>Add</code> function and where it is called. But let&rsquo;s assume that we only saw the traffic and opened the binary in dnSpy and didn&rsquo;t know where it is called. Our binary contains tons and tons of imaginary functions that may or may not call <code>Add</code>. How do we find <code>Add</code>?</p>

<p>From the traffic we know that the function name is <code>Add</code> and it is in class <code>RemotingSample.Remotemath</code> and resides in <code>RemotingLibrary.dll</code>. Using these clues we can easily find the <code>Add</code> function in dnSpy.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/09.png" title="Finding Add" alt="Finding Add">
  <span class="caption-text">Finding Add</span>
</span>


<p>Our first instinct would be to put a breakpoint on <code>Add</code> and let the client <code>Continue</code>. But <strong>this breakpoint will never trigger</strong>. Because in .NET Remoting an instance of the function is created on the client and then executed on the server. If you don&rsquo;t believe me, try it. But how do we find who uses this function?</p>

<h4 id="4-2-analyze-this:a4cceda545ee0d0782d3d591639b4015">4.2 Analyze This</h4>

<p>Now we can use the <code>Analyze</code> feature of dnSpy. Right click on the <code>Add</code> function in <code>RemotingLibrary.dll</code> and select <code>Analyze</code>. Now a very handy new pane (window? seriously what are these called?) named <code>Analyzer</code> pops up. We can see the function and two items <code>Uses</code> and <code>Used By</code>. <code>Uses</code> shows us the other functions (in loaded binaries in dnSpy) that are used by <code>Add</code> and <code>Used By</code> shows other functions that use <code>Add</code>.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/10.png" title="Analyze this" alt="Analyze this">
  <span class="caption-text">Analyze this</span>
</span>
</p>

<p>That is a very nifty feature, neh? As you can see we can go down the wormhole and follow the chain. In this case we see that the <code>Main</code> function calls <code>Add</code>. If we double click on <code>Main</code> we will go back to the original entry point.</p>

<h4 id="4-3-net-remoting-in-action:a4cceda545ee0d0782d3d591639b4015">4.3 .NET Remoting in Action</h4>

<p>Now we can <code>Step Into</code> the line that calls <code>Add</code> in the client. If you have not changed the default settings, you should land in <code>mscorlib.dll</code> or more exactly in <code>CommonLanguageRuntimeLibrary.System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke()</code>. dnSpy&rsquo;s default settings, will skip all the other code (like attribute get/set etc). You can change this in <code>View (menu) &gt; Options (menu item) &gt; Debugger (tab) &gt; DebuggerBrowsable</code> and <code>Call string-conversion</code>.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/11.png" title="Landed in RealProxy" alt="Landed in RealProxy">
  <span class="caption-text">Landed in RealProxy</span>
</span>
</p>

<p>In order to see local variables and their values press <code>Alt+4</code> to open the <code>Locals</code> window. This was changed in version 1.3 and up and is a huge UX upgrade.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/12.png" title="Meeting the Locals" alt="Meeting the Locals">
  <span class="caption-text">Meeting the Locals</span>
</span>
</p>

<p>This where we always end up after following .NET Remoting calls; where the message is being sent and we can see its contents. In version 1.3 of dnSpy, any breakpoints set here would not be triggered but now we can do it (what a time to be alive). So you can set a breakpoint on line 404 (if you can find it <em>he he he</em>) <code>RemotingProxy remotingProxy = null;</code> just right before <code>if (1 == type)</code> and look at messages.</p>

<p><code>Type == 1</code> so the first <code>if</code> will be true. Let&rsquo;s look at it (with some comments):</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #93A1A1">==</span> <span style="color: #93A1A1">type)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #93A1A1">Message</span> <span style="color: #93A1A1">expr_14</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">Message();</span>

  <span style="color: #586E75">// msgData is one of the function parameters (along with type) and contains the message info</span>
  <span style="color: #586E75">// we can see that it is used to populate expr_14 which looks like a temp Message</span>
  <span style="color: #93A1A1">expr_14.InitFields(msgData);</span>

  <span style="color: #586E75">// expr_14 is copied to message</span>
  <span style="color: #93A1A1">message</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">expr_14;</span>			<span style="color: #586E75">// put a breakpoint here</span>

  <span style="color: #93A1A1">num</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">expr_14.GetCallType();</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Let&rsquo;s put a breakpoint on line <code>409 num = message = expr_14;</code> and continue. When we reach this line, we can step over it until we reach line <code>410</code> and then see the contents of the variable named <code>message</code>. Why didn&rsquo;t we put a breakpoint on the next line? Because if it won&rsquo;t trigger with default settings (remember those debugger settings at the start of this section?). Press <code>Alt+4</code> to look at <code>message</code>.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/13.png" title="Contents of variable message" alt="Contents of variable message">
  <span class="caption-text">Contents of variable message</span>
</span>
</p>

<p>We can see the message and a lot of information about it. Scroll down to line <code>474 RealProxy.HandleReturnMessage(message, message2);</code> and set a breakpoint on line <code>475</code> and <code>Continue</code>. We can see that the text in the function is printed on the server and we land in the new breakpoint and can see the return value in <code>message2</code>.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/14.png" title="Return value" alt="Return value">
  <span class="caption-text">Return value</span>
</span>
</p>

<p>If we <code>Step Out</code> we will land back in <code>Main</code>. Try doing the same for the <code>Sub</code> function call.</p>

<p>Now we know the places to see the outgoing .NET Remoting message and return values. In a real world project we could do this to look at the messages instead of Wireshark or developing our own .NET Remoting proxy.</p>

<h3 id="a-name-ch5-a-5-re-creating-the-vulnerability:a4cceda545ee0d0782d3d591639b4015"><a name="ch5"></a> 5. Re-creating the Vulnerability</h3>

<p><strong>Note:</strong> Please run this application in a Virtual Machine disconnected from the internet. This application will make your machine vulnerable to unauthenticated RCE. Make sure that Windows firewall is not disabled and do not allow <code>Server.exe</code> through it. I believe the chance of someone getting compromised is very very slim because no one reads these posts anyway, but it never hurts to be careful.</p>

<p>One application that I looked at, let&rsquo;s call it <code>Remoting Expanded</code> had two components. A server which was run as <code>SYSTEM</code> on startup via a Windows service and a client application which was executed by an standard user. Client used .NET Remoting to execute functions in server to perform actions that were not available to standard users. I basically went through the same steps to look at and debug the .NET Remoting calls. I was looking at the decompiled code of the DLL containing the remotable objects and discovered that there are a lot of exposed functions which are not used by the client application. One of them was <code>StartProcess</code> (that&rsquo;s not its real name) and executed an executable as SYSTEM.</p>

<p>To re-create we are going to change our code and add a new function to the <code>RemotingLibrary</code> DLL. Client and server are not modified but be sure to rebuild the solution to get the new DLL in build directories of client and server projects. I created a new project and called it <code>RemotingLibraryExpanded</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>RemotingLibraryExpanded.cs</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">namespace</span> <span style="color: #93A1A1">RemotingLibraryExpanded</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #719e07">public</span> <span style="color: #719e07">class</span> <span style="color: #268BD2">RemoteMathExpanded</span> <span style="color: #93A1A1">:</span> <span style="color: #93A1A1">MarshalByRefObject</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #719e07">public</span> <span style="color: #DC322F">int</span> <span style="color: #268BD2">Add</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">a,</span> <span style="color: #DC322F">int</span> <span style="color: #93A1A1">b)</span>    <span style="color: #586E75">// add</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Add({0},{1}) called&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">a,</span> <span style="color: #93A1A1">b);</span>
      <span style="color: #719e07">return</span> <span style="color: #93A1A1">a</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">b;</span>
    <span style="color: #93A1A1">}</span>

    <span style="color: #719e07">public</span> <span style="color: #DC322F">int</span> <span style="color: #268BD2">Sub</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">a,</span> <span style="color: #DC322F">int</span> <span style="color: #93A1A1">b)</span>    <span style="color: #586E75">// subtract</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Sub({0},{1}) called&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">a,</span> <span style="color: #93A1A1">b);</span>
      <span style="color: #719e07">return</span> <span style="color: #93A1A1">a</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">b;</span>
    <span style="color: #93A1A1">}</span>

    <span style="color: #586E75">// super secret process start method</span>
    <span style="color: #719e07">public</span> <span style="color: #719e07">void</span> <span style="color: #268BD2">StartProcess</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">string</span> <span style="color: #93A1A1">processPath)</span>
    <span style="color: #93A1A1">{</span>
      <span style="color: #93A1A1">Console.WriteLine(</span><span style="color: #2AA198">&quot;Starting process {0}&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">processPath);</span>
      <span style="color: #93A1A1">Process.Start(processPath);</span>
    <span style="color: #93A1A1">}</span>
  <span style="color: #93A1A1">}</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Now we can rebuild the solution. Client and server will run as before now we want to exploit this new method to do local privilege escalation (running the executable of our choice as SYSTEM). At this point we can either write code (which we already did) or modify the client application using dnSpy (and some other tools). I modified the application in my project because it was much easier than writing code from scratch because there were a lot of stuff happening before the client started making calls to server.</p>

<h3 id="a-name-ch6-a-6-modifying-il-instructions-with-dnspy-and-patching-binaries:a4cceda545ee0d0782d3d591639b4015"><a name="ch6"></a> 6. Modifying IL Instructions with dnSpy and Patching Binaries</h3>

<p>The easiest thing to do is to modify one of the function calls to call <code>StartProcess</code> and run an executable (e.g. <code>C:\Windows\System32\calc.exe</code>). Open the client in dnSpy and right click on the line that calls <code>Add</code> (line 16 in dnSpy). Choose <code>Edit IL Instructions</code>.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/15.png" title="IL instructions" alt="IL instructions">
  <span class="caption-text">IL instructions</span>
</span>
</p>

<p>What is IL? CIL (Common Intermediate Language) or IL is (almost) the .NET equivalent of Java bytecode. Let&rsquo;s look at what we got and see if we can decipher it (read the comments please):</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>IL code for line 16</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">// pop remoteMathObject from stack and put it in local variable 1</span>
<span style="color: #2AA198">12</span>	<span style="color: #2AA198">0028</span>	<span style="color: #93A1A1">stloc.</span><span style="color: #2AA198">1</span>

<span style="color: #586E75">// push the string to stack</span>
<span style="color: #2AA198">13</span>	<span style="color: #2AA198">0029</span>	<span style="color: #93A1A1">ldstr</span>	<span style="color: #2AA198">&quot;Result of Add(1, 2): {0}&quot;</span>

<span style="color: #586E75">// push local variable 1 to stack. In this case, remoteMathObject is pushed to stack</span>
<span style="color: #586E75">// this is done because we are going to call remoteMathObject.Add</span>
<span style="color: #2AA198">14</span>	<span style="color: #2AA198">002</span><span style="color: #93A1A1">E</span>	<span style="color: #93A1A1">ldloc.</span><span style="color: #2AA198">1</span>

<span style="color: #586E75">// push the value 0x1 to the stack</span>
<span style="color: #586E75">// IL has ldc.i4.1 to ldc.i4.8 and also a separate ldc.i4 &lt;Int32&gt; to push Ints to the stack</span>
<span style="color: #2AA198">15</span>	<span style="color: #2AA198">002F</span>	<span style="color: #93A1A1">ldc.i4.</span><span style="color: #2AA198">1</span>

<span style="color: #586E75">// push the value 0x2 to the stack</span>
<span style="color: #2AA198">16</span>	<span style="color: #2AA198">0030</span>	<span style="color: #93A1A1">ldc.i4.</span><span style="color: #2AA198">2</span>

<span style="color: #586E75">// call Add</span>
<span style="color: #2AA198">17</span>	<span style="color: #2AA198">0031</span>	<span style="color: #93A1A1">callvirt</span>	<span style="color: #93A1A1">instance</span> <span style="color: #93A1A1">int32</span> <span style="color: #93A1A1">[RemotingLibrary]RemotingSample.RemoteMath::Add(int32,</span> <span style="color: #93A1A1">int32)</span>

<span style="color: #586E75">// box converts a value type to an object reference.</span>
<span style="color: #586E75">// I assume it means that we are converting the result of add to Int32</span>
<span style="color: #2AA198">18</span>	<span style="color: #2AA198">0036</span>	<span style="color: #93A1A1">box</span>	<span style="color: #93A1A1">[mscorlib]System.Int32</span>

<span style="color: #586E75">// call console.writeline (parameters are the format string that was pushed to stack and return value of add)</span>
<span style="color: #2AA198">19</span>	<span style="color: #2AA198">003</span><span style="color: #93A1A1">B</span>	<span style="color: #93A1A1">call</span>	<span style="color: #719e07">void</span> <span style="color: #93A1A1">[mscorlib]System.Console::WriteLine(</span><span style="color: #DC322F">string</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Now we have a general idea of what&rsquo;s happening here. We need to change <code>Add</code> to <code>StartProcess</code>. Click on <code>Add</code> and a small context menu pops up.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/16.png" title="Method context menu" alt="Method context menu">
  <span class="caption-text">Method context menu</span>
</span>
</p>

<p>Select <code>Method</code> and a new page pops up that allows you to modify it to any method in all loaded assemblies. We can see the new fancy <code>StartProcess</code> function. So we select that. There&rsquo;s also a handy search feature.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/17.png" title="Pick a method" alt="Pick a method">
  <span class="caption-text">Pick a method</span>
</span>
</p>

<p>The method call is changed but <code>Add</code> had two Int32 parameters while <code>StartProcess</code> has only one string parameter. Without more modifications, two Int32s are pushed to the stack before the new method is being called. If we press OK on the IL code window we will see this monstrosity.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/18.png" title="You ruined everything!!1!" alt="You ruined everything!!1!">
  <span class="caption-text">You ruined everything!!1!</span>
</span>
</p>

<p>But that&rsquo;s fine, we can edit the IL instructions and fix it. But how do we know what to do? At this point we can just learn IL coding but based on the instructions that we have seen, we should have a general idea of what to do. We also need to remove the <code>Console.WriteLine</code> because <code>StartProcess</code> has no return value (well <code>void()</code> but you know what I mean) and we should be calling <code>remoteMathObject.StartProcess(&quot;c:\\windows\\system32\\calc.exe&quot;);</code> individually.</p>

<p>The following IL code does the trick:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Fixed IL instructions</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #2AA198">12</span>	<span style="color: #2AA198">0028</span>	<span style="color: #93A1A1">stloc.</span><span style="color: #2AA198">1</span>
<span style="color: #2AA198">13</span>	<span style="color: #2AA198">0029</span>	<span style="color: #93A1A1">ldloc.</span><span style="color: #2AA198">1</span>
<span style="color: #2AA198">14</span>	<span style="color: #2AA198">002</span><span style="color: #93A1A1">A</span>	<span style="color: #93A1A1">ldstr</span>	<span style="color: #2AA198">&quot;c:\\windows\\system32\\calc.exe&quot;</span>
<span style="color: #2AA198">15</span>	<span style="color: #2AA198">002F</span>	<span style="color: #93A1A1">callvirt</span>	<span style="color: #93A1A1">instance</span> <span style="color: #719e07">void</span> <span style="color: #93A1A1">[RemotingLibraryExpanded]RemotingLibraryExpanded.RemoteMathExpanded::StartProcess(</span><span style="color: #DC322F">string</span><span style="color: #93A1A1">)</span>
<span style="color: #2AA198">16</span>	<span style="color: #2AA198">0034</span>	<span style="color: #93A1A1">nop</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/19.png" title="You fixed it!!1!" alt="You fixed it!!1!">
  <span class="caption-text">You fixed it!!1!</span>
</span>
</p>

<p>There is another way to do this. Download <a href="https://www.linqpad.net/Download.aspx" target="_blank">LINQPad 5.0</a>. The standard version is free and is more than enough for our purpose. Copy paste all of the code in the client class into it. Now just like in Visual Studio we need to add references and import namespaces.</p>

<ol>
<li>Change the <code>Language</code> drop-down list to <code>C# Program</code>.</li>
<li>Right click and select <code>References and Properties</code>.</li>
<li>In the <code>References</code> tab click <code>Add</code> and search for <code>System.Runtime.Remoting.dll</code>.</li>
<li>Click <code>Browse</code> and select <code>RemotingLibraryExpanded.dll</code>.</li>
<li>Select the <code>Additional Namespace Imports</code> tab.</li>
<li>Click <code>Pick from assemblies</code>.</li>
<li>Select <code>RemotingLibraryExpanded.dll</code> and add its namespace.</li>
<li>Select <code>System.Runtime.Remoting.dll</code> and add <code>System.Runtime.Remoting.Channels</code> and <code>System.Runtime.Remoting.Channels.Tcp</code>.</li>
</ol>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/20.png" title="References in LINQPad" alt="References in LINQPad">
  <span class="caption-text">References in LINQPad</span>
</span>
</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/21.png" title="Namespaces in LINQPad" alt="Namespaces in LINQPad">
  <span class="caption-text">Namespaces in LINQPad</span>
</span>
</p>

<p>Now all of the errors in LINQPad should be gone and we can modify the code. Modify the first <code>Console.WriteLine</code> to <code>StartProcess(&quot;c:\\windows\system32\calc.exe&quot;)</code> and press <code>Execute</code>. The application may or may not execute properly. It will probably fail because we already have a TCP channel registered but we don&rsquo;t care about that. Click on the <code>IL</code> button at the bottom to see the generated IL code which is the same as what we wrote in dnSpy.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/22.png" title="IL code in LINQPad" alt="IL code in LINQPad">
  <span class="caption-text">IL code in LINQPad</span>
</span>
</p>

<p>Now we can save the modified module (in this case a new version of the client executable) using dnSpy. Use <code>File (menu) &gt; Save Module</code> to save the new executable (let&rsquo;s call it <code>Client1.exe</code>). Run <code>Client1.exe</code> and Pew.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/23.png" title="Pew Pew" alt="Pew Pew">
  <span class="caption-text">Pew Pew</span>
</span>
</p>

<p><em>How can this be used in local privilege escalation?</em><br />
In the original project, server was running as SYSTEM, which means any standard user could run any binary or command and effectively give themselves admin.</p>

<p><em>How does this lead to Remote Code Execution (RCE)?</em><br />
As we saw at the start of this post, server is listening on <code>0.0.0.0</code> or all interfaces. This means any attacker can connect to the server and execute arbitrary commands. Windows Firewall will not help if you had added an exception for server when it was initially started.</p>

<h3 id="a-name-ch7-a-7-remediation:a4cceda545ee0d0782d3d591639b4015"><a name="ch7"></a> 7. Remediation</h3>

<p>Remediation is an important part of my day job. I am not an <code>infosec thoughtleader</code> but I think breaking is worth nothing if we don&rsquo;t want to/cannot talk to and work with the developers to fix things. So I am going to add remediation sections to my posts where appropriate and do my small part in helping. As with any other part of these posts, if you think there is a better way of doing things please let me know.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/24.jpg" title="[insert reference to Starship Troopers and killing bugs and call yourself a geek]" alt="[insert reference to Starship Troopers and killing bugs and call yourself a geek]">
  <span class="caption-text">[insert reference to Starship Troopers and killing bugs and call yourself a geek]</span>
</span>
</p>

<p>It should be noted that channel properties and registration could also be done in executables&rsquo; config files. Please refer to <a href="https://msdn.microsoft.com/en-us/library/ms973907.aspx" target="_blank">Format for .NET Remoting Configuration Files</a> for more information.</p>

<p>I also have to reiterate that <strong>this is deprecated technology</strong> and it should not be used for new applications. But if you are stuck with legacy code and want to fix it, please read on.</p>

<p>Start here for MSDN articles on this topic: <a href="https://msdn.microsoft.com/en-us/library/9hwst9th%28v=vs.85%29.aspx" target="_blank">Security in Remoting</a>.</p>

<h4 id="7-1-rce:a4cceda545ee0d0782d3d591639b4015">7.1 RCE</h4>

<p>In this scenario we should only be listening on <code>localhost</code>. We have to modify the server. If we look at <a href="https://msdn.microsoft.com/library/bb397830%28v=vs.100%29.aspx" target="_blank">TcpChannel properties</a> we can see there is a <code>bindTo</code> property. We can add it to a dictionary and use it in the constructor as follows:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Binding the server to localhost</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Collections;</span>

<span style="color: #93A1A1">IDictionary</span> <span style="color: #93A1A1">tcpChannelProperties</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">Hashtable();</span>
<span style="color: #93A1A1">tcpChannelProperties[</span><span style="color: #2AA198">&quot;port&quot;</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">8888</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">tcpChannelProperties[</span><span style="color: #2AA198">&quot;bindTo&quot;</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;127.0.0.1&quot;</span><span style="color: #93A1A1">;</span>

<span style="color: #93A1A1">TcpChannel</span> <span style="color: #93A1A1">remotingChannel</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">TcpChannel(tcpChannelProperties,</span> <span style="color: #719e07">null</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">null</span><span style="color: #93A1A1">);</span>

<span style="color: #586E75">// Or in the config file:</span>

<span style="color: #93A1A1">&lt;channels&gt;</span>
  <span style="color: #93A1A1">&lt;channel</span> <span style="color: #719e07">ref</span><span style="color: #93A1A1">=</span><span style="color: #2AA198">&quot;tcp&quot;</span> <span style="color: #93A1A1">port=</span><span style="color: #2AA198">&quot;8888&quot;</span> <span style="color: #93A1A1">bindTo=</span><span style="color: #2AA198">&quot;127.0.0.1&quot;</span> <span style="color: #93A1A1">/&gt;</span>
<span style="color: #93A1A1">&lt;/channels&gt;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>And now we can see the server listening only on localhost.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/25.png" title="Server listening on localhost" alt="Server listening on localhost">
  <span class="caption-text">Server listening on localhost</span>
</span>
</p>

<p>We can also <a href="https://msdn.microsoft.com/en-us/library/bb187429%28v=vs.85%29.aspx" target="_blank">authenticate the client</a>.</p>

<h4 id="7-2-channel-encryption-and-authentication:a4cceda545ee0d0782d3d591639b4015">7.2 Channel Encryption and Authentication</h4>

<p>We can also encrypt the channel. Channels have a <code>Secure</code> property that will encrypt the channel if set to <code>true</code>. However, <strong>both client and server channels should be set to secure</strong>. We can simply add it to <code>tcpChannelProperties</code> in both client and server and set it to <code>true</code>:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Securing the server channel</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Collections;</span>

<span style="color: #93A1A1">IDictionary</span> <span style="color: #93A1A1">tcpChannelProperties</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">Hashtable();</span>
<span style="color: #93A1A1">properttcpChannelPropertiesies[</span><span style="color: #2AA198">&quot;port&quot;</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">8888</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">tcpChannelProperties[</span><span style="color: #2AA198">&quot;bindTo&quot;</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;127.0.0.1&quot;</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">tcpChannelProperties[</span><span style="color: #2AA198">&quot;secure&quot;</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">true</span>

<span style="color: #93A1A1">TcpChannel</span> <span style="color: #93A1A1">remotingChannel</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">TcpChannel(tcpChannelProperties,</span> <span style="color: #719e07">null</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">null</span><span style="color: #93A1A1">);</span>

<span style="color: #586E75">// Or in the config file:</span>

<span style="color: #93A1A1">&lt;channels&gt;</span>
	<span style="color: #93A1A1">&lt;channel</span> <span style="color: #719e07">ref</span><span style="color: #93A1A1">=</span><span style="color: #2AA198">&quot;tcp&quot;</span> <span style="color: #93A1A1">port=</span><span style="color: #2AA198">&quot;8888&quot;</span> <span style="color: #93A1A1">bindTo=</span><span style="color: #2AA198">&quot;127.0.0.1&quot;</span> <span style="color: #93A1A1">secure=</span><span style="color: #2AA198">&quot;true&quot;</span> <span style="color: #93A1A1">/&gt;</span>
<span style="color: #93A1A1">&lt;/channels&gt;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Let&rsquo;s only set the server channel to secure and see what happens:</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/26.png" title="Insecure client channel and secure server channel" alt="Insecure client channel and secure server channel">
  <span class="caption-text">Insecure client channel and secure server channel</span>
</span>
</p>

<p>The client establishes the TCP connection and starts sending message in plaintext, but server never responds.</p>

<p>If we modify the client code similar to the server:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Securing the client channel</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">using</span> <span style="color: #93A1A1">System.Collections;</span>

<span style="color: #93A1A1">IDictionary</span> <span style="color: #93A1A1">tcpChannelProperties</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">Hashtable();</span>
<span style="color: #93A1A1">tcpChannelProperties[</span><span style="color: #2AA198">&quot;secure&quot;</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">true</span><span style="color: #93A1A1">;</span>

<span style="color: #586E75">// Or in the config file:</span>
<span style="color: #93A1A1">&lt;channels&gt;</span>
	<span style="color: #93A1A1">&lt;channel</span> <span style="color: #719e07">ref</span><span style="color: #93A1A1">=</span><span style="color: #2AA198">&quot;tcp&quot;</span> <span style="color: #93A1A1">secure=</span><span style="color: #2AA198">&quot;true&quot;</span> <span style="color: #93A1A1">/&gt;</span>
<span style="color: #93A1A1">&lt;/channels&gt;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Now the channel is encrypted.</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/remoting1/27.png" title="Encrypted TCP channel" alt="Encrypted TCP channel">
  <span class="caption-text">Encrypted TCP channel</span>
</span>
</p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/k62k71x0%28v=vs.85%29.aspx" target="_blank">Encryption and Message Integrity</a> MSDN article talks about encryption. The <code>See Also</code> links at the bottom of the page go to authentication articles. For example <a href="https://msdn.microsoft.com/en-us/library/59hafwyt%28v=vs.85%29.aspx" target="_blank">Authentication with the TCP Channel</a>.</p>

<hr />

<p>Hopefully this was useful. This will pave the way for another blog post where I talk about an older vulnerability that we will investigate using dnSpy and .NET Remoting. If you have any comments/feedback/corrections/complaints, please let me know; you know where to find me.</p>

<!-- links -->

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Nov 14, 2015</time>
    <span class="categories">
      Tags: 
        
        
          <a class="category" href="http://parsiya.net/tags/.net-remoting">.NET Remoting</a>  <a class="category" href="http://parsiya.net/tags/dnspy">dnSpy</a>  <a class="category" href="http://parsiya.net/tags/.net">.NET</a>  
        
    </span>
  </p>
    
  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://parsiya.net/blog/2015-10-19-proxying-hipchat-part-3-ssl-added-and-removed-here/" title="Proxying Hipchat Part 3: SSL Added and Removed Here :^)">Proxying Hipchat Part 3: SSL Added and Removed Here :^)</a>
    

     
      <a class="basic-alignment right" href="http://parsiya.net/blog/2016-01-31-why-hugo/" title="Why Hugo?">Why Hugo?</a>
    
  </p>

  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'parsiya';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

 
      </article>
    </div>
    


<aside class="sidebar thirds">
  <section class="first odd">
    <h1>Who am I?</h1>
    <p>I am Parsia Hakimian. Current (mostly) security consultant at <a target="_blank" href="http://cigital.com" title="cigital">Cigital</a>.</p>
    <p>I am interested in infosec, reverse engineering, Python, C and EvE Online (not necessarily in that order). My email is parsiya[att]google's email.</p>

    
  </section>

  



  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
    <a target="_blank" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
    <a target="_blank" href="https://bitbucket.org/parsiya/" title="https://bitbucket.org/parsiya/"><i class="fa fa-bitbucket fa-3x"></i></a>
    
    
    
    
    <a target="_blank" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
    
    <a target="_blank" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-key fa-3x"></i></a> 

    
    
    </li>
  </ul>

  
  <section class="even">
    <h1>Recent Posts</h1>

    
    <ul id="recent_posts">
      
      
        
      
      
      <li class="post">
        <a href="/blog/2016-02-14-archive-page-in-hugo/">Archive Page in Hugo</a>
      </li>
      
      <li class="post">
        <a href="/blog/2016-02-02-from-octopress-to-hugo/">From Octopress to Hugo</a>
      </li>
      
      <li class="post">
        <a href="/blog/2016-01-31-why-hugo/">Why Hugo?</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-11-14-intro-to-.net-remoting-for-hackers/">Intro to .NET Remoting for Hackers</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-10-19-proxying-hipchat-part-3-ssl-added-and-removed-here/">Proxying Hipchat Part 3: SSL Added and Removed Here :^)</a>
      </li>
      
    </ul>
  </section>

</aside>

  </div>
</div>




<footer role="contentinfo">
  <p>Copyright &copy; 2016 Parsia - <a href="http://parsiya.net/license/">License</a> - 
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


<script>
  var _gaq=[['_setAccount','UA-55491306-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

