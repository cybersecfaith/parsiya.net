<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>Pin Adventures - Chapter 1 - PinSolver Mk1</title>

  
  <link rel="stylesheet" href="http://parsiya.net/css/hugo-octopress.css">

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  

  
  <link href="http://parsiya.net/favicon.png" rel="icon">

  
  
  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="[Parsia Hakimian Parsia infosec information security]">

  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.15" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://parsiya.net/">Parsia&#39;s Den</a></h1>
    <h2>Because no one wants to be the other guy from Wham!</h2>
</hgroup></header>


<nav role="navigation">


<ul class="main-navigation">
  
    <li><a href="http://parsiya.net/" target="_blank" title="Blog">Blog</a></li>
  
    <li><a href="https://www.google.com/search?q=andrew&#43;ridgeley" target="_blank" title="The other guy from Wham!">The other guy from Wham!</a></li>
  
    <li><a href="https://www.github.com" target="_blank" title="This theme - add link">This theme - add link</a></li>
  
</ul>


<ul class="subscription">
  <a href="http://parsiya.net/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>

  
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:http://parsiya.net/" />
  </fieldset>
</form>
</nav>



<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">
        <header>
          <h1 class="entry-title">
            Pin Adventures - Chapter 1 - PinSolver Mk1 
          </h1>
          <p class="meta">Dec 8, 2014 - 11 minute read -  <a href="http://parsiya.net/blog/2014-12-08-Pin-Adventures---Chapter-1---PinSolver-Mk1/#disqus_thread">Comments</a>

          

          
          
          <a class="label" href="http://parsiya.net/categories/reverse-engineering">Reverse Engineering</a>
          </p>
        </header>
        <div class="entry-content">
          

<p>While writing the writeups for the <a href="http://parsiya.net/blog/2014-10-07-my-adventure-with-fireeye-flare-challenge/#ch6" target="_blank">Flare On Challenge 6</a> I came upon <a href="http://gaasedelen.blogspot.com/2014/09/solving-fireeyes-flare-on-six-via-side.html" target="_blank">an alternative solution</a> by <a href="https://twitter.com/gaasedelen" target="_blank">@gaasedelen</a> to use the number of executed instructions as a side-channel. Recently during an engagement I used <a href="https://software.intel.com/en-us/articles/pintool" target="_blank">Pintool</a> to do <code>[redacted]</code>. Now that I have a bit of time, I decided to use the idea to write such a tool.</p>

<p>As an example, we will use a C program that checks input for a hardcoded value using <code>strncmp</code>. We want to see if it&rsquo;s vulnerable to this side-channel (number of executed instructions).</p>

<p>##My Setup
I will be using a Kali 32-bit VM using VirtualBox. Installing Pin is as simple as extracting the appropriate distribution in a directory and adding it to path.</p>

<p>###Pintool
Pin is a dynamic binary instrumentation framework by Intel. The default installation contains a good number of examples in <code>/pintool/source/tools/ManualExamples/</code>. If you look at various tutorials on it, most will use instruction count example in <code>inscount0.cpp</code>. I will be simplifying it to suit our needs and do <em>some</em> comments.</p>

<p>Here is the modified code. Let&rsquo;s name it <code>myins.cpp</code> and save it in the ManualExamples directory. Apologies for the legal stuff at the start but I&rsquo;d rather keep them than risk the wrath of open source gods.</p>




    

<figure class="code">
  <figcaption>
  	<span>myins.c</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">/*BEGIN_LEGAL </span>
<span style="color: #586E75">Intel Open Source License </span>

<span style="color: #586E75">Copyright (c) 2002-2014 Intel Corporation. All rights reserved.</span>
<span style="color: #586E75"> </span>
<span style="color: #586E75">Redistribution and use in source and binary forms, with or without</span>
<span style="color: #586E75">modification, are permitted provided that the following conditions are</span>
<span style="color: #586E75">met:</span>

<span style="color: #586E75">Redistributions of source code must retain the above copyright notice,</span>
<span style="color: #586E75">this list of conditions and the following disclaimer.  Redistributions</span>
<span style="color: #586E75">in binary form must reproduce the above copyright notice, this list of</span>
<span style="color: #586E75">conditions and the following disclaimer in the documentation and/or</span>
<span style="color: #586E75">other materials provided with the distribution.  Neither the name of</span>
<span style="color: #586E75">the Intel Corporation nor the names of its contributors may be used to</span>
<span style="color: #586E75">endorse or promote products derived from this software without</span>
<span style="color: #586E75">specific prior written permission.</span>
<span style="color: #586E75"> </span>
<span style="color: #586E75">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span style="color: #586E75">``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span style="color: #586E75">LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span style="color: #586E75">A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE INTEL OR</span>
<span style="color: #586E75">ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span style="color: #586E75">SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span style="color: #586E75">LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span style="color: #586E75">DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span style="color: #586E75">THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span style="color: #586E75">(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span style="color: #586E75">OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span style="color: #586E75">END_LEGAL */</span>
<span style="color: #719e07">#include &lt;iostream&gt;</span>
<span style="color: #719e07">#include &quot;pin.H&quot;</span>

<span style="color: #586E75">// modified version of /pintool/source/tools/ManualExamples/inscount0.cpp</span>


<span style="color: #586E75">// The running count of instructions is kept here</span>
<span style="color: #586E75">// make it static to help the compiler optimize docount</span>
<span style="color: #719e07">static</span> <span style="color: #93A1A1">UINT64</span> <span style="color: #93A1A1">icount</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span>

<span style="color: #586E75">// This function is called before every instruction is executed</span>
<span style="color: #586E75">// increase the count every time it is called, which is before every instruction</span>
<span style="color: #93A1A1">VOID</span> <span style="color: #268BD2">docount</span><span style="color: #93A1A1">()</span> <span style="color: #93A1A1">{</span> <span style="color: #93A1A1">icount</span><span style="color: #719e07">++</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">}</span>
    
<span style="color: #586E75">// Pin calls this function every time a new instruction is encountered</span>
<span style="color: #93A1A1">VOID</span> <span style="color: #268BD2">Instruction</span><span style="color: #93A1A1">(INS</span> <span style="color: #93A1A1">ins,</span> <span style="color: #93A1A1">VOID</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">v)</span>
<span style="color: #93A1A1">{</span>
    <span style="color: #586E75">// Insert a call to docount before every instruction, no arguments are passed</span>
    <span style="color: #586E75">// ins: instruction about to be executed</span>
    <span style="color: #586E75">// IPOINT_BEFORE: call is placed before each instruction</span>
    <span style="color: #586E75">// (AFUNPTR)docount: name of the function to call before every instruction</span>
    <span style="color: #586E75">// If any arguments are to be passed to the called function, they will be placed here</span>
    <span style="color: #586E75">// IARG_END: indicates the end of arguments</span>
    
    <span style="color: #586E75">// as a result before each instruction, docount is called</span>
    <span style="color: #93A1A1">INS_InsertCall(ins,</span> <span style="color: #93A1A1">IPOINT_BEFORE,</span> <span style="color: #93A1A1">(AFUNPTR)docount,</span> <span style="color: #93A1A1">IARG_END);</span>
<span style="color: #93A1A1">}</span>

<span style="color: #586E75">// This function is called when the application exits</span>
<span style="color: #93A1A1">VOID</span> <span style="color: #268BD2">Fini</span><span style="color: #93A1A1">(INT32</span> <span style="color: #93A1A1">code,</span> <span style="color: #93A1A1">VOID</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">v)</span>
<span style="color: #93A1A1">{</span>
    <span style="color: #586E75">// print the number of executed instructions</span>
    <span style="color: #93A1A1">cout</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #2AA198">&quot;Count: &quot;</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #93A1A1">icount</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #93A1A1">endl;</span>

<span style="color: #93A1A1">}</span>

<span style="color: #586E75">/* ===================================================================== */</span>
<span style="color: #586E75">/* Print Help Message                                                    */</span>
<span style="color: #586E75">/* ===================================================================== */</span>

<span style="color: #93A1A1">INT32</span> <span style="color: #268BD2">Usage</span><span style="color: #93A1A1">()</span>
<span style="color: #93A1A1">{</span>
    <span style="color: #93A1A1">cout</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #2AA198">&quot;This tool counts the number of dynamic instructions executed&quot;</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #93A1A1">endl;</span>
    <span style="color: #719e07">return</span> <span style="color: #719e07">-</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">}</span>

<span style="color: #586E75">/* ===================================================================== */</span>
<span style="color: #586E75">/* Main                                                                  */</span>
<span style="color: #586E75">/* ===================================================================== */</span>
<span style="color: #586E75">/*   argc, argv are the entire command line: pin -t &lt;toolname&gt; -- ...    */</span>
<span style="color: #586E75">/* ===================================================================== */</span>

<span style="color: #DC322F">int</span> <span style="color: #268BD2">main</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">argc,</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">argv[])</span>
<span style="color: #93A1A1">{</span>
    <span style="color: #586E75">// Initialize pin</span>
    <span style="color: #719e07">if</span> <span style="color: #93A1A1">(PIN_Init(argc,</span> <span style="color: #93A1A1">argv))</span> <span style="color: #719e07">return</span> <span style="color: #93A1A1">Usage();</span>

    <span style="color: #586E75">// Register Instruction to be called to instrument instructions</span>
    <span style="color: #93A1A1">INS_AddInstrumentFunction(Instruction,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">);</span>

    <span style="color: #586E75">// Register Fini to be called when the application exits</span>
    <span style="color: #93A1A1">PIN_AddFiniFunction(Fini,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">);</span>
    
    <span style="color: #586E75">// Start the program, never returns</span>
    <span style="color: #93A1A1">PIN_StartProgram();</span>
    
    <span style="color: #719e07">return</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>To compile it, we can use the provided makefile. In ManualExamples run <code>make obj-ia32/myins.so</code>. Note the filename and path. If everything works correctly, we will have <code>myins.so</code>. Let&rsquo;s copy it to where we want to write our example program.</p>

<h3 id="crackme-1-example-c-program:9d811092ed4116aee3518f2598b86e0b">Crackme 1 - Example C Program</h3>

<p>The program is quite simple, it checks the first argument against the hardcoded value <code>7bc3a60fbf38e98f6fef654afa26d270</code>. We will use this program to test our Pin tool.



    

<figure class="code">
  <figcaption>
  	<span>crkme1.c</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">#include &lt;stdio.h&gt;</span>
<span style="color: #719e07">#include &lt;string.h&gt;</span>

<span style="color: #DC322F">int</span> <span style="color: #268BD2">main</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">argc,</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">argv)</span>
<span style="color: #93A1A1">{</span>

  <span style="color: #719e07">if</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">argc</span><span style="color: #719e07">!=</span><span style="color: #2AA198">2</span> <span style="color: #93A1A1">)</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #93A1A1">printf(</span><span style="color: #2AA198">&quot;usage: ./crkme1 code</span><span style="color: #CB4B16">\n</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">);</span>
    <span style="color: #719e07">return</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">;</span>
  <span style="color: #93A1A1">}</span>
  
  <span style="color: #DC322F">char</span> <span style="color: #93A1A1">code[]</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;7bc3a60fbf38e98f6fef654afa26d270&quot;</span><span style="color: #93A1A1">;</span>
  
  <span style="color: #719e07">if</span> <span style="color: #93A1A1">(</span> <span style="color: #719e07">!</span><span style="color: #93A1A1">strncmp(argv[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">],code,</span><span style="color: #2AA198">32</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">)</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #93A1A1">printf(</span><span style="color: #2AA198">&quot;Correct</span><span style="color: #CB4B16">\n</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">);</span>
  <span style="color: #93A1A1">}</span>
  <span style="color: #719e07">else</span>
  <span style="color: #93A1A1">{</span>
    <span style="color: #93A1A1">printf(</span><span style="color: #2AA198">&quot;Wrong</span><span style="color: #CB4B16">\n</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">);</span>
  <span style="color: #93A1A1">}</span>

  <span style="color: #719e07">return</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Remember to use the <code>ggdb</code> option to compile with debug information (for GDB). From what I understand this is very similar to the <code>g</code> option. We will be using GDB to dive into the binary to observe strncmp&rsquo;s behavior. Let&rsquo;s use <code>gcc -ggdb -o crkme1 crkme1.c</code>.</p>

<h3 id="using-pin-with-crkme1:9d811092ed4116aee3518f2598b86e0b">Using Pin with Crkme1</h3>

<p>To run our Pin tool against any executable execute <code>pin -t myins.so -- ./crkme1 012345</code>. Now let&rsquo;s experiment with some input. Our super secret code starts with <code>7b</code> so I will be <code>fuzzing</code> (for very simplistic definition of fuzzing) the first character and look at the number of executed instructions.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Changing first character</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 1zzz
Wrong
Count: 100013
<span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 5zzz
Wrong
Count: 100013
<span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 7zzz
Wrong
Count: <span style="color: #2AA198">100015</span> <span style="color: #586E75"># interesting</span>
<span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 bzzz
Wrong
Count: 100013
<span style="color: #268BD2">$pin</span> -t myins.so -- ./crkme1 @zzz
Wrong
Count: 100013
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Notice a pattern? Seems like we executed two extra instructions when our first character matched. Assuming our theory is correct and we have the first character <code>7</code>, let&rsquo;s experiment with the second character.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Changing second character</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 71zz
Wrong
Count: 100015
<span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 75zz
Wrong
Count: 100015
<span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 7bzz
Wrong
Count: <span style="color: #2AA198">100017</span> <span style="color: #586E75"># 2 extra instructions executed</span>
<span style="color: #268BD2">$ </span>pin -t myins.so -- ./crkme1 7@zz
Wrong
Count: 100015
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>At this point you probably have a good idea why this is happening. But let&rsquo;s look at the assembly code.</p>

<h3 id="gdb-and-strncmp:9d811092ed4116aee3518f2598b86e0b">GDB and strncmp</h3>

<p>Good thing we compiled our binary with debug information. Let&rsquo;s look at the assembly code for strncmp:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Running crkme1 in gdb</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75"># q starts gdb in quiet mode</span>
<span style="color: #268BD2">$ </span>gdb ./crkme1 -q
Reading symbols from /root/Desktop/kek/crkme1...done.
<span style="color: #586E75"># putting a break on strncmp, this is possible because we compiled with -ggdb option</span>
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> <span style="color: #B58900">break </span>strncmp
Breakpoint <span style="color: #2AA198">1</span> at 0x8048350
<span style="color: #586E75"># passing 7bzz as a run-time argument. r stands for run</span>
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> r 7bzz
Starting program: /root/Desktop/kek/crkme1 7bzz

Breakpoint 1, 0xb7f82b80 in ?? <span style="color: #719e07">()</span> from /lib/i386-linux-gnu/i686/cmov/libc.so.6
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> disass
No <span style="color: #719e07">function</span> contains program counter <span style="color: #719e07">for</span> selected frame.
<span style="color: #586E75"># oops what happened here?</span>
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>To get a better a picture of the problem, we&rsquo;re going to go through the same process in verbose mode in GDB using the <code>set verbose on</code> command.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Running in gdb with verbose on</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$ </span>gdb ./crkme1 -q
Reading symbols from /root/Desktop/kek/crkme1...done.
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> <span style="color: #B58900">set </span>verbose on
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> <span style="color: #B58900">break </span>strncmp
Breakpoint <span style="color: #2AA198">1</span> at 0x8048350
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> r 7bzz
Starting program: /root/Desktop/kek/crkme1 7bzz
Reading symbols from /lib/ld-linux.so.2...<span style="color: #719e07">(</span>no debugging symbols found<span style="color: #719e07">)</span>...done.
Loaded symbols <span style="color: #719e07">for</span> /lib/ld-linux.so.2
Reading symbols from system-supplied DSO at 0xb7fe1000...<span style="color: #719e07">(</span>no debugging symbols found<span style="color: #719e07">)</span>...done.
<span style="color: #586E75"># aha, no debugging symbols found for libc6</span>
Reading symbols from /lib/i386-linux-gnu/i686/cmov/libc.so.6...<span style="color: #719e07">(</span>no debugging symbols found<span style="color: #719e07">)</span>...done.
Loaded symbols <span style="color: #719e07">for</span> /lib/i386-linux-gnu/i686/cmov/libc.so.6

Breakpoint 1, 0xb7f82b80 in ?? <span style="color: #719e07">()</span> from /lib/i386-linux-gnu/i686/cmov/libc.so.6
<span style="color: #719e07">(</span>gdb<span style="color: #719e07">)</span> disass
No <span style="color: #719e07">function</span> contains program counter <span style="color: #719e07">for</span> selected frame.
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>According to line 12, we we need the debugging symbols for libc to look inside the code.
On Kali use <code>apt-get install libc6-dbg</code>. Here we go again:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>After installing libc6-dbg</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">root@kali:~/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek#</span> <span style="color: #268BD2">gdb</span> <span style="color: #268BD2">.</span><span style="color: #719e07">/</span><span style="color: #268BD2">crkme1</span> <span style="color: #719e07">-</span><span style="color: #268BD2">q</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">root</span><span style="color: #719e07">/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek</span><span style="color: #719e07">/</span><span style="color: #268BD2">crkme1...done.</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">break</span> <span style="color: #268BD2">strncmp</span>
<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">1</span> <span style="color: #268BD2">at</span> <span style="color: #2AA198">0x8048350</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">r</span> <span style="color: #2AA198">7</span><span style="color: #268BD2">bzz</span>
<span style="color: #268BD2">Starting</span> <span style="color: #268BD2">program</span><span style="color: #93A1A1">:</span> <span style="color: #719e07">/</span><span style="color: #268BD2">root</span><span style="color: #719e07">/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek</span><span style="color: #719e07">/</span><span style="color: #268BD2">crkme1</span> <span style="color: #2AA198">7</span><span style="color: #268BD2">bzz</span>

<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">__strncmp_ssse3</span> <span style="color: #93A1A1">()</span>
    <span style="color: #268BD2">at</span> <span style="color: #268BD2">..</span><span style="color: #719e07">/</span><span style="color: #268BD2">sysdeps</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">multiarch</span><span style="color: #719e07">/</span><span style="color: #268BD2">strcmp</span><span style="color: #719e07">-</span><span style="color: #B58900">ss</span><span style="color: #268BD2">se3.S</span><span style="color: #93A1A1">:</span><span style="color: #2AA198">65</span>
<span style="color: #93A1A1">65</span>	<span style="color: #268BD2">..</span><span style="color: #719e07">/</span><span style="color: #268BD2">sysdeps</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">multiarch</span><span style="color: #719e07">/</span><span style="color: #268BD2">strcmp</span><span style="color: #719e07">-</span><span style="color: #B58900">ss</span><span style="color: #268BD2">se3.S</span><span style="color: #93A1A1">:</span> <span style="color: #268BD2">No</span> <span style="color: #268BD2">such</span> <span style="color: #268BD2">file</span> <span style="color: #268BD2">or</span> <span style="color: #B58900">di</span><span style="color: #268BD2">rectory.</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #B58900">di</span><span style="color: #268BD2">sass</span>
<span style="color: #268BD2">Dump</span> <span style="color: #268BD2">of</span> <span style="color: #268BD2">assembler</span> <span style="color: #268BD2">code</span> <span style="color: #268BD2">for</span> <span style="color: #268BD2">function</span> <span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">=&gt;</span> <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b80</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">0</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">push</span>   <span style="color: #B58900">ebp</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b81</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">1</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b85</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">5</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b89</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">9</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b8d</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">13</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x10</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b90</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">16</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">jb</span>     <span style="color: #2AA198">0xb7f843d0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6224</span><span style="color: #719e07">&gt;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Now we can see what happens in strncmp. The following is the cleaned up version of the assembly of strncmp.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>strncmp</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">; assuming we called strncmp (argv[1],code,32);</span>

<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b80</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">0</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">push</span>   <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b81</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">1</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span> 	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">]</span>  <span style="color: #586E75">; argv[1] or &quot;7bzz&quot;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b85</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">5</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span> 	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">]</span>  <span style="color: #586E75">; code or &quot;7bc3 ..&quot;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b89</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">9</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span> 	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span> <span style="color: #586E75">; 32 or 0x20</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b8d</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">13</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span> 	<span style="color: #268BD2">cmp</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x10</span>                 <span style="color: #586E75">; 32 compared to 0x10 (16 decimal)</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f82b90</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">16</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span> 	<span style="color: #268BD2">jb</span>     <span style="color: #2AA198">0xb7f843d0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6224</span><span style="color: #719e07">&gt;</span>
<span style="color: #268BD2">...</span>
<span style="color: #586E75">; if number of bytes to compare is bigger than 16</span>
<span style="color: #586E75">; let&#39;s assume it is not and see what happens next</span>
<span style="color: #268BD2">...</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843d0</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6224</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">test</span>   <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #B58900">ebp</span>  <span style="color: #586E75">; if (ebp == 0) goto 0xb7f843c3</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843d2</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6226</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6211</span><span style="color: #719e07">&gt;</span> 
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843d4</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6228</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">movzx</span>  <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">BYTE</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">eax</span><span style="color: #93A1A1">]</span> <span style="color: #586E75">; ecx = code</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843d7</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6231</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #DC322F">BYTE</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edx</span><span style="color: #93A1A1">],</span><span style="color: #B58900">cl</span>  <span style="color: #586E75">; if (code[0] != argv[1][0]) goto 0xb7f843b0;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843d9</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6233</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">jne</span>    <span style="color: #2AA198">0xb7f843b0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6192</span><span style="color: #719e07">&gt;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843db</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6235</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">test</span>   <span style="color: #B58900">cl</span><span style="color: #93A1A1">,</span><span style="color: #B58900">cl</span>  <span style="color: #586E75">; if (code[0] == 0) goto 0xb7f843c3; // have we reached the end of code?</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843dd</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6237</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6211</span><span style="color: #719e07">&gt;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843df</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6239</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x1</span>  <span style="color: #586E75">; if (counter == 1) goto 0xb7f843c3; // was this our last compare?</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843e2</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6242</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6211</span><span style="color: #719e07">&gt;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843e4</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6244</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">movzx</span>  <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">BYTE</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">eax</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x1</span><span style="color: #93A1A1">]</span>	<span style="color: #586E75">; ecx = code[1];</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843e8</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6248</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #DC322F">BYTE</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edx</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x1</span><span style="color: #93A1A1">],</span><span style="color: #B58900">cl</span>  <span style="color: #586E75">; if (code[1] != argv[1][1]) goto 0xb7f843b0;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843eb</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6251</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">jne</span>    <span style="color: #2AA198">0xb7f843b0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6192</span><span style="color: #719e07">&gt;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843ed</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6253</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">test</span>   <span style="color: #B58900">cl</span><span style="color: #93A1A1">,</span><span style="color: #B58900">cl</span>  <span style="color: #586E75">; if (code[1] == 0) goto 0xb7f843c3; // have we reached the end of code?</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843ef</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6255</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6211</span><span style="color: #719e07">&gt;</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843f1</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6257</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x2</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f843f4</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6260</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">6211</span><span style="color: #719e07">&gt;</span>
<span style="color: #268BD2">...</span>
<span style="color: #586E75">; similar byte compares until the end</span>
<span style="color: #268BD2">...</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f8453f</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6591</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">test</span>   <span style="color: #B58900">cl</span><span style="color: #93A1A1">,</span><span style="color: #B58900">cl</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f84541</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6593</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">621</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f84547</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6599</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0xf</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f8454a</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6602</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0xb7f843c3</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">621</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f84550</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6608</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">movzx</span>  <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">BYTE</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">eax</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xf</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f84554</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6612</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #DC322F">BYTE</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edx</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xf</span><span style="color: #93A1A1">],</span><span style="color: #B58900">cl</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f84557</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6615</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">jne</span>    <span style="color: #2AA198">0xb7f843b0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">__strncmp_ssse3</span><span style="color: #719e07">+</span><span style="color: #2AA198">619</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7f8455d</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6621</span><span style="color: #719e07">&gt;</span><span style="color: #586E75">;	test   cl,cl</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can see that the implementation has unrolled the for and compares 16 bytes one by one. If a character is correct, two more instructions are executed (as we saw) which are <code>test   cl,cl</code> and <code>je     0xb7f843c3</code> which basically checks if we have reached the end of first string. Now we know why. Let us build our tool.</p>

<h3 id="pinsolver-mk1:9d811092ed4116aee3518f2598b86e0b">PinSolver Mk1</h3>

<p>I am going to use Python&rsquo;s subprocess module and reuse <a href="http://parsiya.net/blog/2014-05-25-pasting-shellcode-into-gdb-using-python/" target="_blank">some old code</a>. The script simply iterates through all valid characters (note: do not include space or some other special characters). For this example I am going to use alphanumeric characters. Character with the largest number of executed instructions will be chose and we move on to the next character.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>pinsolvermk1.py</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">#!/usr/bin/python</span>

<span style="color: #719e07">from</span> <span style="color: #93A1A1">subprocess</span> <span style="color: #719e07">import</span> <span style="color: #93A1A1">Popen,</span> <span style="color: #93A1A1">PIPE</span>

<span style="color: #586E75"># create a set of alphanumeric chars</span>
<span style="color: #93A1A1">alphanumeric</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;0123456789&quot;</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>

<span style="color: #93A1A1">solution</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">[]</span>

<span style="color: #93A1A1">flag</span> <span style="color: #719e07">=</span> <span style="color: #268BD2">False</span>

<span style="color: #719e07">while</span> <span style="color: #93A1A1">(</span><span style="color: #268BD2">True</span><span style="color: #93A1A1">):</span>

  <span style="color: #93A1A1">maxcount</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span>
  <span style="color: #93A1A1">candidate_char</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span>

  <span style="color: #719e07">for</span> <span style="color: #93A1A1">char</span> <span style="color: #719e07">in</span> <span style="color: #93A1A1">alphanumeric:</span>
    <span style="color: #586E75"># construct</span>
    <span style="color: #93A1A1">fez</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #719e07">.</span><span style="color: #93A1A1">join(solution)</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">char</span>
    <span style="color: #93A1A1">proc</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">Popen([</span><span style="color: #2AA198">&quot;pin&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;-t&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;myins.so&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;--&quot;</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">&quot;./crkme1&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">fez],</span> <span style="color: #93A1A1">stdout</span><span style="color: #719e07">=</span><span style="color: #93A1A1">PIPE,</span> <span style="color: #93A1A1">stderr</span><span style="color: #719e07">=</span><span style="color: #93A1A1">PIPE)</span>
  
    <span style="color: #586E75"># read output and split by lines</span>
    <span style="color: #93A1A1">output</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">proc</span><span style="color: #719e07">.</span><span style="color: #93A1A1">stdout</span><span style="color: #719e07">.</span><span style="color: #93A1A1">read()</span><span style="color: #719e07">.</span><span style="color: #93A1A1">splitlines()</span>
  
    <span style="color: #719e07">if</span> <span style="color: #93A1A1">(output[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">==</span> <span style="color: #2AA198">&quot;Correct&quot;</span><span style="color: #93A1A1">):</span>
      <span style="color: #719e07">print</span> <span style="color: #2AA198">&quot;Code found: &quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #719e07">.</span><span style="color: #93A1A1">join(solution)</span>
      <span style="color: #719e07">break</span>
    <span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
      <span style="color: #93A1A1">count</span> <span style="color: #719e07">=</span> <span style="color: #B58900">int</span> <span style="color: #93A1A1">(output[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">.</span><span style="color: #93A1A1">split(</span><span style="color: #2AA198">&#39; &#39;</span><span style="color: #93A1A1">)[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">])</span>
    
      <span style="color: #719e07">if</span> <span style="color: #93A1A1">(count</span> <span style="color: #719e07">&gt;</span> <span style="color: #93A1A1">maxcount):</span>
        <span style="color: #93A1A1">maxcount</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">count</span>
        <span style="color: #93A1A1">candidate_char</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">char</span>
    
    <span style="color: #586E75"># print (&quot;Trying %s - Count is: %d - Maxcount is: %d - Candidate_char is: %s&quot;) % (fez, count, maxcount, candidate_char)</span>
  
  <span style="color: #586E75"># after a loop has finished, add the chosen char to the solution</span>
  <span style="color: #93A1A1">solution</span><span style="color: #719e07">.</span><span style="color: #93A1A1">append(candidate_char)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Note: If your VM has multiple CPUs this will not work. At this moment I do not know why.</p>

<p>TODO in next chapter:</p>

<ol>
<li>Try to find some simple crackmes2 from CTFs to run this tool on</li>
<li>Find a way to increase pin&rsquo;s performance</li>
<li>Why is the instruction count not calculated correctly occasionally when VM has multiple CPUs?</li>
</ol>

<p>As usual, if there is a any feedback please feel free to comment or contact me on Twitter. My handle is in the side bar &mdash;-&gt;.</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Dec 8, 2014</time>
    <span class="categories">
      Tags: 
        
        
          <a class="category" href="http://parsiya.net/tags/pin">PIN</a>  <a class="category" href="http://parsiya.net/tags/pin-tool">PIN tool</a>  <a class="category" href="http://parsiya.net/tags/pinsolver">PINSolver</a>  
        
    </span>
  </p>
    
  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://parsiya.net/blog/2014-11-18-Building-memfetch-on-Kali--Comments/" title="Building memfetch on Kali &#43; Comments">Building memfetch on Kali &#43; Comments</a>
    

     
      <a class="basic-alignment right" href="http://parsiya.net/blog/2015-01-06-Tales-from-the-Crypto---Leaking-AES-Keys/" title="Tales from the Crypt(o) - Leaking AES Keys">Tales from the Crypt(o) - Leaking AES Keys</a>
    
  </p>

  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'parsiya';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

 
      </article>
    </div>
    


<aside class="sidebar thirds">
  <section class="first odd">
    <h1>Who am I?</h1>
    <p>I am Parsia Hakimian, ex-dev and current (mostly) software security consultant at <a target="_blank" href="http://cigital.com" title="Cigital">Cigital</a>.</p>
    <p>I am interested in Reverse Engineering, Crypto, Assembly, C, Python, EvE Online and other things (not necessarily in that order).</p>
    <p>email: parsiya [at] google’s email [dot]com or use keybase (click on the key icon).</p>

    
  </section>

  



  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
    <a target="_blank" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
    <a target="_blank" href="https://bitbucket.org/parsiya/" title="https://bitbucket.org/parsiya/"><i class="fa fa-bitbucket fa-3x"></i></a>
    
    
    
    
    <a target="_blank" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
    
    <a target="_blank" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-key fa-3x"></i></a> 

    
    
    </li>
  </ul>

  
  <section class="even">
    <h1>Recent Posts</h1>

    <ul id="recent_posts">
      
      <li class="post">
        <a href="/blog/2016-01-31-Why-Hugo/">Why Hugo?</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-11-14-Intro-to-.NET-Remoting-for-Hackers/">Intro to .NET Remoting for Hackers</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-10-19-proxying-hipchat-part-3-ssl-added-and-removed-here/">Proxying Hipchat Part 3: SSL Added and Removed Here :^)</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-10-09-Proxying-Hipchat-Part-2-So-You-Think-You-Can-Use-Burp/">Proxying Hipchat Part 2: So You Think You Can Use Burp?</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-10-08-Proxying-Hipchat-Part-1-Where-did-the-Traffic-Go/">Proxying Hipchat Part 1: Where did the Traffic Go?</a>
      </li>
      
    </ul>
  </section>

</aside>
  </div>
</div>




<footer role="contentinfo">
  <p>Copyright &copy; 2016 Parsia - <a href="http://parsiya.net/license/">License</a> - 
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="insertithere">Hugo-Octopress</a> theme.
</p>

</footer>


<script>
  var _gaq=[['_setAccount','UA-55491306-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

