<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>Tales from the Crypt(o) - Leaking AES Keys</title>

  
  <link rel="stylesheet" href="http://parsiya.net/css/hugo-octopress.css">

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  

  
  <link href="http://parsiya.net/favicon.png" rel="icon">

  
  
  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="[Parsia Hakimian Parsia infosec information security]">

  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.15" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://parsiya.net/">Parsia&#39;s Den</a></h1>
    <h2>Because no one wants to be the other guy from Wham!</h2>
</hgroup></header>


<nav role="navigation">


<ul class="main-navigation">
  
  
    
      <li><a href="http://parsiya.net/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://www.google.com/search?q=andrew&#43;ridgeley" target="_blank" title="The other guy from Wham!">The other guy from Wham!</a></li>
    
  
    
      <li><a href="http://parsiya.net/archive/" target="_blank" title="Archive">Archive</a></li>
    
  
    
      <li><a href="http://parsiya.net/license/" target="_blank" title="License">License</a></li>
    
  
    
      <li><a href="https://www.github.com/parsiya/hugo-octopress" target="_blank" title="This theme on Github">This theme on Github</a></li>
    
  
</ul>


<ul class="subscription">
  <a href="http://parsiya.net/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>

  
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:http://parsiya.net/" />
  </fieldset>
</form>

</nav>



<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">
        <header>
          <h1 class="entry-title">
            Tales from the Crypt(o) - Leaking AES Keys 
          </h1>
          <p class="meta">Jan 6, 2015 - 27 minute read -  <a href="http://parsiya.net/blog/2015-01-06-tales-from-the-crypto---leaking-aes-keys/#disqus_thread">Comments</a>

          

          
          
          <a class="label" href="http://parsiya.net/categories/encryption">Encryption</a><a class="label" href="http://parsiya.net/categories/reverse-engineering">Reverse Engineering</a>
          </p>
        </header>
        <div class="entry-content">
          

<p>This post is part one of a two part internal blog entry on creating a Pintool for an assessment. Unfortunately I cannot talk about it, so I decided to put the first part out. If I find an opensource program similar to the assessment I will try and recreate the tool (but I am not holding my breath). As this part is essentially a build up, it may not be coherent at times. Alterntively, if you really want to read it, you can join us. We are almost always hiring (let me do the referal though ;).</p>

<p>Today we are going to talk about discovering encryption keys in sneaky ways. We will start with simple examples, do a bit of Digital Forensics or DF (for low standards of DF) and finally in part two we will use our recently acquired knowledge of Pintool to do <code>[redacted]</code>.</p>

<p>First let’s talk a bit about the inner-workings of AES decryption. By inner-workings of AES I do not mean the following diagrams that you have seen so many times.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/tales1/CBC-Mode-Wikipedia.jpg" title="These are not the diagrams you are looking for - Source: Wikipedia" alt="These are not the diagrams you are looking for - Source: Wikipedia">
  <span class="caption-text">These are not the diagrams you are looking for - Source: Wikipedia</span>
</span>


<p>Instead I am going to talk about what happens inside those rectangles labeled “block cipher encryption/decryption.” If you don’t want to know about the AES stuff, jump directly to <a href="#aeskeysinaction">2. AES Keys in Action</a>.</p>

<h3 id="1-thinking-inside-the-box:2cbddf826dbc10ef777e4fb8d0b66a21">1. Thinking Inside the Box</h3>

<p>Each of these boxes consist of a few rounds. The number of rounds is based on key size in AES. Keep in mind that AES is a subset of the <em>Rijndael</em> family of ciphers (and I still do not know how to pronounce the name). NIST (National Institute of Standards and Technology) selected a fixed block size (16 bytes) and three different key sizes (128, 192 and 256 bits) and called it AES (Advanced Encryption Standard) because that’s what NIST does (other than allegedly embedding backdoors in <a href="https://www.mail-archive.com/openssl-announce@openssl.org/msg00127.html" target="_blank">almost never used</a> random number generators, see <a href="http://blog.cryptographyengineering.com/2013/09/the-many-flaws-of-dualecdrbg.html" target="_blank">DUAL_EC_DRBG</a> ;)). You do not need to memorize the formula that calculates the number of rounds based on key and block size. You can see the result of my painstaking calculations in the following table:</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%">|
| Key Size (bits)  | Number of Rounds (potatoes) |
|------------------|-----------------------------|
|       128        |             10              |
|       192        |             12              |
|       256        |             14              |
|
</pre></div>

<p>That was easy. So what happens inside each of these rounds. Except the last round, there are four steps in each round (encryption/decryption). For the remainder of this section I am going to assume that we are using a 128-bit key (16 bytes) resulting in 10 rounds.</p>









<span class="caption-wrapper">
  <img class="caption" src="/images/2015/tales1/AES-Rounds.jpg" title="Inside AES - Source: http://www.iis.ee.ethz.ch/~kgf/acacia/fig/aes.png" alt="Inside AES - Source: http://www.iis.ee.ethz.ch/~kgf/acacia/fig/aes.png">
  <span class="caption-text">Inside AES - Source: http://www.iis.ee.ethz.ch/~kgf/acacia/fig/aes.png</span>
</span>


<p>There are four different operations but I am going to go into some detail about <code>AddRoundKey</code>. It is also the only operation which introduces an unknown element (key) into the process. The other operations are also simple and we can probably guess what they do based on their names.</p>

<h4 id="1-1-addroundkey:2cbddf826dbc10ef777e4fb8d0b66a21">1.1 AddRoundKey</h4>

<p>It’s a simple XOR. A 16 byte round key is XOR-ed with the current block. If we count the number of AddRoundKey operations for Nr==10, we get 11. But we only have one 16 byte key and need 16*11 or 176 bytes. <em>“How am I going to create the extra 160 (176-16) bytes Senpai?”</em> one may ask. This is done through some magic known as <code>key expansion</code> which creates bytes out of thin air. It expands the original key into the 176 bytes also known as <code>key schedule</code>.</p>

<h5 id="1-1-1-aes-key-schedule-aka-rijndael-key-schedule:2cbddf826dbc10ef777e4fb8d0b66a21">1.1.1 AES Key Schedule (aka Rijndael Key Schedule)</h5>

<p>The key expansion algorithm takes the original key and returns the key schedule. I could talk about the boring details of it but you are already bored and I am lazy. Search for Rijndael Key Schedule if you want to know more. Instead we are going to talk about some interesting stuff.</p>

<p>Don’t make the convenient mistake of thinking of the key schedule as a Pseudo-Random Number Generator (PRNG) where we enter the original key as the seed and then reap bytes. In a good PRNG, we should not be able to discover the seed by observing the output. In the Rijndael/AES key schedule there is direct correlation between the original key and each round key.</p>

<p>In AES-128, knowing a single round key (regardless of round number) is enough to generate the original key. In AES-256 we need to know two consecutive round keys and that is a good thing for AES-256. If not, the schedule had reduced the entropy of a 256-bit key to 128 bits. In a lot of hardware (a.k.a limited on-board memory), the first (actual encryption key) and last round keys (first two and last two round keys for AES-256) are stored for encryption/decryption and the rest are generated when needed from them.</p>

<p>Also by looking at the key schedule, we can see that the original AES key is copied directly to the start of the key schedule. In other words, the first 128 bits (16 bytes) of the AES-128 key schedule are the same as the original key.</p>

<h5 id="1-1-2-round-key-usage:2cbddf826dbc10ef777e4fb8d0b66a21">1.1.2 Round Key Usage</h5>

<p>Great, so we have 16 bytes that are XOR-ed with something in each round. For decryption, we can create the key schedule and inverse it. This works because XOR is transitive (i.e. If ciphertext = plaintext XOR key then plaintext = ciphertext XOR key).</p>

<p>Notice the first AddRoundKey block in both encryption and decryption. In encryption this is first 16 bytes of the original key (or the whole key in case of AES-128). In decryption, this is the last round key. Keep this in mind, we are going to use it later.</p>

<h3 id="2-a-name-aeskeysinaction-a-aes-keys-in-action:2cbddf826dbc10ef777e4fb8d0b66a21">2. <a name="aeskeysinaction"></a> AES Keys in Action</h3>

<p>By now we know how AES keys are used. Let’s do some stuff. We’re going to use the same set up as last time. A Kali 32-bit VM running in VirtualBox.</p>

<h4 id="2-1-function-calls:2cbddf826dbc10ef777e4fb8d0b66a21">2.1 Function Calls</h4>

<p>External function calls leak information. I am going to divide them into two parts <code>System Calls</code> (syscalls) and <code>Library Calls</code>. Basically these are functions that you can call and use in your program. If these functions part of the Operating System they are System Calls and if they are provided by a 3rd party library (shared library, DLL etc) they are Library Calls. For an excellent description of system calls, read the blog post by Gustavo Duartes named [System Calls Make the World Go Round]() (also read the rest of his blog).</p>

<h5 id="2-1-1-openssl-example:2cbddf826dbc10ef777e4fb8d0b66a21">2.1.1 OpenSSL Example</h5>

<p>Our example will be a simple Encryption/Decryption program in C using OpenSSL modified from [​<a href="http://wiki.openssl.org/index.php/EVP_Symmetric_Encryption_and_Decryption" target="_blank">http://wiki.openssl.org/index.php/EVP_Symmetric_Encryption_and_Decryption</a>. It will encrypt and decrypt the string “The quick brown fox jumps over the lazy dog” with AES using the 256 bit (32 byte) key <code>ee12c03ceacdfb5d4c0e67c8f5ab3362</code> and IV <code>d36a4bf2e6dd9c68</code> (128 bits or 16 bytes). My comments start with <code>///</code>.</p>




    

<figure class="code">
  <figcaption>
  	<span>AES-OpenSSL.cpp</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07">#include</span> <span style="color: #586E75">&lt;openssl/conf.h&gt;</span><span style="color: #719e07"></span>
<span style="color: #719e07">#include</span> <span style="color: #586E75">&lt;openssl/evp.h&gt;</span><span style="color: #719e07"></span>
<span style="color: #719e07">#include</span> <span style="color: #586E75">&lt;openssl/err.h&gt;</span><span style="color: #719e07"></span>
<span style="color: #719e07">#include</span> <span style="color: #586E75">&lt;string.h&gt;</span><span style="color: #719e07"></span>

<span style="color: #586E75">/// Code from OpenSSL Wiki at http://wiki.openssl.org/index.php/EVP_Symmetric_Encryption_and_Decryption</span>
<span style="color: #586E75">/// Needs libssl-dev (e.g. sudo apt-get install libssl-dev )</span>
<span style="color: #586E75">/// Compile with gcc [filename].c -o [outputfile] -lcrypto -ggdb</span>

<span style="color: #DC322F">void</span> <span style="color: #268BD2">handleErrors</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">void</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #93A1A1">ERR_print_errors_fp(stderr);</span>
  <span style="color: #93A1A1">abort();</span>
<span style="color: #93A1A1">}</span>

<span style="color: #DC322F">int</span> <span style="color: #268BD2">encrypt</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">plaintext,</span> <span style="color: #DC322F">int</span> <span style="color: #93A1A1">plaintext_len,</span> <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">key,</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">iv,</span> <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">ciphertext)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #93A1A1">EVP_CIPHER_CTX</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">ctx;</span>
  <span style="color: #DC322F">int</span> <span style="color: #93A1A1">len;</span>
  <span style="color: #DC322F">int</span> <span style="color: #93A1A1">ciphertext_len;</span>

  <span style="color: #586E75">/* Create and initialise the context */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #719e07">!</span><span style="color: #93A1A1">(ctx</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">EVP_CIPHER_CTX_new()))</span> <span style="color: #93A1A1">handleErrors();</span>

  <span style="color: #586E75">/* Initialise the encryption operation. IMPORTANT - ensure you use a key</span>
<span style="color: #586E75">   * and IV size appropriate for your cipher</span>
<span style="color: #586E75">   * In this example we are using 256 bit AES (i.e. a 256 bit key). The</span>
<span style="color: #586E75">   * IV size for *most* modes is the same as the block size. For AES this</span>
<span style="color: #586E75">   * is 128 bits */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #719e07">!=</span> <span style="color: #93A1A1">EVP_EncryptInit_ex(ctx,</span> <span style="color: #93A1A1">EVP_aes_256_cbc(),</span> <span style="color: #B58900">NULL</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">key,</span> <span style="color: #93A1A1">iv))</span>  <span style="color: #93A1A1">handleErrors();</span>

  <span style="color: #586E75">/* Provide the message to be encrypted, and obtain the encrypted output.</span>
<span style="color: #586E75">   * EVP_EncryptUpdate can be called multiple times if necessary</span>
<span style="color: #586E75">   */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #719e07">!=</span> <span style="color: #93A1A1">EVP_EncryptUpdate(ctx,</span> <span style="color: #93A1A1">ciphertext,</span> <span style="color: #719e07">&amp;</span><span style="color: #93A1A1">len,</span> <span style="color: #93A1A1">plaintext,</span> <span style="color: #93A1A1">plaintext_len))</span> <span style="color: #93A1A1">handleErrors();</span>
  <span style="color: #93A1A1">ciphertext_len</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">len;</span>

  <span style="color: #586E75">/* Finalise the encryption. Further ciphertext bytes may be written at</span>
<span style="color: #586E75">   * this stage.</span>
<span style="color: #586E75">   */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #719e07">!=</span> <span style="color: #93A1A1">EVP_EncryptFinal_ex(ctx,</span> <span style="color: #93A1A1">ciphertext</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">len,</span> <span style="color: #719e07">&amp;</span><span style="color: #93A1A1">len))</span> <span style="color: #93A1A1">handleErrors();</span>
  <span style="color: #93A1A1">ciphertext_len</span> <span style="color: #719e07">+=</span> <span style="color: #93A1A1">len;</span>

  <span style="color: #586E75">/* Clean up */</span>
  <span style="color: #93A1A1">EVP_CIPHER_CTX_free(ctx);</span>

  <span style="color: #719e07">return</span> <span style="color: #93A1A1">ciphertext_len;</span>
<span style="color: #93A1A1">}</span>

<span style="color: #DC322F">int</span> <span style="color: #268BD2">decrypt</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">ciphertext,</span> <span style="color: #DC322F">int</span> <span style="color: #93A1A1">ciphertext_len,</span> <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">key,</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">iv,</span> <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">plaintext)</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #93A1A1">EVP_CIPHER_CTX</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">ctx;</span>
  <span style="color: #DC322F">int</span> <span style="color: #93A1A1">len;</span>
  <span style="color: #DC322F">int</span> <span style="color: #93A1A1">plaintext_len;</span>

  <span style="color: #586E75">/* Create and initialise the context */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #719e07">!</span><span style="color: #93A1A1">(ctx</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">EVP_CIPHER_CTX_new()))</span> <span style="color: #93A1A1">handleErrors();</span>

  <span style="color: #586E75">/* Initialise the decryption operation. IMPORTANT - ensure you use a key</span>
<span style="color: #586E75">   * and IV size appropriate for your cipher</span>
<span style="color: #586E75">   * In this example we are using 256 bit AES (i.e. a 256 bit key). The</span>
<span style="color: #586E75">   * IV size for *most* modes is the same as the block size. For AES this</span>
<span style="color: #586E75">   * is 128 bits */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #719e07">!=</span> <span style="color: #93A1A1">EVP_DecryptInit_ex(ctx,</span> <span style="color: #93A1A1">EVP_aes_256_cbc(),</span> <span style="color: #B58900">NULL</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">key,</span> <span style="color: #93A1A1">iv))</span>  <span style="color: #93A1A1">handleErrors();</span>
  
  <span style="color: #586E75">/* Provide the message to be decrypted, and obtain the plaintext output.</span>
<span style="color: #586E75">   * EVP_DecryptUpdate can be called multiple times if necessary</span>
<span style="color: #586E75">   */</span>
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #719e07">!=</span> <span style="color: #93A1A1">EVP_DecryptUpdate(ctx,</span> <span style="color: #93A1A1">plaintext,</span> <span style="color: #719e07">&amp;</span><span style="color: #93A1A1">len,</span> <span style="color: #93A1A1">ciphertext,</span> <span style="color: #93A1A1">ciphertext_len))</span>  <span style="color: #93A1A1">handleErrors();</span>
  <span style="color: #93A1A1">plaintext_len</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">len;</span>

  <span style="color: #586E75">/* Finalise the decryption. Further plaintext bytes may be written at</span>
<span style="color: #586E75">   * this stage.</span>
<span style="color: #586E75">   */</span>
 
  <span style="color: #719e07">if</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span> <span style="color: #719e07">!=</span> <span style="color: #93A1A1">EVP_DecryptFinal_ex(ctx,</span> <span style="color: #93A1A1">plaintext</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">len,</span> <span style="color: #719e07">&amp;</span><span style="color: #93A1A1">len))</span> <span style="color: #93A1A1">handleErrors();</span>
  <span style="color: #93A1A1">plaintext_len</span> <span style="color: #719e07">+=</span> <span style="color: #93A1A1">len;</span>

  <span style="color: #586E75">/* Clean up */</span>
  <span style="color: #93A1A1">EVP_CIPHER_CTX_free(ctx);</span>

  <span style="color: #719e07">return</span> <span style="color: #93A1A1">plaintext_len;</span>
<span style="color: #93A1A1">}</span>

<span style="color: #DC322F">int</span> <span style="color: #268BD2">main</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">int</span> <span style="color: #93A1A1">arc,</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">argv[])</span>
<span style="color: #93A1A1">{</span>
  <span style="color: #586E75">/* Set up the key and iv. Do I need to say to not hard code these in a</span>
<span style="color: #586E75">   * real application? :-)</span>
<span style="color: #586E75">   */</span>

  <span style="color: #586E75">/* A 256 bit key */</span>
  <span style="color: #586E75">/// unsigned char *key = &quot;01234567890123456789012345678901&quot;;</span>
  
  <span style="color: #586E75">/// this is still a 256-bit (32 byte) key, each character is treated as one byte</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">key</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;ee12c03ceacdfb5d4c0e67c8f5ab3362&quot;</span><span style="color: #93A1A1">;</span>

  <span style="color: #586E75">/* A 128 bit IV */</span>
  <span style="color: #586E75">/// unsigned char *iv = &quot;01234567890123456&quot;;</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">iv</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;d36a4bf2e6dd9c68&quot;</span><span style="color: #93A1A1">;</span>

  <span style="color: #586E75">/* Message to be encrypted */</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">plaintext</span> <span style="color: #719e07">=</span>
    <span style="color: #2AA198">&quot;The quick brown fox jumps over the lazy dog&quot;</span><span style="color: #93A1A1">;</span>

  <span style="color: #586E75">/* Buffer for ciphertext. Ensure the buffer is long enough for the</span>
<span style="color: #586E75">   * ciphertext which may be longer than the plaintext, dependant on the</span>
<span style="color: #586E75">   * algorithm and mode</span>
<span style="color: #586E75">   */</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #93A1A1">ciphertext[</span><span style="color: #2AA198">128</span><span style="color: #93A1A1">];</span>

  <span style="color: #586E75">/* Buffer for the decrypted text */</span>
  <span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #93A1A1">decryptedtext[</span><span style="color: #2AA198">128</span><span style="color: #93A1A1">];</span>

  <span style="color: #DC322F">int</span> <span style="color: #93A1A1">decryptedtext_len,</span> <span style="color: #93A1A1">ciphertext_len;</span>

  <span style="color: #586E75">/* Initialise the library */</span>
  <span style="color: #93A1A1">ERR_load_crypto_strings();</span>
  <span style="color: #93A1A1">OpenSSL_add_all_algorithms();</span>
  <span style="color: #93A1A1">OPENSSL_config(</span><span style="color: #B58900">NULL</span><span style="color: #93A1A1">);</span>

  <span style="color: #586E75">/* Encrypt the plaintext */</span>
  <span style="color: #93A1A1">ciphertext_len</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">encrypt(plaintext,</span> <span style="color: #93A1A1">strlen(plaintext),</span> <span style="color: #93A1A1">key,</span> <span style="color: #93A1A1">iv,</span> <span style="color: #93A1A1">ciphertext);</span>

  <span style="color: #586E75">/* Do something useful with the ciphertext here */</span>
  <span style="color: #93A1A1">printf(</span><span style="color: #2AA198">&quot;Ciphertext is:</span><span style="color: #CB4B16">\n</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">);</span>
  <span style="color: #93A1A1">BIO_dump_fp(stdout,</span> <span style="color: #93A1A1">ciphertext,</span> <span style="color: #93A1A1">ciphertext_len);</span>

  <span style="color: #586E75">/* Decrypt the ciphertext */</span>
  <span style="color: #93A1A1">decryptedtext_len</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">decrypt(ciphertext,</span> <span style="color: #93A1A1">ciphertext_len,</span> <span style="color: #93A1A1">key,</span> <span style="color: #93A1A1">iv,</span> <span style="color: #93A1A1">decryptedtext);</span>

  <span style="color: #586E75">/* Add a NULL terminator. We are expecting printable text */</span>
  <span style="color: #93A1A1">decryptedtext[decryptedtext_len]</span> <span style="color: #719e07">=</span> <span style="color: #93A1A1">&#39;&#39;;</span>

  <span style="color: #586E75">/* Show the decrypted text */</span>
  <span style="color: #93A1A1">printf(</span><span style="color: #2AA198">&quot;Decrypted text is:</span><span style="color: #CB4B16">\n</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">);</span>
  <span style="color: #93A1A1">printf(</span><span style="color: #2AA198">&quot;%s</span><span style="color: #CB4B16">\n</span><span style="color: #2AA198">&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">decryptedtext);</span>

  <span style="color: #586E75">/* Clean up */</span>
  <span style="color: #93A1A1">EVP_cleanup();</span>
  <span style="color: #93A1A1">ERR_free_strings();</span>

  <span style="color: #719e07">return</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>we need the <code>libssl-dev</code> library which can be installed by <code>sudo apt-get install libssl-dev</code>. To compile use <code>gcc [filename].c -o [outputfile] -lcrypto -ggdb</code>. We will use the debug information in GDB later. Here is the output:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>output</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">$ gcc AES-OpenSSL.c -ggdb -lcrypto -o sampleaes
$ ./sampleaes
Ciphertext is:
<span style="color: #2AA198">0000</span> - <span style="color: #2AA198">51</span> <span style="color: #2AA198">34</span> 3f <span style="color: #2AA198">21</span> <span style="color: #2AA198">87</span> 5d 4e f6-18 1d c6 6d <span style="color: #2AA198">41</span> c1 <span style="color: #2AA198">12</span> ae   Q4?!.<span style="color: #719e07">]</span>N....mA...
<span style="color: #2AA198">0010</span> - e0 a7 de a0 fa b9 6c b0-91 5e <span style="color: #2AA198">21</span> c6 d3 <span style="color: #2AA198">90</span> <span style="color: #2AA198">96</span> <span style="color: #2AA198">36</span>   ......l..^!....6
<span style="color: #2AA198">0020</span> - <span style="color: #2AA198">70</span> 7b ec <span style="color: #2AA198">69</span> <span style="color: #2AA198">89</span> e1 bc 0a-2c <span style="color: #2AA198">61</span> f4 c6 <span style="color: #2AA198">26</span> <span style="color: #2AA198">61</span> 5f 2e   p<span style="color: #719e07">{</span>.i....,a..<span style="color: #93A1A1">&amp;</span>a_.
Decrypted text is:
The quick brown fox jumps over the lazy dog
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="2-2-monitoring-library-calls:2cbddf826dbc10ef777e4fb8d0b66a21">2.2 Monitoring Library Calls</h4>

<p>To monitor these calls, we have a few tools at hand. On *nix operating systems we can use strace (for system calls) and ltrace (for both syscalls and library calls). On Windows we can use <a href="http://www.rohitab.com/apimonitor" target="_blank">API Monitor</a> as I have used in the <a href="http://parsiya.net/blog/2014-10-07-my-adventure-with-fireeye-flare-challenge/#ch7" target="_blank">past</a>. If you have a Mac you can try your luck with <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/dtruss.1m.html" target="_blank">dtruss</a> which uses dtrace. I am not quite sure if it can be used to trace library calls and if it works on iOS.</p>

<h5 id="2-2-1-discovering-shared-libraries:2cbddf826dbc10ef777e4fb8d0b66a21">2.2.1 Discovering Shared Libraries</h5>

<p>Assuming we are approaching this application from a black-box perspective, we need to discover the shared libraries first. This can be done in different ways. We will talk about <code>ldd</code>, <code>nm</code>, <code>strings</code> or just <code>ltrace</code>. Just using ltrace may do the job but if there are a lot of library calls, we need to spot critical/interesting libraries to filter out the noise.</p>

<h6 id="2-2-1-1-ldd:2cbddf826dbc10ef777e4fb8d0b66a21">2.2.1.1 ldd</h6>

<p><code>ldd</code> “prints shared library dependencies” according to the <a href="http://man7.org/linux/man-pages/man1/ldd.1.html" target="_blank">man</a> page. Let’s run it.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running ldd</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">$ldd sampleaes
  linux-gate.so.1 <span style="color: #719e07">=</span>&gt;  <span style="color: #719e07">(</span>0xb77b8000<span style="color: #719e07">)</span>
  libcrypto.so.1.0.0 <span style="color: #719e07">=</span>&gt; /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0 <span style="color: #719e07">(</span>0xb75df000<span style="color: #719e07">)</span>
  libc.so.6 <span style="color: #719e07">=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style="color: #719e07">(</span>0xb747b000<span style="color: #719e07">)</span>
  libdl.so.2 <span style="color: #719e07">=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libdl.so.2 <span style="color: #719e07">(</span>0xb7476000<span style="color: #719e07">)</span>
  libz.so.1 <span style="color: #719e07">=</span>&gt; /lib/i386-linux-gnu/libz.so.1 <span style="color: #719e07">(</span>0xb745d000<span style="color: #719e07">)</span>
  /lib/ld-linux.so.2 <span style="color: #719e07">(</span>0xb77b9000<span style="color: #719e07">)</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>In line 3 we can see <a href="http://wiki.openssl.org/index.php/Libcrypto_API" target="_blank">libcrypto</a> which means the application is using OpenSSL (the other OpenSSL library is <code>libssl</code>).</p>

<h6 id="2-2-1-2-nm:2cbddf826dbc10ef777e4fb8d0b66a21">2.2.1.2 nm</h6>

<p><code>nm</code> “<a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?nm" target="_blank">lists symbols from object files.</a>” It’s a good idea to look at its output and look for familiar symbols. We can clearly see OPENSSL and function names in the truncated output.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running nm</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">$ nm sampleaes
         U BIO_dump_fp@@OPENSSL_1.0.0
         U ERR_free_strings@@OPENSSL_1.0.0
         U ERR_load_crypto_strings@@OPENSSL_1.0.0
         U ERR_print_errors_fp@@OPENSSL_1.0.0
         U EVP_CIPHER_CTX_free@@OPENSSL_1.0.0
         U EVP_CIPHER_CTX_new@@OPENSSL_1.0.0
         U EVP_DecryptFinal_ex@@OPENSSL_1.0.0
         U EVP_DecryptInit_ex@@OPENSSL_1.0.0
         U EVP_DecryptUpdate@@OPENSSL_1.0.0
         U EVP_EncryptFinal_ex@@OPENSSL_1.0.0
         U EVP_EncryptInit_ex@@OPENSSL_1.0.0
         U EVP_EncryptUpdate@@OPENSSL_1.0.0
         U EVP_aes_256_cbc@@OPENSSL_1.0.0
         U EVP_cleanup@@OPENSSL_1.0.0
         U OPENSSL_add_all_algorithms_noconf@@OPENSSL_1.0.0
         U OPENSSL_config@@OPENSSL_1.0.0
0804900c d _DYNAMIC
<span style="color: #2AA198">08049108</span> d _GLOBAL_OFFSET_TABLE_
08048d4c R _IO_stdin_used
         w _ITM_deregisterTMCloneTable
         w _ITM_registerTMCloneTable
         w _Jv_RegisterClasses
...
<span style="color: #586E75"># removed the rest of the output</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h6 id="2-2-1-3-strings:2cbddf826dbc10ef777e4fb8d0b66a21">2.2.1.3 strings</h6>

<p><code>strings</code> is useful because it may leak great information about the binary. It will give us the key and IV directly in our example. We can also see OpenSSL and libcrypto strings. It also gives us the version of the used OpenSSL library.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running strings</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">strings</span> <span style="color: #93A1A1">sampleaes</span>
<span style="color: #719e07">/</span><span style="color: #93A1A1">lib</span><span style="color: #719e07">/</span><span style="color: #93A1A1">ld</span><span style="color: #719e07">-</span><span style="color: #93A1A1">linux.so</span><span style="color: #2AA198">.2</span>
<span style="color: #93A1A1">libcrypto.so</span><span style="color: #2AA198">.1.0.0</span>
<span style="color: #93A1A1">_ITM_deregisterTMCloneTable</span>
<span style="color: #93A1A1">__gmon_start__</span>
<span style="color: #93A1A1">_Jv_RegisterClasses</span>
<span style="color: #93A1A1">_ITM_registerTMCloneTable</span>
<span style="color: #93A1A1">EVP_aes_256_cbc</span>
<span style="color: #93A1A1">ERR_free_strings</span>
<span style="color: #93A1A1">OPENSSL_config</span>
<span style="color: #93A1A1">EVP_cleanup</span>
<span style="color: #93A1A1">ERR_load_crypto_strings</span>
<span style="color: #93A1A1">OPENSSL_add_all_algorithms_noconf</span>
<span style="color: #93A1A1">EVP_CIPHER_CTX_free</span>
<span style="color: #93A1A1">EVP_DecryptFinal_ex</span>
<span style="color: #93A1A1">ERR_print_errors_fp</span>
<span style="color: #93A1A1">EVP_DecryptInit_ex</span>
<span style="color: #93A1A1">EVP_EncryptFinal_ex</span>
<span style="color: #93A1A1">EVP_CIPHER_CTX_new</span>
<span style="color: #93A1A1">EVP_DecryptUpdate</span>
<span style="color: #93A1A1">EVP_EncryptInit_ex</span>
<span style="color: #93A1A1">BIO_dump_fp</span>
<span style="color: #93A1A1">EVP_EncryptUpdate</span>
<span style="color: #93A1A1">libc.so</span><span style="color: #2AA198">.6</span>
<span style="color: #93A1A1">_IO_stdin_used</span>
<span style="color: #93A1A1">puts</span>
<span style="color: #93A1A1">abort</span>
<span style="color: #93A1A1">strlen</span>
<span style="color: #93A1A1">stdout</span>
<span style="color: #93A1A1">stderr</span>
<span style="color: #93A1A1">__libc_start_main</span>
<span style="color: #93A1A1">OPENSSL_1</span><span style="color: #2AA198">.0.0</span>
<span style="color: #93A1A1">GLIBC_2</span><span style="color: #2AA198">.0</span>
<span style="color: #93A1A1">PTRh</span>
<span style="color: #93A1A1">[</span><span style="color: #719e07">^</span><span style="color: #93A1A1">_]</span>
<span style="color: #93A1A1">ee12c03ceacdfb5d4c0e67c8f5ab3362</span>
<span style="color: #93A1A1">d36a4bf2e6dd9c68</span>
<span style="color: #93A1A1">The</span> <span style="color: #93A1A1">quick</span> <span style="color: #93A1A1">brown</span> <span style="color: #93A1A1">fox</span> <span style="color: #93A1A1">jumps</span> <span style="color: #93A1A1">over</span> <span style="color: #93A1A1">the</span> <span style="color: #93A1A1">lazy</span> <span style="color: #93A1A1">dog</span>
<span style="color: #93A1A1">Ciphertext</span> <span style="color: #93A1A1">is:</span>
<span style="color: #93A1A1">Decrypted</span> <span style="color: #93A1A1">text</span> <span style="color: #93A1A1">is:</span>
<span style="color: #93A1A1">;</span><span style="color: #719e07">*</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">$</span><span style="color: #2AA198">&quot;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h4 id="2-3-using-ltrace-to-find-the-key:2cbddf826dbc10ef777e4fb8d0b66a21">2.3  Using ltrace to Find the Key</h4>

<p>Finally let’s run ltrace on the binary. The <code>i</code> switch prints the value of instruction pointer at the time of library call (we will need it later). You can also trace syscalls using the <code>S</code> (capital S) switch.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running ltrace</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$</span> <span style="color: #268BD2">ltrace</span> <span style="color: #719e07">-</span><span style="color: #268BD2">i</span> <span style="color: #268BD2">.</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048921</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">__libc_start_main</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x8048b8c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88534</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048cd0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048cc0</span> 
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048bbe</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">ERR_load_crypto_strings</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0xb776dda6</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7439a30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048629</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb74266d0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x80485d0</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048bc3</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">OPENSSL_add_all_algorithms_noconf</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0xb776dda6</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7439a30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048629</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb74266d0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x80485d0</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048bcf</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">OPENSSL_config</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7439a30</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048629</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb74266d0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x80485d0</span><span style="color: #93A1A1">)</span>    <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048bde</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">strlen</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;The quick brown fox jumps over t&quot;</span><span style="color: #268BD2">...</span><span style="color: #93A1A1">)</span>                      <span style="color: #93A1A1">=</span> <span style="color: #2AA198">43</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048a0f</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_CIPHER_CTX_new</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048434</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8049140</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb742e0b4</span><span style="color: #93A1A1">)</span>         <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0x90bdce0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048a22</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_aes_256_cbc</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048434</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8049140</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb742e0b4</span><span style="color: #93A1A1">)</span>            <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0xb7735040</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048a47</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_EncryptInit_ex</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7735040</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d71</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048a78</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_EncryptUpdate</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88324</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d84</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048aa8</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_EncryptFinal_ex</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8840c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88324</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d84</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048ac3</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_CIPHER_CTX_free</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8840c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88324</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d84</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">43</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048c25</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">puts</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;Ciphertext is:&quot;</span><span style="color: #268BD2">Ciphertext</span> <span style="color: #268BD2">is</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">)</span>                                             <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">15</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048c48</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">BIO_dump_fp</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0xb75874e0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec0000</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">51</span> <span style="color: #2AA198">34</span> <span style="color: #2AA198">3</span><span style="color: #268BD2">f</span> <span style="color: #2AA198">21</span> <span style="color: #2AA198">87</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">d</span> <span style="color: #2AA198">4</span><span style="color: #268BD2">e</span> <span style="color: #268BD2">f6</span><span style="color: #719e07">-</span><span style="color: #2AA198">18</span> <span style="color: #2AA198">1</span><span style="color: #268BD2">d</span> <span style="color: #268BD2">c6</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">d</span> <span style="color: #2AA198">41</span> <span style="color: #268BD2">c1</span> <span style="color: #2AA198">12</span> <span style="color: #268BD2">ae</span>   <span style="color: #268BD2">Q4?</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">.</span><span style="color: #93A1A1">]</span><span style="color: #268BD2">N....mA...</span>
<span style="color: #93A1A1">0010</span> <span style="color: #93A1A1">-</span> <span style="color: #268BD2">e0</span> <span style="color: #268BD2">a7</span> <span style="color: #268BD2">de</span> <span style="color: #268BD2">a0</span> <span style="color: #268BD2">fa</span> <span style="color: #268BD2">b9</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">c</span> <span style="color: #268BD2">b0</span><span style="color: #719e07">-</span><span style="color: #2AA198">91</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">e</span> <span style="color: #2AA198">21</span> <span style="color: #268BD2">c6</span> <span style="color: #268BD2">d3</span> <span style="color: #2AA198">90</span> <span style="color: #2AA198">96</span> <span style="color: #2AA198">36</span>   <span style="color: #268BD2">......l..</span><span style="color: #719e07">^</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">....6</span>
<span style="color: #93A1A1">0020</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">70</span> <span style="color: #93A1A1">7</span><span style="color: #268BD2">b</span> <span style="color: #268BD2">ec</span> <span style="color: #2AA198">69</span> <span style="color: #2AA198">89</span> <span style="color: #268BD2">e1</span> <span style="color: #268BD2">bc</span> <span style="color: #2AA198">0</span><span style="color: #268BD2">a</span><span style="color: #719e07">-</span><span style="color: #2AA198">2</span><span style="color: #268BD2">c</span> <span style="color: #2AA198">61</span> <span style="color: #268BD2">f4</span> <span style="color: #268BD2">c6</span> <span style="color: #2AA198">26</span> <span style="color: #2AA198">61</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">f</span> <span style="color: #2AA198">2</span><span style="color: #268BD2">e</span>   <span style="color: #268BD2">p</span><span style="color: #93A1A1">{</span><span style="color: #268BD2">.i....</span><span style="color: #93A1A1">,</span><span style="color: #268BD2">a..</span><span style="color: #719e07">&amp;</span><span style="color: #268BD2">a_.</span>
<span style="color: #93A1A1">)</span>     <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">3</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048ad3</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_CIPHER_CTX_new</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb77789c0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb764bda0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb764b910</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0x90bdce0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048ae6</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_aes_256_cbc</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb77789c0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb764bda0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb764b910</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0xb7735040</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048b0b</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7735040</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d71</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048b3c</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_DecryptUpdate</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8836c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88324</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048b6c</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_DecryptFinal_ex</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8838c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88324</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048b87</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_CIPHER_CTX_free</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0x90bdce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8838c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff88324</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff883ec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048ca3</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">puts</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;Decrypted text is:&quot;</span><span style="color: #268BD2">Decrypted</span> <span style="color: #268BD2">text</span> <span style="color: #268BD2">is</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">)</span>                                         <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">19</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048caf</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">puts</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;The quick brown fox jumps over t&quot;</span><span style="color: #268BD2">...The</span> <span style="color: #268BD2">quick</span> <span style="color: #268BD2">brown</span> <span style="color: #268BD2">fox</span> <span style="color: #268BD2">jumps</span> <span style="color: #268BD2">over</span> <span style="color: #268BD2">the</span> <span style="color: #268BD2">lazy</span> <span style="color: #268BD2">dog</span>
<span style="color: #93A1A1">)</span>                        <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">44</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048cb4</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">EVP_cleanup</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0xbff8836c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8836c</span><span style="color: #93A1A1">)</span>      <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">x8048cb9</span><span style="color: #93A1A1">]</span> <span style="color: #268BD2">ERR_free_strings</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0xbff8836c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d50</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x8048d71</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbff8836c</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span>
<span style="color: #93A1A1">[0</span><span style="color: #268BD2">xffffffff</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">+++</span> <span style="color: #268BD2">exited</span> <span style="color: #93A1A1">(</span><span style="color: #268BD2">status</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">+++</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>In a non-ideal situation, we have to either recognize the good functions from past experience or search them all. Here we are looking for a function with key and IV as parameters. According to the <a href="https://www.openssl.org/docs/crypto/EVP_EncryptInit.html" target="_blank">documentation</a> <code>EVP_DecryptInit_ex</code> is what we are looking for:</p>

<p><code>int EVP_DecryptInit_ex(EVP_CIPHER_CTX *ctx, const EVP_CIPHER *type, ENGINE *impl, unsigned char *key, unsigned char *iv);</code></p>

<p>But what are these values:<br />
<code>[0x8048b0b] EVP_DecryptInit_ex(0x90bdce0, 0xb7735040, 0, 0x8048d50, 0x8048d71) = 1</code>
These are pointers and are 4 bytes each (remember we are in a 32-bit OS). “*But where are these pointers pointing to? Do I have to use GDB?*” Yes, we had to use GDB before I knew that we can configure ltrace to dereference pointers. But we will use GDB too.</p>

<h5 id="2-3-1-configuring-ltrace:2cbddf826dbc10ef777e4fb8d0b66a21">2.3.1 Configuring ltrace</h5>

<p>If we know the type of pointers, we can dereference them by modifying <a href="http://man7.org/linux/man-pages/man5/ltrace.conf.5.html" target="_blank">~/.ltrace.conf</a>. We can also do more elaborate stuff like defining structs as explained <a href="https://github.com/zenovich/ltrace/blob/master/etc/ltrace.conf" target="_blank">here</a>. In short we can add lines to ltrace.conf for certain functions. In our case we know the 4th and 5th arguments for EVP_DecryptInit_ex are strings (char*). We do not care about the first three arguments so can ignore them by defining them as <code>addr</code> (for address). Let’s add the following line to ltrace.conf:<br />
<code>int EVP_DecryptInit_ex(addr, addr, addr, string, string)</code></p>

<p>run ltrace again and annnnnnnd voila (look at lines 4 for key and IV):



    

<figure class="code">
  <figcaption>
  	<span>running ltrace after configuration</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #719e07"># most of the output has been removed</span>
<span style="color: #93A1A1">EVP_CIPHER_CTX_new(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb77cc9c0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecdec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb769fda0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb769f910</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0x9ff5ce0</span>
<span style="color: #93A1A1">EVP_aes_256_cbc(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb77cc9c0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecdec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb769fda0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb769f910</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0xb7789040</span>
<span style="color: #93A1A1">EVP_DecryptInit_ex(</span><span style="color: #2AA198">0x09ff5ce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7789040</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">NULL</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;ee12c03ceacdfb5d4c0e67c8f5ab3362&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;d36a4bf2e6dd9c68&quot;</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">EVP_DecryptUpdate(</span><span style="color: #2AA198">0x9ff5ce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecd6c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecd24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecdec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">EVP_DecryptFinal_ex(</span><span style="color: #2AA198">0x9ff5ce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecd8c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecd24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecdec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span>
<span style="color: #93A1A1">EVP_CIPHER_CTX_free(</span><span style="color: #2AA198">0x9ff5ce0</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecd8c</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecd24</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xbfdecdec</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">48</span><span style="color: #93A1A1">)</span> <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/tales1/Queen-Amused.jpg" title="Her Majesty is amused – If you are offended please don’t send James Bond after me" alt="Her Majesty is amused – If you are offended please don’t send James Bond after me">
  <span class="caption-text">Her Majesty is amused – If you are offended please don’t send James Bond after me</span>
</span>
</p>

<h4 id="2-4-finding-the-key-using-gdb-ii-electric-boogaloo:2cbddf826dbc10ef777e4fb8d0b66a21">2.4  Finding the Key (Using GDB) II: Electric Boogaloo</h4>

<p>That was too easy but we pleased a powerful friend. Let’s try and find it using GDB (gasp). Good thing that we compiled out binary using the ggdb switch. If not go ahead and do that. We know we are looking for <code>EVP_DecryptInit_ex</code> and we have already seen how to use GDB. We will <code>set verbose on</code> (in case stuff happens).</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running in GDB with debug info 1</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$</span> <span style="color: #268BD2">gdb</span> <span style="color: #268BD2">.</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes</span> <span style="color: #719e07">-</span><span style="color: #268BD2">q</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">root</span><span style="color: #719e07">/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes...done.</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">set</span> <span style="color: #268BD2">verbose</span> <span style="color: #268BD2">on</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">break</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span>  <span style="color: #586E75">; setting up the breakpoint</span>
<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">1</span> <span style="color: #268BD2">at</span> <span style="color: #2AA198">0x8048830</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">run</span>                       <span style="color: #586E75">; running the program</span>
<span style="color: #268BD2">Starting</span> <span style="color: #268BD2">program</span><span style="color: #93A1A1">:</span> <span style="color: #719e07">/</span><span style="color: #268BD2">root</span><span style="color: #719e07">/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes</span> 
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">ld</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux.so.2...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #268BD2">Loaded</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">for</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">ld</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux.so.2</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #268BD2">system</span><span style="color: #719e07">-</span><span style="color: #268BD2">supplied</span> <span style="color: #B58900">DS</span><span style="color: #268BD2">O</span> <span style="color: #268BD2">at</span> <span style="color: #2AA198">0xb7fe1000</span><span style="color: #268BD2">...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">usr</span><span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libcrypto.so.1.0.0...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #268BD2">Loaded</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">for</span> <span style="color: #719e07">/</span><span style="color: #268BD2">usr</span><span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libcrypto.so.1.0.0</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libc.so.6...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #268BD2">Loaded</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">for</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libc.so.6</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libdl.so.2...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #268BD2">Loaded</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">for</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libdl.so.2</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">libz.so.1...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #268BD2">Loaded</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">for</span> <span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">libz.so.1</span>
<span style="color: #268BD2">Ciphertext</span> <span style="color: #268BD2">is</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">0000</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">51</span> <span style="color: #93A1A1">34</span> <span style="color: #93A1A1">3</span><span style="color: #268BD2">f</span> <span style="color: #2AA198">21</span> <span style="color: #2AA198">87</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">d</span> <span style="color: #2AA198">4</span><span style="color: #268BD2">e</span> <span style="color: #268BD2">f6</span><span style="color: #719e07">-</span><span style="color: #2AA198">18</span> <span style="color: #2AA198">1</span><span style="color: #268BD2">d</span> <span style="color: #268BD2">c6</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">d</span> <span style="color: #2AA198">41</span> <span style="color: #268BD2">c1</span> <span style="color: #2AA198">12</span> <span style="color: #268BD2">ae</span>   <span style="color: #268BD2">Q4?</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">.</span><span style="color: #93A1A1">]</span><span style="color: #268BD2">N....mA...</span>
<span style="color: #93A1A1">0010</span> <span style="color: #93A1A1">-</span> <span style="color: #268BD2">e0</span> <span style="color: #268BD2">a7</span> <span style="color: #268BD2">de</span> <span style="color: #268BD2">a0</span> <span style="color: #268BD2">fa</span> <span style="color: #268BD2">b9</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">c</span> <span style="color: #268BD2">b0</span><span style="color: #719e07">-</span><span style="color: #2AA198">91</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">e</span> <span style="color: #2AA198">21</span> <span style="color: #268BD2">c6</span> <span style="color: #268BD2">d3</span> <span style="color: #2AA198">90</span> <span style="color: #2AA198">96</span> <span style="color: #2AA198">36</span>   <span style="color: #268BD2">......l..</span><span style="color: #719e07">^</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">....6</span>
<span style="color: #93A1A1">0020</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">70</span> <span style="color: #93A1A1">7</span><span style="color: #268BD2">b</span> <span style="color: #268BD2">ec</span> <span style="color: #2AA198">69</span> <span style="color: #2AA198">89</span> <span style="color: #268BD2">e1</span> <span style="color: #268BD2">bc</span> <span style="color: #2AA198">0</span><span style="color: #268BD2">a</span><span style="color: #719e07">-</span><span style="color: #2AA198">2</span><span style="color: #268BD2">c</span> <span style="color: #2AA198">61</span> <span style="color: #268BD2">f4</span> <span style="color: #268BD2">c6</span> <span style="color: #2AA198">26</span> <span style="color: #2AA198">61</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">f</span> <span style="color: #2AA198">2</span><span style="color: #268BD2">e</span>   <span style="color: #268BD2">p</span><span style="color: #93A1A1">{</span><span style="color: #268BD2">.i....</span><span style="color: #93A1A1">,</span><span style="color: #268BD2">a..</span><span style="color: #719e07">&amp;</span><span style="color: #268BD2">a_.</span>

<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #268BD2">Reading</span> <span style="color: #268BD2">in</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">for</span> <span style="color: #268BD2">AES</span><span style="color: #719e07">-</span><span style="color: #268BD2">OpenSSL.c...done.</span>
<span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a20</span> <span style="color: #268BD2">in</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span> <span style="color: #93A1A1">()</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">usr</span><span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libcrypto.so.1.0.0</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #B58900">di</span><span style="color: #268BD2">sass</span>    <span style="color: #586E75">; disassembling the function</span>
<span style="color: #268BD2">Dump</span> <span style="color: #268BD2">of</span> <span style="color: #268BD2">assembler</span> <span style="color: #268BD2">code</span> <span style="color: #268BD2">for</span> <span style="color: #268BD2">function</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">=&gt;</span> <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a20</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">0</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span> <span style="color: #268BD2">push</span>   <span style="color: #B58900">ebx</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a21</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">1</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">sub</span>    <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x28</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a24</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">4</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x40</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a28</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">8</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0xb7e510db</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a2d</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">13</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>    <span style="color: #268BD2">add</span>    <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0xe65c7</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a33</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">19</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x14</span><span style="color: #93A1A1">],</span><span style="color: #2AA198">0x0</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a3b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">27</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a3f</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">31</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x3c</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a43</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">35</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a47</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">39</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x38</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a4b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">43</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a4f</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">47</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x34</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a53</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">51</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x4</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a57</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">55</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x30</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a5b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">59</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a5e</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">62</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0xb7e50660</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">EVP_CipherInit_ex@plt</span><span style="color: #719e07">&gt;</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a63</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">67</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">add</span>    <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x28</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a66</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">70</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">pop</span>    <span style="color: #B58900">ebx</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a67</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">71</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">ret</span>
<span style="color: #268BD2">End</span> <span style="color: #268BD2">of</span> <span style="color: #268BD2">assembler</span> <span style="color: #268BD2">dump.</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can see <code>EVP_CipherInit_ex</code> called at <code>0xb7ed3a5e</code>. Let’s put a breakpoint there (right before function call) and look at its arguments.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running in gdb with debug info 2</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">b</span><span style="color: #719e07">*</span><span style="color: #2AA198">0xb7ed3a5e</span>
<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">2</span> <span style="color: #268BD2">at</span> <span style="color: #2AA198">0xb7ed3a5e</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">c</span>
<span style="color: #268BD2">Continuing.</span>

<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0xb7ed3a5e</span> <span style="color: #268BD2">in</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span> <span style="color: #93A1A1">()</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">usr</span><span style="color: #719e07">/</span><span style="color: #268BD2">lib</span><span style="color: #719e07">/</span><span style="color: #268BD2">i386</span><span style="color: #719e07">-</span><span style="color: #268BD2">linux</span><span style="color: #719e07">-</span><span style="color: #268BD2">gnu</span><span style="color: #719e07">/</span><span style="color: #268BD2">i686</span><span style="color: #719e07">/</span><span style="color: #268BD2">cmov</span><span style="color: #719e07">/</span><span style="color: #268BD2">libcrypto.so.1.0.0</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #B58900">di</span><span style="color: #268BD2">sass</span>
<span style="color: #268BD2">Dump</span> <span style="color: #268BD2">of</span> <span style="color: #268BD2">assembler</span> <span style="color: #268BD2">code</span> <span style="color: #268BD2">for</span> <span style="color: #268BD2">function</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span><span style="color: #93A1A1">:</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a20</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">0</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">push</span>   <span style="color: #B58900">ebx</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a21</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">1</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">sub</span>    <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x28</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a24</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">4</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x40</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a28</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">8</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0xb7e510db</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a2d</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">13</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">add</span>    <span style="color: #B58900">ebx</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0xe65c7</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a33</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">19</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x14</span><span style="color: #93A1A1">],</span><span style="color: #2AA198">0x0</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a3b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">27</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a3f</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">31</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x3c</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a43</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">35</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a47</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">39</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x38</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a4b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">43</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a4f</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">47</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x34</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a53</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">51</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x4</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a57</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">55</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x30</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a5b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">59</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
<span style="color: #93A1A1">=&gt;</span> <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a5e</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">62</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0xb7e50660</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">EVP_CipherInit_ex@plt</span><span style="color: #719e07">&gt;</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a63</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">67</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">add</span>    <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x28</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a66</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">70</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">pop</span>    <span style="color: #B58900">ebx</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">xb7ed3a67</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">71</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">ret</span>
<span style="color: #268BD2">End</span> <span style="color: #268BD2">of</span> <span style="color: #268BD2">assembler</span> <span style="color: #268BD2">dump.</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can see the arguments loaded from memory to eax and then pushed to the stack (esp is the stack pointer and points to the top of the stack at all times). We are in a Linux 32-bit OS so arguments (or parameters whatever) are pushed to the stack from <a href="http://duartes.org/gustavo/blog/post/journey-to-the-stack/" target="_blank">right to left</a> (almost the same in 32-bit Windows systems). Here is what it looks like right before the call instruction:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>EVP_DecryptInit_ex arguments</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #DC322F">int</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span><span style="color: #93A1A1">(</span>
<span style="color: #93A1A1">EVP_CIPHER_CTX</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">ctx,</span>    <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp]</span>
<span style="color: #719e07">const</span> <span style="color: #93A1A1">EVP_CIPHER</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">type,</span> <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">ENGINE</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">impl,</span>           <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">]</span>
<span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">key,</span>     <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">]</span>
<span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">iv</span>       <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">);</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can print the values of both key and IV. To do this in GDB we need to use this command <code>x/s *((char **) ( $esp+0x10 ))</code>. The s switch tells GDB to print the result as a string. <code>$esp+0x10</code> is a pointer that points to a location on the stack. In that location we have a <code>char *</code> which is another pointer to a string, so we need to dereference it twice (hence the <code>char **</code>). And finally to print it using the <code>s</code> switch we need to make it a string (e.g. <code>char *</code>) so we will use the first *. And it works.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>finding key and IV in gdb with debug info</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">(gdb)</span> <span style="color: #93A1A1">x</span><span style="color: #719e07">/</span><span style="color: #93A1A1">s</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">((</span><span style="color: #DC322F">char</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">$esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span> <span style="color: #93A1A1">))</span>
<span style="color: #2AA198">0x8048d71</span><span style="color: #719e07">:</span>	 <span style="color: #2AA198">&quot;d36a4bf2e6dd9c68&quot;</span>
<span style="color: #93A1A1">(gdb)</span> <span style="color: #93A1A1">x</span><span style="color: #719e07">/</span><span style="color: #93A1A1">s</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">((</span><span style="color: #DC322F">char</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">$esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span> <span style="color: #93A1A1">))</span>
<span style="color: #2AA198">0x8048d50</span><span style="color: #719e07">:</span>	 <span style="color: #2AA198">&quot;ee12c03ceacdfb5d4c0e67c8f5ab3362&quot;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>







<span class="caption-wrapper">
  <img class="caption" src="/images/2015/tales1/Queen-Not-Amused.jpg" title="Her Majesty is bored because of GDB" alt="Her Majesty is bored because of GDB">
  <span class="caption-text">Her Majesty is bored because of GDB</span>
</span>
</p>

<h4 id="2-5-using-gdb-without-debug-info:2cbddf826dbc10ef777e4fb8d0b66a21">2.5 Using GDB without Debug Info</h4>

<p>Our example is in a controlled environment, so we were able to build the binary with debug info. But in a real world scenario we do not have this luxury. In this section I will discuss how to get to  <code>EVP_DecryptInit_ex</code> without debug info.</p>

<p>First we have to build our binary without  debug info, just remove the <code>-ggdb</code> switch to get <code>gcc -o sampleaes-nodebug AES-OpenSSL.c -lcrypto</code>. Now how do we find the location of <code>EVP_DecryptInit_ex</code> call?</p>

<p>Remember the following line in the original ltrace output.
<code>[0x8048b0b] EVP_DecryptInit_ex(0x90bdce0, 0xb7735040, 0, 0x8048d50, 0x8048d71) = 1</code></p>

<p>We used the <code>i</code> switch to print the value of instruction pointer after the call. This is our entry point. We will debug the binary in GDB and set up a breakpoint at <code>0x8048b0b</code> and see what happens.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>running in gdb without debug info 1</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #268BD2">$</span> <span style="color: #268BD2">gdb</span> <span style="color: #268BD2">.</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes</span><span style="color: #719e07">-</span><span style="color: #268BD2">nodebug</span> <span style="color: #719e07">-</span><span style="color: #268BD2">q</span>
<span style="color: #268BD2">Reading</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">from</span> <span style="color: #719e07">/</span><span style="color: #268BD2">root</span><span style="color: #719e07">/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes</span><span style="color: #719e07">-</span><span style="color: #268BD2">nodebug...</span><span style="color: #93A1A1">(</span><span style="color: #268BD2">no</span> <span style="color: #268BD2">debugging</span> <span style="color: #268BD2">symbols</span> <span style="color: #268BD2">found</span><span style="color: #93A1A1">)</span><span style="color: #268BD2">...done.</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">b</span> <span style="color: #719e07">*</span><span style="color: #2AA198">0x8048b0b</span>
<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">1</span> <span style="color: #268BD2">at</span> <span style="color: #2AA198">0x8048b0b</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #268BD2">run</span>
<span style="color: #268BD2">Starting</span> <span style="color: #268BD2">program</span><span style="color: #93A1A1">:</span> <span style="color: #719e07">/</span><span style="color: #268BD2">root</span><span style="color: #719e07">/</span><span style="color: #268BD2">Desktop</span><span style="color: #719e07">/</span><span style="color: #268BD2">kek</span><span style="color: #719e07">/</span><span style="color: #268BD2">sampleaes</span><span style="color: #719e07">-</span><span style="color: #268BD2">nodebug</span> 
<span style="color: #268BD2">Ciphertext</span> <span style="color: #268BD2">is</span><span style="color: #93A1A1">:</span>
<span style="color: #93A1A1">0000</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">51</span> <span style="color: #93A1A1">34</span> <span style="color: #93A1A1">3</span><span style="color: #268BD2">f</span> <span style="color: #2AA198">21</span> <span style="color: #2AA198">87</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">d</span> <span style="color: #2AA198">4</span><span style="color: #268BD2">e</span> <span style="color: #268BD2">f6</span><span style="color: #719e07">-</span><span style="color: #2AA198">18</span> <span style="color: #2AA198">1</span><span style="color: #268BD2">d</span> <span style="color: #268BD2">c6</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">d</span> <span style="color: #2AA198">41</span> <span style="color: #268BD2">c1</span> <span style="color: #2AA198">12</span> <span style="color: #268BD2">ae</span>   <span style="color: #268BD2">Q4?</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">.</span><span style="color: #93A1A1">]</span><span style="color: #268BD2">N....mA...</span>
<span style="color: #93A1A1">0010</span> <span style="color: #93A1A1">-</span> <span style="color: #268BD2">e0</span> <span style="color: #268BD2">a7</span> <span style="color: #268BD2">de</span> <span style="color: #268BD2">a0</span> <span style="color: #268BD2">fa</span> <span style="color: #268BD2">b9</span> <span style="color: #2AA198">6</span><span style="color: #268BD2">c</span> <span style="color: #268BD2">b0</span><span style="color: #719e07">-</span><span style="color: #2AA198">91</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">e</span> <span style="color: #2AA198">21</span> <span style="color: #268BD2">c6</span> <span style="color: #268BD2">d3</span> <span style="color: #2AA198">90</span> <span style="color: #2AA198">96</span> <span style="color: #2AA198">36</span>   <span style="color: #268BD2">......l..</span><span style="color: #719e07">^</span><span style="color: #93A1A1">!</span><span style="color: #268BD2">....6</span>
<span style="color: #93A1A1">0020</span> <span style="color: #93A1A1">-</span> <span style="color: #93A1A1">70</span> <span style="color: #93A1A1">7</span><span style="color: #268BD2">b</span> <span style="color: #268BD2">ec</span> <span style="color: #2AA198">69</span> <span style="color: #2AA198">89</span> <span style="color: #268BD2">e1</span> <span style="color: #268BD2">bc</span> <span style="color: #2AA198">0</span><span style="color: #268BD2">a</span><span style="color: #719e07">-</span><span style="color: #2AA198">2</span><span style="color: #268BD2">c</span> <span style="color: #2AA198">61</span> <span style="color: #268BD2">f4</span> <span style="color: #268BD2">c6</span> <span style="color: #2AA198">26</span> <span style="color: #2AA198">61</span> <span style="color: #2AA198">5</span><span style="color: #268BD2">f</span> <span style="color: #2AA198">2</span><span style="color: #268BD2">e</span>   <span style="color: #268BD2">p</span><span style="color: #93A1A1">{</span><span style="color: #268BD2">.i....</span><span style="color: #93A1A1">,</span><span style="color: #268BD2">a..</span><span style="color: #719e07">&amp;</span><span style="color: #268BD2">a_.</span>

<span style="color: #268BD2">Breakpoint</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">0x08048b0b</span> <span style="color: #268BD2">in</span> <span style="color: #268BD2">decrypt</span> <span style="color: #93A1A1">()</span>
<span style="color: #93A1A1">(</span><span style="color: #268BD2">gdb</span><span style="color: #93A1A1">)</span> <span style="color: #B58900">di</span><span style="color: #268BD2">sass</span>
<span style="color: #268BD2">Dump</span> <span style="color: #268BD2">of</span> <span style="color: #268BD2">assembler</span> <span style="color: #268BD2">code</span> <span style="color: #268BD2">for</span> <span style="color: #268BD2">function</span> <span style="color: #268BD2">decrypt</span><span style="color: #93A1A1">:</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ac8</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">0</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">push</span>   <span style="color: #B58900">ebp</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ac9</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">1</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">ebp</span><span style="color: #93A1A1">,</span><span style="color: #B58900">esp</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048acb</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">3</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">sub</span>    <span style="color: #B58900">esp</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x38</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ace</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">6</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0x80487e0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">EVP_CIPHER_CTX_new@plt</span><span style="color: #719e07">&gt;</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ad3</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">11</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ad6</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">14</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">],</span><span style="color: #2AA198">0x0</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ada</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">18</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">jne</span>    <span style="color: #2AA198">0x8048ae1</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">decrypt</span><span style="color: #719e07">+</span><span style="color: #2AA198">25</span><span style="color: #719e07">&gt;</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048adc</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">20</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0x80489ec</span> 
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ae1</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">25</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0x80488a0</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">EVP_aes_256_cbc@plt</span><span style="color: #719e07">&gt;</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ae6</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">30</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x14</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048ae9</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">33</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">],</span><span style="color: #B58900">edx</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048aed</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">37</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">edx</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048af0</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">40</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">],</span><span style="color: #B58900">edx</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048af4</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">44</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">],</span><span style="color: #2AA198">0x0</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048afc</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">52</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x4</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b00</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">56</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b03</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">59</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b06</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">62</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0x8048830</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">EVP_DecryptInit_ex@plt</span><span style="color: #719e07">&gt;</span>
<span style="color: #93A1A1">=&gt;</span> <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b0b</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">67</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">cmp</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">0x1</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b0e</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">70</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">je</span>     <span style="color: #2AA198">0x8048b15</span> <span style="color: #719e07">&lt;</span><span style="color: #268BD2">decrypt</span><span style="color: #719e07">+</span><span style="color: #2AA198">77</span><span style="color: #719e07">&gt;</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b10</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">72</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">call</span>   <span style="color: #2AA198">0x80489ec</span> 
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b15</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">77</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b18</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">80</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b1c</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">84</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,</span><span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b1f</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">87</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b23</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">91</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">lea</span>    <span style="color: #B58900">eax</span><span style="color: #93A1A1">,[</span><span style="color: #B58900">ebp</span><span style="color: #719e07">-</span><span style="color: #2AA198">0x14</span><span style="color: #93A1A1">]</span>
   <span style="color: #93A1A1">0</span><span style="color: #268BD2">x08048b26</span> <span style="color: #719e07">&lt;+</span><span style="color: #2AA198">94</span><span style="color: #719e07">&gt;</span><span style="color: #93A1A1">:</span>	<span style="color: #268BD2">mov</span>    <span style="color: #DC322F">DWORD</span> <span style="color: #268BD2">PTR</span> <span style="color: #93A1A1">[</span><span style="color: #B58900">esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">],</span><span style="color: #B58900">eax</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Again we see the arguments pushed to the stack.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>EVP_DecryptInit_ex arguments</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #DC322F">int</span> <span style="color: #268BD2">EVP_DecryptInit_ex</span><span style="color: #93A1A1">(</span>
<span style="color: #93A1A1">EVP_CIPHER_CTX</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">ctx,</span>    <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp]</span>
<span style="color: #719e07">const</span> <span style="color: #93A1A1">EVP_CIPHER</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">type,</span> <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x4</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">ENGINE</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">impl,</span>           <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x8</span><span style="color: #93A1A1">]</span>
<span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">key,</span>     <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span><span style="color: #93A1A1">]</span>
<span style="color: #DC322F">unsigned</span> <span style="color: #DC322F">char</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">iv</span>       <span style="color: #719e07">&lt;==</span> <span style="color: #93A1A1">[esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span><span style="color: #93A1A1">]</span>
<span style="color: #93A1A1">);</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We put a breakpoint at <code>0x08048b06</code> and re-run the binary. Then we can read key and IV like before:</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>finding key and IV in gdb without debug info</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span style="color: #93A1A1">(gdb)</span> <span style="color: #93A1A1">x</span><span style="color: #719e07">/</span><span style="color: #93A1A1">s</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">((</span><span style="color: #DC322F">char</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">$esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0x10</span> <span style="color: #93A1A1">))</span>
<span style="color: #2AA198">0x8048d71</span><span style="color: #719e07">:</span>	 <span style="color: #2AA198">&quot;d36a4bf2e6dd9c68&quot;</span>
<span style="color: #93A1A1">(gdb)</span> <span style="color: #93A1A1">x</span><span style="color: #719e07">/</span><span style="color: #93A1A1">s</span> <span style="color: #719e07">*</span><span style="color: #93A1A1">((</span><span style="color: #DC322F">char</span> <span style="color: #719e07">**</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">(</span> <span style="color: #93A1A1">$esp</span><span style="color: #719e07">+</span><span style="color: #2AA198">0xc</span> <span style="color: #93A1A1">))</span>
<span style="color: #2AA198">0x8048d50</span><span style="color: #719e07">:</span>	 <span style="color: #2AA198">&quot;ee12c03ceacdfb5d4c0e67c8f5ab3362&quot;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>However, notice the difference in the function name. It is not just called <code>(0xb7ed3a21) EVP_DecryptInit_ex</code> but <code>(0x08048b06) EVP_DecryptInit_ex@plt</code>. Addresses are different. Here’s a tip which is not scientific or anything but works for me. If you see an address starting with 0×08 you are in process-land and addresses starting with 0xb are in shared library land. But what is this @plt?
In short, it’s the <code>Procedure Linkage Table</code>. The compiler does not know where <code>EVP_DecryptInit_ex</code> points to at runtime so it just puts the function call there (relocation) because it does not know the address of our shared library at runtime. Linker will get this function call and replace it with the correct address for the function (actually this is a lot more complex but PLT and Global Offset Table or GOT need their own article). You can read about GOT/PLT in The <a href="http://www.linuxjournal.com/article/1060" target="_blank">ELF Object File Format by Dissection on Linux Journal</a> (search for “plt” and read 3 paragraphs including the one with lazy binding).</p>

<h4 id="2-6-ios-and-android:2cbddf826dbc10ef777e4fb8d0b66a21">2.6 iOS and Android</h4>

<p>I am not going to go into detail about how we can monitor crypto function calls in iOS and Android as we already have two excellent tools that accomplish this. <code>[redacted internal tool]</code> is for iOS and <code>[[redacted internal tool]]</code> is for Android. You can make them hook into crypto function calls and find keys. This is left as an exercise to the reader (meaning I am too lazy). There are also two excellent tutorials by two of my co-workers on how to create custom hooks in iOS and Android <a href="https://hexplo.it/substrate-hooking-native-code-iosandroid/" target="_blank">Substrate - hooking C on Android and iOS part1/2</a> and <a href="https://hexplo.it/substrate-android/" target="_blank">Substrate - hooking C on Android and iOS part 2/2</a>.</p>

<h4 id="2-7-defence:2cbddf826dbc10ef777e4fb8d0b66a21">2.7 Defence?</h4>

<p>We saw that function calls (library calls) leak information. One defense against this side-channel is to link the binaries statically. This will replicate the library code inside the binary and will hopefully make the binary independent of any shared libraries (better for installation). On the other hand, it will increase code size (and thus binary size).</p>

<h3 id="3-0-looking-for-key-in-memory:2cbddf826dbc10ef777e4fb8d0b66a21">3.0 Looking for Key in Memory</h3>

<p>But there are ways to defeat that too. This is our small incursion into the lands of Digital Forensics. The keys are going to be on memory. So that’s where we are going to look for them. But how do we find keys in memory. One step is to look for data with high entropy because keys usually look random. But there are many 128-bit (or 256) parts of memory that look random so what do we do?</p>

<p>Remember the <code>Key Schedule</code>? It’s the original key, followed by a number of round keys. If we see a 176 byte structure on memory that looks random, that’s probably a key schedule. After finding memories with these characteristics, we can use the relation between the round keys and the original encryption key to determine if the structure is a key schedule.</p>

<p>There are tools that do this for us and they were mostly created for use in Cold Boot Attacks and digital forensics. Imagine if you have a computer running disk encryption software. These keys may be stored in memory in plaintext. Open it up while running until you have access to the RAM. Get a can of air spray, turn it upside down and spray the RAM with it. It will freeze. Frozen RAM degrade much slower so we will have more time to read it. Read it and then run tools on it to find keys. Because memory may have been degraded, these tools use the relationship between round keys and original key to recover degraded bits. For more information you can read this paper <a href="https://citp.princeton.edu/research/memory/" target="_blank">Lest We Remember: Cold Boot Attacks on Encryption Keys</a>.</p>

<h4 id="3-1-dumping-memory:2cbddf826dbc10ef777e4fb8d0b66a21">3.1 Dumping Memory</h4>

<p>First we need to dump process memory. I know of a couple of different tools. One is <a href="http://lcamtuf.coredump.cx/soft/memfetch.tgz" target="_blank">memfetch</a> by <code>lcamtuf</code> (creator of <a href="http://lcamtuf.coredump.cx/afl/" target="_blank">American fuzzy lop fuzzer</a>). In order to build it in Kali you need some <a href="http://parsiya.net/blog/2014-11-18-building-memfetch-on-kali/" target="_blank">modifications</a>. Another is <a href="https://code.google.com/p/shortstop/" target="_blank">shortstop</a> but has not been update for a long time. By using a <code>Loadable Kernel Module (LKM)</code> named <a href="https://github.com/504ensicsLabs/LiME" target="_blank">LiME</a> we can make a memory snapshot of the entire machine. And last but not least <a href="https://github.com/volatilityfoundation/volatility" target="_blank">Volatility</a> (a memory forensics framework). If you are interested the creators of Volatility recently released a book <a href="http://www.amazon.com/The-Art-Memory-Forensics-Detecting/dp/1118825098" target="_blank">The Art of Memory Forensics</a>. I have not had time to read it but it looks very useful.</p>

<p>Let’s use LiME in our VM.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>building and using LiME</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">/LiME/src$ make
make -C /lib/modules/3.7-trunk-686-pae/build <span style="color: #268BD2">M</span><span style="color: #719e07">=</span>/root/LiME/src modules
make<span style="color: #719e07">[</span>1<span style="color: #719e07">]</span>: Entering directory <span style="color: #586E75">`</span>/usr/src/linux-headers-3.7-trunk-686-pae<span style="color: #2AA198">&#39;</span>
<span style="color: #2AA198">  CC [M]  /root/LiME/src/tcp.o</span>
<span style="color: #2AA198">  CC [M]  /root/LiME/src/disk.o</span>
<span style="color: #2AA198">  CC [M]  /root/LiME/src/main.o</span>
<span style="color: #2AA198">  LD [M]  /root/LiME/src/lime.o</span>
<span style="color: #2AA198">  Building modules, stage 2.</span>
<span style="color: #2AA198">  MODPOST 1 modules</span>
<span style="color: #2AA198">  CC      /root/LiME/src/lime.mod.o</span>
<span style="color: #2AA198">  LD [M]  /root/LiME/src/lime.ko</span>
<span style="color: #2AA198">make[1]: Leaving directory `/usr/src/linux-headers-3.7-trunk-686-pae&#39;</span>
strip --strip-unneeded lime.ko
mv lime.ko lime-3.7-trunk-686-pae.ko
/LiME/src$ insmod lime-3.7-trunk-686-pae.ko <span style="color: #268BD2">path</span><span style="color: #719e07">=</span>memorydump.raw <span style="color: #268BD2">format</span><span style="color: #719e07">=</span>raw
/LiME/src$
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This dumps Virtual Machine’s memory to <code>memorydump.raw</code>. Now we need to find keys.</p>

<h4 id="3-2-finding-keys:2cbddf826dbc10ef777e4fb8d0b66a21">3.2 Finding Keys</h4>

<p>There are different tools that we can use here again. One is from the “Lest We Remember” paper called <code>aeskeyfind</code>. Another is <a href="http://www.forensicswiki.org/wiki/Bulk_extractor" target="_blank">Bulk extractor</a> which finds other memory artifacts such as URLs, emails and Credit Card numbers. We will use <code>aeskeyfind</code>. The <code>v</code> switch is for verbose mode that prints the key schedule among other information. This is really not recommended in memory forensics because we are running the dump program inside the VM memory and it will alter memory but it is enough for our purposes. Another thing to note is that I was not running our example program while making the memory snapshot but I found encryption keys.</p>

<p>


    

<figure class="code">
  <figcaption>
  	<span>keys inside VM memory dump</span>
  </figcaption>
  <div class="codewrapper"> 
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%">./aeskeyfind -v memorydump.raw 
FOUND POSSIBLE 128-BIT KEY AT BYTE 376ecc30 

KEY: 10b57f8070a27e482fd3713da5303108

EXTENDED KEY: 
10b57f8070a27e482fd3713da5303108
15724f8665d031ce4a0340f3ef3371fb
d4d14059b1017197fb0231641431409f
17d89ba3a6d9ea345ddbdb5049ea9bcf
98cc11983e15fbac63ce20fc2a24bb33
be26d27d803329d1e3fd092dc9d9b21e
ab11a0a02b228971c8df805c01063242
84328cdcaf1005ad67cf85f166c9b7b3
d99be1ef768be442114461b3778dd600
9f6d821ae9e66658f8a207eb8f2fd1eb
bc536b6955b50d31ad170ada2238db31

CONSTRAINTS ON ROWS:
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
00000000000000000000000000000000
Keyfind progress: 100%
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The 0 constraints mean that no keys were degraded (because we took an on a VM). <strong>I do not know what the encryption key is, it&rsquo;s just in memory of VM</strong>. If you find out please let me know. In order to find the key for our OpenSSL program this way, we need to stop execution when the key schedule is on memory. This is left as an exercise to the reader (lol).</p>

<p>This concludes our part one. I initially wanted to write everything in one blog post but it this was already too long. Hopefully I can find a 3rd party app to demonstrate my technique in part 2. As usual if you have any feedback/questions, you know where to find me (side bar &mdash;&gt;).</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Jan 6, 2015</time>
    <span class="categories">
      Tags: 
        
        
          <a class="category" href="http://parsiya.net/tags/aes-keys">AES Keys</a>  <a class="category" href="http://parsiya.net/tags/cryptography">Cryptography</a>  <a class="category" href="http://parsiya.net/tags/reverse-engineering">Reverse Engineering</a>  
        
    </span>
  </p>
    
  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://parsiya.net/blog/2014-12-08-pin-adventures---chapter-1---pinsolver-mk1/" title="Pin Adventures - Chapter 1 - PinSolver Mk1">Pin Adventures - Chapter 1 - PinSolver Mk1</a>
    

     
      <a class="basic-alignment right" href="http://parsiya.net/blog/2015-07-26-image-popup-and-octopress/" title="Image Popup and Octopress">Image Popup and Octopress</a>
    
  </p>

  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'parsiya';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

 
      </article>
    </div>
    


<aside class="sidebar thirds">
  <section class="first odd">
    <h1>Who am I?</h1>
    <p>I am Parsia Hakimian. Current (mostly) security consultant at <a target="_blank" href="http://cigital.com" title="cigital">Cigital</a>.</p>
    <p>I am interested in infosec, reverse engineering, Python, C and EvE Online (not necessarily in that order). My email is parsiya[att]google's email.</p>

    
  </section>

  



  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
    <a target="_blank" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
    <a target="_blank" href="https://bitbucket.org/parsiya/" title="https://bitbucket.org/parsiya/"><i class="fa fa-bitbucket fa-3x"></i></a>
    
    
    
    
    <a target="_blank" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
    
    <a target="_blank" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-key fa-3x"></i></a> 

    
    
    </li>
  </ul>

  
  <section class="even">
    <h1>Recent Posts</h1>

    
    <ul id="recent_posts">
      
      
        
      
      
      <li class="post">
        <a href="/blog/2016-02-14-archive-page-in-hugo/">Archive Page in Hugo</a>
      </li>
      
      <li class="post">
        <a href="/blog/2016-02-02-from-octopress-to-hugo/">From Octopress to Hugo</a>
      </li>
      
      <li class="post">
        <a href="/blog/2016-01-31-why-hugo/">Why Hugo?</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-11-14-intro-to-.net-remoting-for-hackers/">Intro to .NET Remoting for Hackers</a>
      </li>
      
      <li class="post">
        <a href="/blog/2015-10-19-proxying-hipchat-part-3-ssl-added-and-removed-here/">Proxying Hipchat Part 3: SSL Added and Removed Here :^)</a>
      </li>
      
    </ul>
  </section>

</aside>

  </div>
</div>




<footer role="contentinfo">
  <p>Copyright &copy; 2016 Parsia - <a href="http://parsiya.net/license/">License</a> - 
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


<script>
  var _gaq=[['_setAccount','UA-55491306-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

